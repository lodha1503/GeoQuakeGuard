"use strict";(self.webpackChunkamit_kumar_rathi=self.webpackChunkamit_kumar_rathi||[]).push([[3064],{70116:function(e,t,r){var n;r.d(t,{Y:function(){return n}}),function(e){e[e.KILOBYTES=1024]="KILOBYTES",e[e.MEGABYTES=1048576]="MEGABYTES",e[e.GIGABYTES=1073741824]="GIGABYTES"}(n||(n={}))},43064:function(e,t,r){r.r(t),r.d(t,{default:function(){return Zt}});var n=r(93433),i=r(1413),a=r(74165),s=r(15861),o=r(15671),l=r(43144),u=r(97326),c=r(88301),f=r(61120),h=r(60136),d=r(29388),p=r(27366),m=r(44055),v=r(11582),y=r(10064),x=r(32718),g=r(97642),b=r(66978),k=r(94172),w=r(49861),I=r(25243),Z=r(63780),_=r(93169),S=r(27135),R=r(69912),T=r(30651),C=r(11936),M=r(6693),F=r(46671),P=r(29439),O=(r(59486),r(45918)),D=r(76200),B=r(38511),z=r(92975),A=r(25899),E=r(45948),J=r(86591),N=r(22678),H=r(41625),L=r(79586),W=r(22824),q=r(46784),G=r(67426),j=r(59068),U=r(32014),V=r(21969),Y=r(55635),X=r(92089),K=r(45502),Q=r(17314),$=r(80394),ee=r(64145),te=r(53866),re=r(585),ne=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).datasetName=null,e.datasetFormat=null,e.hasUniqueSourceStorageInfo=!0,e.rasterInfo=null,e.ioConfig={sampling:"closest"},e}return(0,l.Z)(r,[{key:"init",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(){var t;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=(0,$.zD)(),this.addResolvingPromise(t),e.next=4,this.when();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"normalizeCtorArgs",value:function(e){var t;return null!==(t=e)&&void 0!==t&&t.ioConfig&&(e=(0,i.Z)((0,i.Z)({},e),{},{ioConfig:(0,i.Z)({resolution:null,bandIds:null,sampling:"closest",tileInfo:W.Z.create()},e.ioConfig)})),e}},{key:"_isGlobalWrappableSource",get:function(){var e=this.rasterInfo,t=(0,$.ut)(e.spatialReference);return null!=t&&e.extent.width>=t/2}},{key:"_hasNoneOrGCSShiftTransform",get:function(){var e=this.rasterInfo.transform;return null==e||"gcs-shift"===e.type}},{key:"rasterJobHandler",set:function(e){var t;this._set("rasterJobHandler",e),"Function"===this.datasetFormat&&(null===(t=this.primaryRasters)||void 0===t||null===(t=t.rasters)||void 0===t||t.forEach((function(t){return t.rasterJobHandler=e})))}},{key:"url",set:function(e){this._set("url",(0,A.Nm)(e,x.Z.getLogger(this)))}},{key:"open",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new y.Z("BaseRaster:open-not-implemented","open() is not implemented");case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s,o,l=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=(i=l.length>3&&void 0!==l[3]?l[3]:{}).tileInfo||this.rasterInfo.storageInfo.tileInfo,o=this.getTileExtentFromTileInfo(t,r,n,s),e.abrupt("return",this.fetchPixels(o,s.size[0],s.size[1],i));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"identify",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,s,o,l,u,c,f,h,d,p,m,v,y,x,g,b,k,w,Z,_,S,R,T,C,M,F,P,O,D,B,z,A,E,J,N,H,L,W,q,G,j,U,X,K,Q=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=Q.length>1&&void 0!==Q[1]?Q[1]:{},t=(0,I.TJ)(re.Z,t).clone().normalize(),l=(o=s).multidimensionalDefinition,u=o.timeExtent,c=this.rasterInfo,f=c.hasMultidimensionalTranspose,h=c.multidimensionalInfo,d=s.transposedVariableName,(p=null!=h&&f&&(null!=u||(0,V.WU)(l)))&&!d&&(d=null!=l&&l.length>0?null!==(m=l[0].variableName)&&void 0!==m?m:void 0:h.variables[0].name,s=(0,i.Z)((0,i.Z)({},s),{},{transposedVariableName:d})),s=this._getRequestOptionsWithSliceId(s),v=c.spatialReference,y=c.extent,x=s.datumTransformation,g=(0,$.nF)(t,v,x),y.intersects(g)){e.next=11;break}return e.abrupt("return",{location:g,value:null});case 11:if(null==c.transform){e.next=16;break}if(b=c.transform.inverseTransform(g),c.nativeExtent.intersects(b)){e.next=15;break}return e.abrupt("return",{location:b,value:null});case 15:g=b;case 16:if(k=0,w=null!=d&&null!=h&&c.hasMultidimensionalTranspose,"Function"!==this.datasetFormat){e.next=40;break}if(Z=this.primaryRasters.rasters[0],!w){e.next=22;break}return e.abrupt("return",Z.identify(g,s));case 22:return _=c.pixelSize,S=3,R=_.x*S/2,T=_.y*S/2,C=new te.Z({xmin:g.x-R,xmax:g.x+R,ymin:g.y-T,ymax:g.y+T,spatialReference:v}),M={interpolation:"nearest"},e.next=30,Z.fetchPixels(C,S,S,M);case 30:return F=e.sent,P=F.pixelBlock,e.next=34,this.fetchPixels(C,S,S,M);case 34:if(O=e.sent,D=O.pixelBlock,null!=P){e.next=38;break}return e.abrupt("return",{location:g,value:null});case 38:return B=Math.floor(S*S*.5),z=!P.mask||P.mask[B]?P.pixels.map((function(e){return e[B]})):null,e.abrupt("return",(null!=D&&(A=!D.mask||D.mask[B]?D.pixels.map((function(e){return e[B]})):void 0),{location:g,value:z,processedValue:A,pyramidLevel:0}));case 40:if(w){e.next=50;break}if(!s.srcResolution){e.next=45;break}k=(0,$.kr)(s.srcResolution,c,this.ioConfig.sampling).pyramidLevel,e.next=50;break;case 45:return e.next=47,this.computeBestPyramidLevelForLocation(t,s);case 47:if(null!=(k=e.sent)){e.next=50;break}return e.abrupt("return",{location:g,value:null});case 50:if(null!==(E=this.identifyPixelLocation(g,k,null,w))){e.next=53;break}return e.abrupt("return",{location:g,value:null});case 53:return J=E.row,N=E.col,H=E.rowOffset,L=E.colOffset,W=E.blockWidth,q=null!==(r=d)&&void 0!==r?r:s.sliceId,G=(0,Y.Rq)(this.url,q),j="".concat(k,"/").concat(J,"/").concat(N),null==(U=(0,Y.Qg)(G,null,j))&&(U=this.fetchRawTile(k,J,N,s),(0,Y.gX)(G,null,j,U)),e.next=58,U;case 58:if(null!==(X=e.sent)&&void 0!==X&&null!==(n=X.pixels)&&void 0!==n&&n.length){e.next=61;break}return e.abrupt("return",{location:g,value:null});case 61:return K=H*W+L,e.abrupt("return",this._processIdentifyResult(X,{srcLocation:g,position:K,pyramidLevel:k,useTransposedTile:!!w,requestSomeSlices:p,identifyOptions:s}));case 63:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s,o,l,u,c,f,h,d,p,m,v,y,x,g,b,k,w,I,Z=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=Z.length>3&&void 0!==Z[3]?Z[3]:{},t=(0,$.Fi)(t),i=this._getRequestOptionsWithSliceId(i),s=this._hasNoneOrGCSShiftTransform,!i.requestRawData||!s){e.next=5;break}return e.abrupt("return",this._fetchPixels(t,r,n,i));case 5:if(o=(0,$.ut)(t.spatialReference),l=(0,$.Hq)(t),!(null==o||0===l||1===l&&this._isGlobalWrappableSource&&s)){e.next=8;break}return e.abrupt("return",this._fetchPixels(t,r,n,i));case 8:if(!(l>=3)){e.next=10;break}return e.abrupt("return",{extent:t,pixelBlock:null});case 10:for(u=[],f=(c=t).xmin,h=c.xmax,d=Math.round(o/(h-f)*r),p=d-Math.round((o/2-f)/(h-f)*r),m=0,v=[],y=0;y<=l;y++)x=new te.Z({xmin:0===y?f:-o/2,xmax:y===l?h-o*y:o/2,ymin:t.ymin,ymax:t.ymax,spatialReference:t.spatialReference}),m+=g=0===y?d-p:y===l?r-m:d,v.push(g),b=i.disableWrapAround&&y>0?null:this._fetchPixels(x,g,n,i),u.push(b);return e.next=16,Promise.all(u);case 16:if(k=e.sent.map((function(e){return null===e||void 0===e?void 0:e.pixelBlock})),w=null,I={width:r,height:n},!this.rasterJobHandler){e.next=25;break}return e.next=22,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:k,srcMosaicSize:I,destDimension:null,coefs:null,sampleSpacing:null,interpolation:"nearest",alignmentInfo:null,blockWidths:v},i);case 22:w=e.sent.pixelBlock,e.next=26;break;case 25:w=(0,Q.us)(k,I,{blockWidths:v});case 26:return e.abrupt("return",{extent:t,srcExtent:(0,$.tB)(t,this.rasterInfo.spatialReference,i.datumTransformation),pixelBlock:w});case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchRawPixels",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s,o,l,u,c,f,h,d,p,m,v,y,x,g,b,k=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=k.length>3&&void 0!==k[3]?k[3]:{},r={x:Math.floor(r.x),y:Math.floor(r.y)},e.next=4,this._fetchRawTiles(t,r,n,i);case 4:if(s=e.sent,o=this.rasterInfo,l=o.nativeExtent,u=o.nativePixelSize,c=o.storageInfo,f=Math.pow(2,t),h=u.x*f,d=u.y*f,p=new te.Z({xmin:l.xmin+h*r.x,xmax:l.xmin+h*(r.x+n.width-1),ymin:l.ymax-d*(r.y+n.height-1),ymax:l.ymax-d*r.y,spatialReference:l.spatialReference}),s){e.next=15;break}return e.abrupt("return",{extent:p,srcExtent:p,pixelBlock:null});case 15:if(m=s.pixelBlocks,v=s.mosaicSize,1!==m.length||null==m[0]||m[0].width!==n.width||m[0].height!==n.height){e.next=18;break}return e.abrupt("return",{extent:p,srcExtent:p,pixelBlock:s.pixelBlocks[0]});case 18:if(y=t>0?c.pyramidBlockWidth:c.blockWidth,x=t>0?c.pyramidBlockHeight:c.blockHeight,g={x:r.x%y,y:r.y%x},!this.rasterJobHandler){e.next=25;break}return e.next=22,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:m,srcMosaicSize:v,destDimension:n,clipOffset:g,clipSize:n,coefs:null,sampleSpacing:null,interpolation:i.interpolation,alignmentInfo:null,blockWidths:null},i);case 22:b=e.sent.pixelBlock,e.next=26;break;case 25:b=(0,Q.us)(m,v,{clipOffset:g,clipSize:n});case 26:return e.abrupt("return",{extent:p,srcExtent:p,pixelBlock:b});case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r,n){throw new y.Z("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}},{key:"computeExtent",value:function(e){return(0,$.tB)(this.rasterInfo.extent,e)}},{key:"decodePixelBlock",value:function(e,t){return!this.rasterJobHandler||t.useCanvas?(0,K.J)(e,t):this.rasterJobHandler.decode({data:e,options:t})}},{key:"request",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,s,o,l,u,c,f,h,d=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=d.length>2&&void 0!==d[2]?d[2]:0,l=this.ioConfig.customFetchParameters,u=r.range,c=r.query,f=r.headers,o=null!==(n=null!==(s=o)&&void 0!==s?s:r.retryCount)&&void 0!==n?n:this.ioConfig.retryCount,h=u?{Range:"bytes=".concat(u.from,"-").concat(u.to)}:null,e.prev=4,e.next=7,(0,D.Z)(t,(0,i.Z)((0,i.Z)({},r),{},{query:(0,i.Z)((0,i.Z)({},c),l),headers:(0,i.Z)((0,i.Z)({},f),h)}));case 7:return e.abrupt("return",e.sent);case 10:if(e.prev=10,e.t0=e.catch(4),!(o>0)){e.next=14;break}return e.abrupt("return",(o--,this.request(t,r,o)));case 14:throw e.t0;case 15:case"end":return e.stop()}}),e,this,[[4,10]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getSliceIndex",value:function(e){var t=this.rasterInfo.multidimensionalInfo;return null==t||null==e||0===e.length?null:(0,V.gk)(e,t)}},{key:"getTileExtentFromTileInfo",value:function(e,t,r,n){var i=n.lodAt(e);return this.getTileExtent({x:i.resolution,y:i.resolution},t,r,n.origin,n.spatialReference,n.size)}},{key:"updateTileInfo",value:function(){var e=this.rasterInfo,t=e.storageInfo,r=e.spatialReference,n=e.extent,i=e.pixelSize;if(!t.tileInfo){for(var a=[],s=t.maximumPyramidLevel||0,o=Math.max(i.x,i.y),l=1/.0254*96*o,u=0;u<=s;u++)a.unshift(new j.Z({level:s-u,resolution:o,scale:l})),o*=2,l*=2;var c=new re.Z({x:n.xmin,y:n.ymax,spatialReference:r});t.tileInfo=new W.Z({origin:c,size:[t.blockWidth,t.blockHeight],spatialReference:r,lods:a}),t.isVirtualTileInfo=!0}}},{key:"createRemoteDatasetStorageInfo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:512,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:512,n=arguments.length>3?arguments[3]:void 0,i=e.width,a=e.height,s=e.nativeExtent,o=e.pixelSize,l=e.spatialReference,u=new re.Z({x:s.xmin,y:s.ymax,spatialReference:l});null==n&&(n=Math.max(0,Math.round(Math.log(Math.max(i,a))/Math.LN2-8)));var c=this.computeBlockBoundary(s,512,512,{x:s.xmin,y:s.ymax},[o],n);e.storageInfo=new U.Z({blockWidth:t,blockHeight:r,pyramidBlockWidth:t,pyramidBlockHeight:r,origin:u,firstPyramidLevel:1,maximumPyramidLevel:n,blockBoundary:c})}},{key:"computeBestPyramidLevelForLocation",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.length>1&&void 0!==r[1]?r[1]:{},e.abrupt("return",0);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"computeBlockBoundary",value:function(e,t,r,i,a){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:2;if(1===a.length&&s>0)for(var l=(a=(0,n.Z)(a))[0],u=l.x,c=l.y,f=0;f<s;f++)u*=o,c*=o,a.push({x:u,y:c});for(var h=[],d=i.x,p=i.y,m=0;m<a.length;m++){var v=a[m],y=v.x,x=v.y;h.push({minCol:Math.floor((e.xmin-d+.1*y)/t/y),maxCol:Math.floor((e.xmax-d-.1*y)/t/y),minRow:Math.floor((p-e.ymax+.1*x)/r/x),maxRow:Math.floor((p-e.ymin-.1*x)/r/x)})}return h}},{key:"getPyramidPixelSize",value:function(e){var t=this.rasterInfo.nativePixelSize,r=this.rasterInfo.storageInfo,n=r.pyramidResolutions,i=r.pyramidScalingFactor;if(0===e)return t;if(null!=n&&n.length)return n[e-1];var a=Math.pow(i,e);return{x:t.x*a,y:t.y*a}}},{key:"identifyPixelLocation",value:function(e,t,r,n){var i=this.rasterInfo,a=i.spatialReference,s=i.nativeExtent,o=i.storageInfo,l=o.maximumPyramidLevel,u=o.origin,c=o.transposeInfo,f=n&&null!=c?c.tileSize[0]:o.blockWidth,h=n&&null!=c?c.tileSize[1]:o.blockHeight,d=(0,$.nF)(e,a,r);if(!s.intersects(d))return null;if(t<0||t>l)return null;var p=this.getPyramidPixelSize(t),m=p.x,v=p.y,y=(u.y-d.y)/v/h,x=(d.x-u.x)/m/f,g=Math.min(h-1,Math.floor((y-Math.floor(y))*h)),b=Math.min(f-1,Math.floor((x-Math.floor(x))*f));return{pyramidLevel:t,row:Math.floor(y),col:Math.floor(x),rowOffset:g,colOffset:b,blockWidth:f,srcLocation:d}}},{key:"getTileExtent",value:function(e,t,r,n,i,a){var s=(0,P.Z)(a,2),o=s[0],l=s[1],u=n.x+r*o*e.x,c=u+o*e.x,f=n.y-t*l*e.y,h=f-l*e.y;return new te.Z({xmin:u,xmax:c,ymin:h,ymax:f,spatialReference:i})}},{key:"getBlockWidthHeight",value:function(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}}},{key:"isBlockOutside",value:function(e,t,r){var n=this.rasterInfo.storageInfo.blockBoundary[e];return!n||n.maxRow<t||n.maxCol<r||n.minRow>t||n.minCol>r}},{key:"_fetchPixels",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s,o,l,u,c,f,h,d,p,m,v,y,x,g,b,k,w,I,Z,_,S,R,T,C,M,F,P,O,D,B,z,A,E,J,N,H,L,W,q,G,j,U,V,Y=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=Y.length>3&&void 0!==Y[3]?Y[3]:{},!((s=(0,$.Hq)(t))>=2)){e.next=4;break}return e.abrupt("return",{extent:t,pixelBlock:null});case 4:if(o=this._getSourceDataInfo(t,r,n,i),l=o.pyramidLevel,u=o.srcResolution,c=o.srcExtent,f=o.srcWidth,h=o.srcHeight,d=o.ul,0!==f&&0!==h){e.next=7;break}return e.abrupt("return",{extent:t,srcExtent:c,pixelBlock:null});case 7:return p=this.rasterInfo,m=p.transform,v="gcs-shift"===(null===m||void 0===m?void 0:m.type),y=null!=(0,$.ut)(t.spatialReference),!v&&y||(s=(0,$.Hq)(o.srcExtent,v)),e.next=11,this._fetchRawTiles(l,d,{width:f,height:h,wrapCount:s},i);case 11:if(x=e.sent){e.next=14;break}return e.abrupt("return",{extent:t,srcExtent:c,pixelBlock:null});case 14:if(g=p.storageInfo,b=l>0?g.pyramidBlockWidth:g.blockWidth,k=l>0?g.pyramidBlockHeight:g.blockHeight,w=p.pixelSize,I=w.x,Z=w.y,l>0&&(_=g.pyramidResolutions,S=g.pyramidScalingFactor,null!=_&&_[l-1]?(R=_[l-1],I=R.x,Z=R.y):(T=Math.pow(S,l),I*=T,Z*=T)),C=p.spatialReference,M=new re.Z({x:I,y:Z,spatialReference:C}),F=b===f&&k===h&&d.x%b==0&&d.y%k==0,P=new re.Z({x:(t.xmax-t.xmin)/r,y:(t.ymax-t.ymin)/n,spatialReference:t.spatialReference}),O=!t.spatialReference.equals(C),D=C.isGeographic?1e-9:1e-4,B=i.datumTransformation,O||!F||1!==x.pixelBlocks.length||b!==r||k!==n||!this._isSameResolution(u,P,D)){e.next=20;break}return e.abrupt("return",{extent:t,srcExtent:c,srcTilePixelSize:M,pixelBlock:x.pixelBlocks[0]});case 20:if(z=y&&null!=(0,$.ut)(c.spatialReference)&&this._hasNoneOrGCSShiftTransform,A=i.requestProjectedLocalDirections&&this.rasterInfo.dataType.startsWith("vector"),e.t0=A&&!this.rasterJobHandler,!e.t0){e.next=25;break}return e.next=25,(0,$.zD)();case 25:if(!this.rasterJobHandler){e.next=31;break}return e.next=28,this.rasterJobHandler.getProjectionOffsetGrid({projectedExtent:t,srcBufferExtent:x.extent,pixelSize:P.toJSON(),datumTransformation:B,rasterTransform:m,hasWrapAround:s>0||z,isAdaptive:!1!==this.ioConfig.optimizeProjectionAccuracy,includeGCSGrid:A},i);case 28:e.t1=e.sent,e.next=32;break;case 31:e.t1=(0,$.Qp)({projectedExtent:t,srcBufferExtent:x.extent,pixelSize:P,datumTransformation:B,rasterTransform:m,hasWrapAround:s>0||z,isAdaptive:!1,includeGCSGrid:A});case 32:if(E=e.t1,N=!i.requestRawData,H={rows:E.spacing[0],cols:E.spacing[1]},L=this._hasNoneOrGCSShiftTransform?this._getRasterTileAlignmentInfo(l,x.extent.xmin):void 0,W=x.pixelBlocks,q=x.mosaicSize,G=x.isPartiallyFilled,j=null,!this.rasterJobHandler){e.next=43;break}return e.next=38,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:W,srcMosaicSize:q,destDimension:N?{width:r,height:n}:null,coefs:N?E.coefficients:null,sampleSpacing:N?H:null,projectDirections:A,gcsGrid:A?E.gcsGrid:null,isUV:"vector-uv"===this.rasterInfo.dataType,interpolation:i.interpolation,alignmentInfo:L,blockWidths:null},i);case 38:U=e.sent,J=U.pixelBlock,j=U.localNorthDirections,e.next=45;break;case 43:V=(0,Q.us)(W,q,{alignmentInfo:L}),J=N?(0,Q.Uk)(V,{width:r,height:n},E.coefficients,H,i.interpolation):V,A&&E.gcsGrid&&(j=(0,Q.Qh)({width:r,height:n},E.gcsGrid),J=(0,ee.xQ)(J,this.rasterInfo.dataType,j));case 45:return e.abrupt("return",i.requestRawData||A?{extent:t,srcExtent:c,srcTilePixelSize:M,pixelBlock:J,transformGrid:E,localNorthDirections:j,isPartiallyFilled:G}:{extent:t,srcExtent:c,srcTilePixelSize:M,pixelBlock:J});case 46:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_fetchRawTiles",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n,i){var s,o,l,u,c,f,h,d,p,m,v,y,x,g,b,k,w,I,Z,_,S,R,T,C,M,F,P,O,D,B,z,A,E,J,N,H,L=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=this.rasterInfo.storageInfo,o=s.origin,l=s.blockBoundary,u=this.getBlockWidthHeight(t),c=u.blockWidth,f=u.blockHeight,h=r.x,d=r.y,p=n.width,m=n.height,v=n.wrapCount,y=this._getRasterTileAlignmentInfo(t,0),i.buffer&&(h-=i.buffer.cols,d-=i.buffer.rows,p+=2*i.buffer.cols,m+=2*i.buffer.rows),x=0,g=0,b=0,v&&null!=y&&(g=y.worldColumnCountFromOrigin,b=y.originColumnOffset,x=y.rightPadding,g*y.blockWidth-x>=h+p&&(x=0)),k=Math.floor(h/c),w=Math.floor(d/f),I=Math.floor((h+p+x-1)/c),Z=Math.floor((d+m+x-1)/f),_=l[t]){e.next=9;break}return e.abrupt("return",null);case 9:if(S=_.minRow,R=_.minCol,T=_.maxCol,C=_.maxRow,0!==v||!(Z<S||I<R||w>C||k>T)){e.next=12;break}return e.abrupt("return",null);case 12:M=new Array,F=!1,P=null==this.ioConfig.allowPartialFill?i.allowPartialFill:this.ioConfig.allowPartialFill,O=w;case 16:if(!(O<=Z)){e.next=27;break}D=(0,a.Z)().mark((function e(){var r,n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=B,!i.disableWrapAround&&v&&null!=y&&g<=B&&(r=B-g-b),O>=S&&r>=R&&C>=O&&T>=r?(n=L._fetchRawTile(t,O,r,i),P?M.push(new Promise((function(e){n.then((function(t){return e(t)})).catch((function(){F=!0,e(null)}))}))):M.push(n)):M.push(Promise.resolve(null));case 2:case"end":return e.stop()}}),e)})),B=k;case 19:if(!(B<=I)){e.next=24;break}return e.delegateYield(D(),"t0",21);case 21:B++,e.next=19;break;case 24:O++,e.next=16;break;case 27:if(0!==M.length){e.next=29;break}return e.abrupt("return",null);case 29:return e.next=31,Promise.all(M);case 31:return z=e.sent,A={height:(Z-w+1)*f,width:(I-k+1)*c},E=this.rasterInfo.spatialReference,J=this.getPyramidPixelSize(t),N=J.x,H=J.y,e.abrupt("return",{extent:new te.Z({xmin:o.x+k*c*N,xmax:o.x+(I+1)*c*N,ymin:o.y-(Z+1)*f*H,ymax:o.y-w*f*H,spatialReference:E}),pixelBlocks:z,mosaicSize:A,isPartiallyFilled:F});case 38:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_isSameResolution",value:function(e,t,r){return Math.abs(e.x-t.x)<r&&Math.abs(e.y-t.y)<r}},{key:"_fetchRawTile",value:function(e,t,r,n){var a=this.rasterInfo.storageInfo.blockBoundary[e];if(!a)return Promise.resolve(null);var s=a.minRow,o=a.minCol,l=a.maxCol,u=a.maxRow;if(t<s||r<o||t>u||r>l)return Promise.resolve(null);var c=(0,Y.Rq)(this.url,n.sliceId),f="".concat(e,"/").concat(t,"/").concat(r),h=(0,Y.Qg)(c,n.registryId,f);if(null==h){var d=new AbortController;h=this.fetchRawTile(e,t,r,(0,i.Z)((0,i.Z)({},n),{},{signal:d.signal})),(0,Y.gX)(c,n.registryId,f,h,d),h.catch((function(){return(0,Y.Gc)(c,n.registryId,f)}))}return n.signal&&(0,b.fu)(n,(function(){(0,Y.OE)(c,n.registryId,f)})),h}},{key:"_computeMagDirValues",value:function(e){var t,r=this.rasterInfo,n=r.bandCount,i=r.dataType;if((2!==n||"vector-magdir"!==i)&&"vector-uv"!==i||2!==(null===e||void 0===e?void 0:e.length)||null===(t=e[0])||void 0===t||!t.length)return null;var a=e[0].length;if("vector-magdir"===i){var s=e[1].map((function(e){return(e+360)%360}));return[e[0],s]}for(var o=(0,P.Z)(e,2),l=o[0],u=o[1],c=[],f=[],h=0;h<a;h++){var d=(0,ee.Tg)([l[h],u[h]]),p=(0,P.Z)(d,2),m=p[0],v=p[1];c.push(m),f.push(v)}return[c,f]}},{key:"_getRasterTileAlignmentInfo",value:function(e,t){return null==this._rasterTileAlighmentInfo&&(this._rasterTileAlighmentInfo=(0,$.P_)(this.rasterInfo)),null==this._rasterTileAlighmentInfo.pyramidsInfo?null:(0,i.Z)({startX:t,halfWorldWidth:this._rasterTileAlighmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlighmentInfo.hasGCSSShiftTransform},this._rasterTileAlighmentInfo.pyramidsInfo[e])}},{key:"_getSourceDataInfo",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i={datumTransformation:n.datumTransformation,pyramidLevel:0,pyramidResolution:null,srcExtent:null,srcHeight:0,srcResolution:null,srcWidth:0,ul:{x:0,y:0}};n.srcResolution&&(i.srcResolution=n.srcResolution,this._updateSourceDataInfo(e,i));var a=this.rasterInfo.storageInfo.maximumPyramidLevel||0,s=i.srcWidth,o=i.srcHeight,l=i.pyramidLevel,u=s/t,c=o/r,f=l<a&&u*c>=16,h=l===a&&this._requireTooManySrcTiles(s,o,t,r);if(f||h||0===s||0===o){var d=new re.Z({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/r,spatialReference:e.spatialReference}),p=(0,$.VO)(d,this.rasterInfo.spatialReference,e,i.datumTransformation),m=!p||n.srcResolution&&p.x+p.y<n.srcResolution.x+n.srcResolution.y;if(f&&n.srcResolution&&m){var v=Math.round(Math.log(Math.max(u,c))/Math.LN2)-1;if(a-l+3>=v){var y=Math.pow(2,v);p={x:n.srcResolution.x*y,y:n.srcResolution.y*y}}}p&&(i.srcResolution=p,this._updateSourceDataInfo(e,i))}return this._requireTooManySrcTiles(i.srcWidth,i.srcHeight,t,r)&&(i.srcWidth=0,i.srcHeight=0),i}},{key:"_requireTooManySrcTiles",value:function(e,t,r,n){var i=this.rasterInfo.storageInfo.tileInfo;return Math.ceil(e/i.size[0])*Math.ceil(t/i.size[1])>=256||e/r>8||t/n>8}},{key:"_updateSourceDataInfo",value:function(e,t){t.srcWidth=0,t.srcHeight=0;var r=this.rasterInfo,n=r.spatialReference,i=t.srcResolution,a=t.datumTransformation,s=(0,$.kr)(i,r,this.ioConfig.sampling),o=s.pyramidLevel,l=s.pyramidResolution;if(!s.excessiveReading){var u=t.srcExtent||(0,$.tB)(e,n,a);if(null!=u){var c=r.transform;c&&(u=c.inverseTransform(u)),t.srcExtent=u;var f=r.storageInfo.origin,h=f.x,d=f.y,p=Math.floor((u.xmin-h)/l.x+.1),m=Math.floor((d-u.ymax)/l.y+.1),v=Math.floor((u.xmax-h)/l.x-.1),y=Math.floor((d-u.ymin)/l.y-.1),x=u.width<.1*l.x?0:v-p+1,g=u.height<.1*l.y?0:y-m+1;t.pyramidLevel=o,t.pyramidResolution=l,t.srcWidth=x,t.srcHeight=g,t.ul={x:p,y:m}}}}},{key:"_getRequestOptionsWithSliceId",value:function(e){return null!=this.rasterInfo.multidimensionalInfo&&null==e.sliceId&&(e=(0,i.Z)((0,i.Z)({},e),{},{sliceId:this.getSliceIndex(e.multidimensionalDefinition)})),e}},{key:"_processIdentifyResult",value:function(e,t){var r=t.srcLocation,n=t.position,a=t.pyramidLevel,s=t.useTransposedTile,o=e.pixels[0].length/e.width/e.height;if(e.mask&&!e.mask[n])return{location:r,value:null};var l=this.rasterInfo.multidimensionalInfo;if(null==l||!s){var u=e.pixels.map((function(e){return e[n]})),c={location:r,value:u,pyramidLevel:a},f=this._computeMagDirValues(u.map((function(e){return[e]})));return null!==f&&void 0!==f&&f.length&&(c.magdirValue=f.map((function(e){return e[0]}))),c}var h=e.pixels.map((function(e){return e.slice(n*o,n*o+o)})),d=this._computeMagDirValues(h),p=t.requestSomeSlices,m=t.identifyOptions,v=(0,V.MO)(l,m.transposedVariableName);if(p){var y,x=(0,V.Ur)(v,m.multidimensionalDefinition,m.timeExtent);h=h.map((function(e){return x.map((function(t){return e[t]}))})),d=null===(y=d)||void 0===y?void 0:y.map((function(e){return x.map((function(t){return e[t]}))})),v=x.map((function(e){return v[e]}))}var g,b=e.noDataValues||this.rasterInfo.noDataValue,k={pixels:h,pixelType:e.pixelType};return null!=b&&((0,X.A)(k,b),g=k.mask),{location:r,value:null,dataSeries:v.map((function(e,t){var r,n,a={value:0===(null===(r=g)||void 0===r?void 0:r[t])?null:h.map((function(e){return e[t]})),multidimensionalDefinition:e.multidimensionalDefinition.map((function(e){return new J.Z((0,i.Z)((0,i.Z)({},e),{},{isSlice:!0}))}))};return null!==(n=d)&&void 0!==n&&n.length&&(a.magdirValue=[d[0][t],d[1][t]]),a})),pyramidLevel:a}}}]),r}((0,G.v)(q.wq));(0,p._)([(0,w.Cb)()],ne.prototype,"_rasterTileAlighmentInfo",void 0),(0,p._)([(0,w.Cb)({readOnly:!0})],ne.prototype,"_isGlobalWrappableSource",null),(0,p._)([(0,w.Cb)({readOnly:!0})],ne.prototype,"_hasNoneOrGCSShiftTransform",null),(0,p._)([(0,w.Cb)()],ne.prototype,"rasterJobHandler",null),(0,p._)([(0,w.Cb)(E.HQ)],ne.prototype,"url",null),(0,p._)([(0,w.Cb)({type:String,json:{write:!0}})],ne.prototype,"datasetName",void 0),(0,p._)([(0,w.Cb)({type:String,json:{write:!0}})],ne.prototype,"datasetFormat",void 0),(0,p._)([(0,w.Cb)()],ne.prototype,"hasUniqueSourceStorageInfo",void 0),(0,p._)([(0,w.Cb)()],ne.prototype,"rasterInfo",void 0),(0,p._)([(0,w.Cb)()],ne.prototype,"ioConfig",void 0),(0,p._)([(0,w.Cb)()],ne.prototype,"sourceJSON",void 0);var ie=ne=(0,p._)([(0,R.j)("esri.layers.support.rasterDatasets.BaseRaster")],ne),ae=r(49818),se=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).datasetFormat="Function",e.tileType="Raster",e.rasterFunction=null,e}return(0,l.Z)(r,[{key:"open",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l,u,c,f,h,d,p,m,v=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return o=this.rasterFunction,null!==(r=this.primaryRasters)&&void 0!==r&&null!==(r=r.rasters)&&void 0!==r&&r.length?o.sourceRasters=this.primaryRasters.rasters:(this.primaryRasters=o.getPrimaryRasters(),this.rasterJobHandler&&(null===(n=this.primaryRasters.rasters)||void 0===n||n.forEach((function(e){return e.rasterJobHandler=v.rasterJobHandler})))),l=this.primaryRasters,u=l.rasters,c=l.rasterIds,f=u.map((function(e){return e.rasterInfo?void 0:e.open(t)})),e.next=7,Promise.all(f);case 7:if(h=u.map((function(e){return e.rasterInfo})),(d=o.bind({rasterInfos:h,rasterIds:c})).success&&0!==h.length){e.next=10;break}throw new y.Z("raster-function:open","cannot bind the function: ".concat(null!==(i=d.error)&&void 0!==i?i:""));case 10:return"Table"===(null===(p="Table"===o.functionName?o:null===(s=o.functionArguments)||void 0===s?void 0:s.raster)||void 0===p?void 0:p.functionName)&&(o.rasterInfo.attributeTable=ae.Z.fromJSON(p.functionArguments.attributeTableAsRecordSet)),e.next=14,this.syncJobHandler();case 14:m=h[0],this.hasUniqueSourceStorageInfo=1===h.length||h.slice(1).every((function(e){return v._hasSameStorageInfo(e,m)})),this.set("sourceJSON",u[0].sourceJSON),this.set("rasterInfo",o.rasterInfo);case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"syncJobHandler",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(){var t;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",null===(t=this.rasterJobHandler)||void 0===t?void 0:t.updateRasterFunction(this.rasterFunction));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var s,o,l,u,c,f,h,d,p,m,v,y,x,g,b,k,w,I,Z,_=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u=_.length>3&&void 0!==_[3]?_[3]:{},c=this.primaryRasters,f=c.rasters,h=c.rasterIds,d=!1,p=u.interpolation,m=null===(s=this.rasterFunction.flatWebGLFunctionChain)||void 0===s?void 0:s.hasFocalFunction,!u.requestRawData&&"bilinear"!==p&&m&&(d=1===f.length&&!u.skipRasterFunction,u=(0,i.Z)((0,i.Z)({},u),{},{interpolation:"bilinear",requestRawData:d})),v=f.map((function(e){return e.fetchPixels(t,r,n,u)})),e.next=8,Promise.all(v);case 8:if(y=e.sent,x=y.map((function(e){return e.pixelBlock})),g=d||u.requestRawData?y.map((function(e){return e.srcTilePixelSize})):null,!u.skipRasterFunction&&!x.every((function(e){return null==e}))){e.next=13;break}return e.abrupt("return",y[0]);case 13:if(b=null!==(o=null===(l=y.find((function(e){return null!=e.pixelBlock})))||void 0===l?void 0:l.extent)&&void 0!==o?o:t,!this.rasterJobHandler){e.next=20;break}return e.next=17,this.rasterJobHandler.process({extent:b,primaryPixelBlocks:x,primaryPixelSizes:g,primaryRasterIds:h});case 17:e.t0=e.sent,e.next=21;break;case 20:e.t0=this.rasterFunction.process({extent:b,primaryPixelBlocks:x,primaryPixelSizes:g,primaryRasterIds:h});case 21:if(k=e.t0,w=y[0].transformGrid,d&&null!=k&&null!=w){e.next=25;break}return e.abrupt("return",(0,i.Z)((0,i.Z)({},y[0]),{},{pixelBlock:k}));case 25:if(I={rows:w.spacing[0],cols:w.spacing[1]},!this.rasterJobHandler){e.next=32;break}return e.next=29,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:[k],srcMosaicSize:{width:k.width,height:k.height},destDimension:{width:r,height:n},coefs:w.coefficients,sampleSpacing:I,projectDirections:!1,gcsGrid:null,isUV:!1,interpolation:p,alignmentInfo:void 0,blockWidths:null},u);case 29:Z=e.sent.pixelBlock,e.next=33;break;case 32:Z=(0,Q.Uk)(k,{width:r,height:n},w.coefficients,I,p);case 33:return e.abrupt("return",{extent:t,srcExtent:y[0].srcExtent,pixelBlock:Z});case 34:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_hasSameStorageInfo",value:function(e,t){var r=e.storageInfo,n=e.pixelSize,i=e.spatialReference,a=e.extent,s=t.storageInfo,o=t.pixelSize,l=t.spatialReference,u=t.extent;return n.x===o.x&&n.y===o.y&&i.equals(l)&&a.equals(u)&&r.blockHeight===s.blockHeight&&r.blockWidth===s.blockWidth&&r.maximumPyramidLevel===s.maximumPyramidLevel}}]),r}(ie);(0,p._)([(0,w.Cb)({type:String,json:{write:!0}})],se.prototype,"datasetFormat",void 0),(0,p._)([(0,w.Cb)()],se.prototype,"tileType",void 0),(0,p._)([(0,w.Cb)()],se.prototype,"rasterFunction",void 0),(0,p._)([(0,w.Cb)()],se.prototype,"primaryRasters",void 0);var oe=se=(0,p._)([(0,R.j)("esri.layers.support.rasterDatasets.FunctionRaster")],se),le=r(68860),ue=r(96212);function ce(e,t,r){return fe.apply(this,arguments)}function fe(){return fe=(0,s.Z)((0,a.Z)().mark((function e(t,i,s){var o,l,u,c,f,h;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("extent"!==s.type){e.next=2;break}return e.abrupt("return",de(t,i,s));case 2:return o=t.width,l=t.height,u=new Uint8Array(o*l),e.next=7,Promise.all([r.e(9058),r.e(2170)]).then(r.bind(r,2170));case 7:return c=e.sent,f=c.contains,h=c.intersects,e.abrupt("return",h(i,s)?"polyline"===s.type?pe(t,i,s):f(s,i)?t:he(t,i,s):new ue.Z({pixelType:t.pixelType,width:o,height:l,mask:u,maskIsAlpha:!1,pixels:(0,n.Z)(t.pixels)}));case 11:case"end":return e.stop()}}),e)}))),fe.apply(this,arguments)}function he(e,t,r){if(!e)return e;var i,a=e.width,s=e.height,o=t.width/a,l=t.height/s,u=t.xmin,c=t.ymax;if("extent"===r.type){var f=(r.xmin-u)/o,h=(r.xmax-u)/o,d=(c-r.ymax)/l,p=(c-r.ymin)/l;i=[[[f,d],[f,p],[h,p],[h,d],[f,d]]]}else i=r.rings.map((function(e){return e.map((function(e){var t=(0,P.Z)(e,2),r=t[0],n=t[1];return[(r-u)/o,(c-n)/l]}))}));var m=document.createElement("canvas");m.width=a,m.height=s;var v=m.getContext("2d");v.fillStyle="#f00",i.forEach((function(e){v.beginPath(),v.moveTo(e[0][0],e[0][1]);for(var t=0;t<e.length;t++)v.lineTo(e[t][0],e[t][1]);v.closePath(),v.fill()}));for(var y=v.getImageData(0,0,a,s).data,x=e.mask,g=a*s,b=new Uint8Array(g),k=0;k<g;k++)x&&!x[k]||(b[k]=y[4*k+3]>127?255:0);return new ue.Z({pixelType:e.pixelType,width:a,height:s,mask:b,maskIsAlpha:!1,pixels:(0,n.Z)(e.pixels)})}function de(e,t,r){var i=e.width,a=e.height,s=new Uint8Array(i*a),o=t.width/i,l=t.height/a;if(r.width/o<.5||r.height/l<.5)return new ue.Z({pixelType:e.pixelType,width:i,height:a,mask:s,pixels:(0,n.Z)(e.pixels)});var u=t.xmin,c=t.xmax,f=t.ymin,h=t.ymax,d=r.xmin,p=r.xmax,m=r.ymin,v=r.ymax,y=Math.max(u,d),x=Math.min(c,p),g=Math.max(f,m),b=Math.min(h,v),k=.5*o,w=.5*l;if(x-y<k||b-g<w||x<u+k||y>c-k||g>h-w||b<f+w)return new ue.Z({pixelType:e.pixelType,width:i,height:a,mask:s,pixels:(0,n.Z)(e.pixels)});var I=Math.max(0,(y-u)/o),Z=Math.min(i,Math.max(0,(x-u)/o)),_=Math.max(0,(h-b)/l),S=Math.min(a,Math.max(0,(h-g)/l)),R=Math.round(I),T=Math.round(Z)-1,C=Math.round(_),M=Math.round(S)-1;if(R===T&&I%1>.5&&Z%1<.5||C===M&&_%1>.5&&S%1<.5)return new ue.Z({pixelType:e.pixelType,width:i,height:a,mask:s,pixels:(0,n.Z)(e.pixels)});if(0===R&&0===C&&T===i&&M===a)return e;for(var F=e.mask,P=C;P<=M;P++)for(var O=R;O<=T;O++){var D=P*i+O;s[D]=F?F[D]:255}return new ue.Z({pixelType:e.pixelType,width:i,height:a,mask:s,pixels:(0,n.Z)(e.pixels)})}function pe(e,t,r){for(var i=e.width,a=e.height,s=new Uint8Array(i*a),o=t.width/i,l=t.height/a,u=t.xmin,c=t.ymax,f=r.paths,h=e.mask,d=0;d<f.length;d++)for(var p=f[d],m=0;m<p.length-1;m++){var v=(0,P.Z)(p[m],2),y=v[0],x=v[1],g=(0,P.Z)(p[m+1],2),b=g[0],k=g[1],w=Math.floor((c-x)/l),I=Math.floor((c-k)/l);if(I<w){var Z=w;w=I,I=Z}w=Math.max(0,w),I=Math.min(a-1,I);for(var _=(b-y)/(k-x),S=w;S<=I;S++){var R=S===w?Math.max(x,k):(a+1-S)*l,T=S===I?Math.min(x,k):R-l,C=k===x?Math.floor((y-u)/o):Math.floor((_*(R-x)+y-u)/o),M=k===x?Math.floor((b-u)/o):Math.floor((_*(T-x)+y-u)/o);if(M<C){var F=C;C=M,M=F}var O=S*i;C=Math.max(0,C),M=Math.min(i-1,M);for(var D=O+C;D<=O+M;D++)s[D]=h?h[D]:255}}return new ue.Z({pixelType:e.pixelType,width:i,height:a,mask:s,pixels:(0,n.Z)(e.pixels)})}function me(e,t,r){var n,i,a,s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=e.spatialReference,l=function(e,t){if(e.spatialReference.equals(t))return e;var r=(0,le.c9)(e.spatialReference),n=(0,le.c9)(t);if(r===n)return e;var i=r/n;return{x:e.x*i,y:e.y*i}}(r,o),u=l.x,c=l.y,f="extent"===t.type?t:t.extent,h=f.xmin,d=f.xmax,p=f.ymax,m=f.ymin,v=e.extent,y=v.xmin,x=v.ymax;return s?(h=y+(h>y?u*Math.round((h-y)/u):0),p=x-(p<x?c*Math.round((x-p)/c):0),d=y+(d>y?u*Math.round((d-y)/u):0),m=x-(m<x?c*Math.round((x-m)/c):0),n=new te.Z({xmin:h,ymax:p,xmax:d,ymin:m,spatialReference:o}),i=Math.round(n.width/u),a=Math.round(n.height/c)):(i=Math.floor((d-h)/u+.8),a=Math.floor((p-m)/c+.8),d=(h=y+(h>y?u*Math.floor((h-y)/u+.1):0))+i*u,m=(p=x-(p<x?c*Math.floor((x-p)/c+.1):0))-a*c,n=new te.Z({xmin:h,ymax:p,xmax:d,ymin:m,spatialReference:o})),{extent:n,width:i,height:a}}var ve=r(53531),ye=r(21449),xe=r(73425),ge=r(43238),be=r(50254),ke=r(55185),we=r(78952),Ie=x.Z.getLogger("esri.layers.mixins.ImageryTileMixin"),Ze=r(6061),_e=r(29598),Se=r(71684),Re=r(56811),Te=r(99063),Ce=r(83040),Me=r(60117),Fe=r(53737),Pe=r(17061);function Oe(e){var t=e.fields,r=e.records,n=t.some((function(e){return"oid"===e.name.toLowerCase()}))?"OBJECTID":"OID",i=[{name:n,type:"esriFieldTypeOID",alias:"OID"}].concat(t.map((function(e){return{name:e.name,type:"esriFieldType"+e.typeName,alias:e.name}}))),a=i.map((function(e){return e.name})),s=[],o=0,l=0;return r.forEach((function(e){var t={};for(t[n]=o++,l=1;l<a.length;l++)t[a[l]]=e[l-1];s.push({attributes:t})})),{displayFieldName:"",fields:i,features:s}}var De=function(){function e(){(0,o.Z)(this,e)}return(0,l.Z)(e,null,[{key:"supportedVersions",get:function(){return[5]}},{key:"parse",value:function(e){var t=new DataView(e),r=3&t.getUint8(0);if(3!==r)return{header:{version:r},recordSet:null};var n,i=t.getUint32(4,!0),a=t.getUint16(8,!0),s=t.getUint16(10,!0),o={version:r,recordCount:i,headerByteCount:a,recordByteCount:s},l=32,u=[],c=[];if(3===r){for(;13!==t.getUint8(l);)n=String.fromCharCode(t.getUint8(l+11)).trim(),u.push({name:(0,Pe.f)(new Uint8Array(e,l,11)),type:n,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(n)],length:t.getUint8(l+16)}),l+=32;if(l+=1,u.length>0)for(var f=function(){var r=[];32===t.getUint8(l)?(l+=1,u.forEach((function(t){if("C"===t.type)r.push((0,Pe.f)(new Uint8Array(e,l,t.length)).trim());else if("N"===t.type)r.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim(),10));else if("F"===t.type)r.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim()));else if("D"===t.type){var n=String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim();r.push(new Date(parseInt(n.substring(0,4),10),parseInt(n.substring(4,6),10)-1,parseInt(n.substring(6,8),10)))}l+=t.length})),c.push(r)):l+=s};c.length<i&&e.byteLength-l>s;)f()}return{header:o,fields:u,records:c,recordSet:Oe({fields:u,records:c})}}}]),e}(),Be=r(77960),ze=new Map;ze.set("int16","esriFieldTypeSmallInteger"),ze.set("int32","esriFieldTypeInteger"),ze.set("int64","esriFieldTypeInteger"),ze.set("float32","esriFieldTypeSingle"),ze.set("float64","esriFieldTypeDouble"),ze.set("text","esriFieldTypeString");var Ae=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).storageInfo=null,e.datasetFormat="CRF",e}return(0,l.Z)(r,[{key:"open",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this.request(this.url+"/conf.json",{signal:null===t||void 0===t?void 0:t.signal});case 4:if(r=e.sent,n=r.data,this._validateHeader(n)){e.next=8;break}throw new y.Z("cloudraster:open","Invalid or unsupported conf.json.");case 8:if(this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),i=this._parseHeader(n),s=i.storageInfo,"thematic"!==(o=i.rasterInfo).dataType){e.next=15;break}return e.next=13,this._fetchAuxiliaryInformation();case 13:l=e.sent,o.attributeTable=l;case 15:this._set("storageInfo",s),this._set("rasterInfo",o),this.ioConfig.retryCount=this.ioConfig.retryCount||0;case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s,o,l,u,c,f,h,d,p,m,v,y,x,g,b=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=b.length>3&&void 0!==b[3]?b[3]:{},s=this.rasterInfo.storageInfo.transposeInfo,o=i.transposedVariableName,!((u=(l=!(!s||!o))?0:this.rasterInfo.storageInfo.maximumPyramidLevel-t)<0)){e.next=4;break}return e.abrupt("return",null);case 4:return c=this._buildCacheFilePath(u,r,n,i.multidimensionalDefinition,o),f=this._getIndexRecordFromBundle(r,n,l),e.next=8,this.request(c,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:i.signal});case 8:if(h=e.sent){e.next=11;break}return e.abrupt("return",null);case 11:if(d=new Uint8Array(h.data),0!==(p=this._getTileEndAndContentType(d,f)).recordSize){e.next=14;break}return e.abrupt("return",null);case 14:return e.next=16,this.request(c,{range:{from:p.position,to:p.position+p.recordSize},responseType:"array-buffer",signal:i.signal});case 16:if(m=e.sent){e.next=19;break}return e.abrupt("return",null);case 19:return v=this._getTileSize(l),y=(0,P.Z)(v,2),x=y[0],g=y[1],e.abrupt("return",this.decodePixelBlock(m.data,{width:x,height:g,planes:null,pixelType:null,returnInterleaved:l}));case 21:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_validateHeader",value:function(e){return e&&"RasterInfo"===e.type&&!["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"].some((function(t){return!e[t]}))}},{key:"_parseHeader",value:function(e){var t,r,n,i,a=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][e.pixelType],s=e.bandCount,o=e.colormap,l=e.blockWidth,u=e.blockHeight,c=e.firstPyramidLevel,f=e.maximumPyramidLevel,h=null===(t=e.statistics)||void 0===t?void 0:t.map((function(e){return{min:e.min,max:e.max,avg:e.mean,stddev:e.standardDeviation,median:e.median,mode:e.mode}})),d=null!==(r=e.histograms)&&void 0!==r&&null!==(r=r[0])&&void 0!==r&&null!==(r=r.counts)&&void 0!==r&&r.length?e.histograms:null,p=e.extent.spatialReference,m=null===(n=e.geodataXform)||void 0===n?void 0:n.spatialReference,v=new we.Z(null!==p&&void 0!==p&&p.wkid||null!==p&&void 0!==p&&p.wkt||null!==p&&void 0!==p&&p.wkt2?p:m),y=new te.Z({xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:v}),x=new re.Z({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:v}),g=Math.round((y.xmax-y.xmin)/x.x),b=Math.round((y.ymax-y.ymin)/x.y),k=this._parseTransform(e.geodataXform),w=k?y:null;k&&(y=k.forwardTransform(y),x.x=(y.xmax-y.xmin)/g,x.y=(y.ymax-y.ymin)/b);var I,Z,_,S,R=null!==(i=e.properties)&&void 0!==i?i:{},T=e.format.toLowerCase().replace("cache/",""),C=new re.Z(e.origin.x,e.origin.y,v);if(null!==o&&void 0!==o&&o.colors)for(I=[],Z=0;Z<o.colors.length;Z++)_=o.colors[Z],S=o.values?o.values[Z]:Z,I.push([S,255&_,_<<16>>>24,_<<8>>>24,_>>>24]);var M=e.LODInfos,F=[];for(Z=0;Z<M.levels.length;Z++)F.push(new j.Z({level:M.levels[Z],resolution:M.resolutions[Z],scale:96/.0254*M.resolutions[Z]}));var P=new W.Z({dpi:96,lods:F,format:T,origin:C,size:[l,u],spatialReference:v}),O={recordSize:8,packetSize:e.packetSize,headerSize:e.packetSize*e.packetSize*8+64},D=[{maxCol:Math.ceil(g/l)-1,maxRow:Math.ceil(b/u)-1,minCol:0,minRow:0}],B=2;if(f>0)for(Z=0;Z<f;Z++)D.push({maxCol:Math.ceil(g/B/l)-1,maxRow:Math.ceil(b/B/u)-1,minCol:0,minRow:0}),B*=2;var z=e.mdInfo,A=null;if(z&&R._yxs){var E=R._yxs;A={packetSize:E.PacketSize,tileSize:[E.TileXSize,E.TileYSize]}}return{storageInfo:O,rasterInfo:new Fe.Z({width:g,height:b,pixelType:a,bandCount:s,extent:y,nativeExtent:w,transform:k,spatialReference:v,pixelSize:x,keyProperties:R,statistics:h,histograms:d,multidimensionalInfo:z,colormap:I,storageInfo:new U.Z({blockWidth:l,blockHeight:u,pyramidBlockWidth:l,pyramidBlockHeight:u,origin:C,tileInfo:P,transposeInfo:A,firstPyramidLevel:c,maximumPyramidLevel:f,blockBoundary:D})})}}},{key:"_parseTransform",value:function(e){var t,r;if(!(0,Be.j)(e))throw new y.Z("cloudraster:open","the data contains unsupported geodata transform types");var n=(0,Be.c)(e);if("identity"===n.type)return null;if("polynomial"!==n.type||null===(t=n.forwardCoefficients)||void 0===t||!t.length||null===(r=n.inverseCoefficients)||void 0===r||!r.length)throw new y.Z("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");return n}},{key:"_fetchAuxiliaryInformation",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l,u;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.request(this.url+"/conf.vat.json",{signal:t}).then((function(e){return e.data})).catch((function(){return null})),n=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:t}).then((function(e){return e.data})).catch((function(){return null})),e.next=4,Promise.all([r,n]);case 4:return(i=e.sent)[0]&&(o=i[0].fields,l=i[0].values,o&&l&&(o=o.map((function(e){return{type:"OID"===e.name?"esriFieldTypeOID":ze.get(e.type),name:e.name,alias:e.alias||e.name}})),u=l.map((function(e){return{attributes:e}})),o&&l&&(s={fields:o,features:u}))),!s&&i[1]&&(s=De.parse(i[1]).recordSet),e.abrupt("return",ae.Z.fromJSON(s));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_buildCacheFilePath",value:function(e,t,r,n,i){var a=this._getPackageSize(!!i),s=Math.floor(t/a)*a,o=Math.floor(r/a)*a,l="R"+this._toHexString4(s)+"C"+this._toHexString4(o),u="L";u+=e>=10?e.toString():"0"+e.toString();var c=this.rasterInfo.multidimensionalInfo,f=null===n||void 0===n?void 0:n[0];if(null==c||!f)return"".concat(this.url,"/_alllayers/").concat(u,"/").concat(l,".bundle");var h="_yxs";if(!i){h=c.variables.find((function(e){return e.name===f.variableName})).dimensions[0].values.indexOf(f.values[0]).toString(16);for(var d=4-h.length,p=0;p<d;p++)h="0"+h;h="S"+h}var m=this._getVariableFolderName(i||f.variableName);return"".concat(this.url,"/_alllayers/").concat(m,"/").concat(h,"/").concat(u,"/").concat(l,".bundle")}},{key:"_getPackageSize",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=this.rasterInfo.storageInfo.transposeInfo;return t&&null!=r?null!==(e=r.packetSize)&&void 0!==e?e:0:this.storageInfo.packetSize}},{key:"_getTileSize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.rasterInfo.storageInfo,r=t.transposeInfo;return e&&null!=r?r.tileSize:t.tileInfo.size}},{key:"_getVariableFolderName",value:function(e){return""===(e=e.trim())?"_v":e.replaceAll(/[\{|\}\-]/g,"_").replace("\\*","_v")}},{key:"_getIndexRecordFromBundle",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this._getPackageSize(r),i=n*(e%n)+t%n;if(i<0)throw new Error("Invalid level / row / col");return 20+i*this.storageInfo.recordSize+44}},{key:"_getTileEndAndContentType",value:function(e,t){var r,n=e.subarray(t,t+8),i=0;for(r=0;r<5;r++)i|=(255&n[r])<<8*r;var a=0xffffffffff&i;for(i=0,r=5;r<8;r++)i|=(255&n[r])<<8*(r-5);return{position:a,recordSize:0xffffffffff&i}}},{key:"_toHexString4",value:function(e){var t=e.toString(16);if(4!==t.length)for(var r=4-t.length;r-- >0;)t="0"+t;return t}}]),r}(ie);(0,p._)([(0,w.Cb)({readOnly:!0})],Ae.prototype,"storageInfo",void 0),(0,p._)([(0,w.Cb)({type:String,json:{write:!0}})],Ae.prototype,"datasetFormat",void 0);var Ee=Ae=(0,p._)([(0,R.j)("esri.layers.support.rasterDatasets.CloudRaster")],Ae),Je=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).datasetFormat="MEMORY",e.data=null,e}return(0,l.Z)(r,[{key:"open",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l,u,c,f,h,d,p,m,v,y,x,g,b;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return i=this.data,s=this.data,o=s.pixelBlock,l=s.statistics,u=s.histograms,c=s.name,f=s.keyProperties,h=s.nativeExtent,d=s.transform,p=o.width,m=o.height,v=o.pixelType,y=null!==(r=i.extent)&&void 0!==r?r:new te.Z({xmin:-.5,ymin:.5,xmax:p-.5,ymax:m-.5,spatialReference:new we.Z({wkid:3857})}),x=null!==(n=i.isPseudoSpatialReference)&&void 0!==n?n:!i.extent,g={x:y.width/p,y:y.height/m},b=new Fe.Z({width:p,height:m,pixelType:v,extent:y,nativeExtent:h,transform:d,pixelSize:g,spatialReference:y.spatialReference,bandCount:o.pixels.length,keyProperties:f||{},statistics:l,isPseudoSpatialReference:x,histograms:u}),this.createRemoteDatasetStorageInfo(b,512,512),this._set("rasterInfo",b),this.updateTileInfo(),e.next=8,this._buildInMemoryRaster(o,{width:512,height:512},t);case 8:this.datasetName=c,this.url="/InMemory/"+c;case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r){var n=this._pixelBlockTiles.get("".concat(e,"/").concat(t,"/").concat(r));return Promise.resolve(n)}},{key:"_buildInMemoryRaster",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s,o,l,u,c,f,h;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=this.rasterInfo.storageInfo.maximumPyramidLevel,l=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:t,tileSize:r,maximumPyramidLevel:o},n):Promise.resolve((0,Q.Vl)(t,r,o)),u=null!=this.rasterInfo.statistics,c=null!=this.rasterInfo.histograms,f=u?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:t},n):Promise.resolve((0,ye.Hv)(t)),e.next=7,(0,b.as)([l,f]);case 7:if((h=e.sent)[0].value||!h[1].value){e.next=10;break}throw new y.Z("inmemory-raster:open","failed to build in memory raster");case 10:this._pixelBlockTiles=h[0].value,u||(this.rasterInfo.statistics=null===(i=h[1].value)||void 0===i?void 0:i.statistics),c||(this.rasterInfo.histograms=null===(s=h[1].value)||void 0===s?void 0:s.histograms);case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()}]),r}(ie);(0,p._)([(0,w.Cb)({type:String,json:{write:!0}})],Je.prototype,"datasetFormat",void 0),(0,p._)([(0,w.Cb)()],Je.prototype,"data",void 0);var Ne=Je=(0,p._)([(0,R.j)("esri.layers.support.rasterDatasets.InMemoryRaster")],Je);function He(e,t){if(!e||!t)return[];var r=t;t.includes("/")?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=[];if(t){for(var i=He(e,r),a=0;a<i.length;a++)He(i[a],t).forEach((function(e){return n.push(e)}));return n}var s=e.getElementsByTagNameNS("*",r);if(!s||0===s.length)return[];for(var o=0;o<s.length;o++)n.push(s[o]||s.item(o));return n}function Le(e,t){if(!e||!t)return null;var r=t;t.includes("/")?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=He(e,r);return n.length>0?t?Le(n[0],t):n[0]:null}function We(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=r?Le(e,r):e;return n?(t=n.textContent||n.nodeValue)?t.trim():null:null}function qe(e,t){return function(e,t){for(var r,n=He(e,t),i=[],a=0;a<n.length;a++)(r=n[a].textContent||n[a].nodeValue)&&""!==(r=r.trim())&&i.push(r);return i}(e,t).map((function(e){return Number(e)}))}function Ge(e,t){var r=We(e,t);return Number(r)}function je(e,t){var r,n=null===e||void 0===e||null===(r=e.nodeName)||void 0===r?void 0:r.toLowerCase(),i=t.toLowerCase();return n.slice(n.lastIndexOf(":")+1)===i}var Ue=r(69405);function Ve(e,t){if(!e||!t)return null;for(var r=[],n=0;n<e.length;n++)r.push(e[n]),r.push(t[n]);return r}function Ye(e){if(!e)return null;var t=Number(e);if(!isNaN(t)&&0!==t)return new we.Z({wkid:t});if(e=String(e).trim(),(0,z.xl)(e))return new we.Z({wkt2:e});var r=e.toUpperCase();if(r.startsWith("COMPD_CS")){if(!r.includes("VERTCS")||!r.includes("GEOGCS")&&!r.startsWith("PROJCS"))return null;var n=r.indexOf("VERTCS"),i=r.indexOf("PROJCS"),a=i>-1?i:r.indexOf("GEOGCS");if(-1===a)return null;var s=e.slice(a,e.lastIndexOf("]",n)+1).trim(),o=e.slice(n,e.lastIndexOf("]")).trim();t=Xe(s);var l=new we.Z(t?{wkid:t}:{wkt:s}),u=Xe(o);return u&&(l.vcsWkid=u),l}return r.startsWith("GEOGCS")||r.startsWith("PROJCS")?(t=Xe(e),new we.Z(0!==t?{wkid:t}:{wkt:e})):null}function Xe(e){var t,r=e.replaceAll("]","[").replaceAll('"',"").split("[").map((function(e){return e.trim()})).filter((function(e){return""!==e})),n=r[r.length-1].split(","),i=null===(t=n[0])||void 0===t?void 0:t.toLowerCase();if(("epsg"===i||"esri"===i)&&e.endsWith('"]]')){var a=Number(n[1]);if(!isNaN(a)&&0!==a)return a}return 0}function Ke(e){var t;if("pamdataset"!==(null===e||void 0===e||null===(t=e.documentElement.tagName)||void 0===t?void 0:t.toLowerCase()))return{};var r={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach((function(e){if(1===e.nodeType)if(je(e,"SRS")){if(!r.spatialReference){var t=We(e);r.spatialReference=Ye(t)}}else if(je(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){var n=function(e){var t,r=Le(e,"GeodataXform"),n=Ye(Ge(r,"SpatialReference/WKID")||We(r,"SpatialReference/WKT"));if("typens:PolynomialXform"!==r.getAttribute("xsi:type"))return{spatialReference:n,transform:null};var i=null!==(t=Ge(r,"PolynomialOrder"))&&void 0!==t?t:1,a=qe(r,"CoeffX/Double"),s=qe(r,"CoeffY/Double"),o=qe(r,"InverseCoeffX/Double"),l=qe(r,"InverseCoeffY/Double"),u=Ve(a,s),c=Ve(o,l);return{spatialReference:n,transform:u&&c&&u.length&&c.length?new Ue.Z({spatialReference:n,polynomialOrder:i,forwardCoefficients:u,inverseCoefficients:c}):null}}(e),i=n.spatialReference,a=n.transform;r.transform=a,r.spatialReference||(r.spatialReference=i)}else He(e,"MDI").forEach((function(e){return r.metadata[e.getAttribute("key")]=We(e)}));else if(je(e,"PAMRasterBand")){var s=function(e){var t,r,n,i,a,s=Ge(e,"NoDataValue"),o=Le(e,"Histograms/HistItem"),l=Ge(o,"HistMin"),u=Ge(o,"HistMax"),c=Ge(o,"BucketCount"),f=null===(t=We(o,"HistCounts"))||void 0===t?void 0:t.split("|").map((function(e){return Number(e)}));He(e,"Metadata/MDI").forEach((function(e){var t,s=Number(null!==(t=e.textContent)&&void 0!==t?t:e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":r=s;break;case"STATISTICS_MAXIMUM":n=s;break;case"STATISTICS_MEAN":i=s;break;case"STATISTICS_STDDEV":a=s}}));var h=Ge(e,"Metadata/SourceBandIndex");return{noDataValue:s,histogram:null!==f&&void 0!==f&&f.length&&null!=l&&null!=u?{min:l,max:u,size:c||f.length,counts:f}:null,sourceBandIndex:h,statistics:null!=r&&null!=n?{min:r,max:n,avg:i,stddev:a}:null}}(e);null!=s.sourceBandIndex&&null==r.rasterBands[s.sourceBandIndex]?r.rasterBands[s.sourceBandIndex]=s:r.rasterBands.push(s)}}));var n=r.rasterBands;if(n.length){var i=!!n[0].statistics;r.statistics=i?n.map((function(e){return e.statistics})).filter(Z.pC):null;var a=!!n[0].histogram;r.histograms=a?n.map((function(e){return e.histogram})).filter(Z.pC):null}return r}var Qe=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(){return(0,o.Z)(this,r),t.apply(this,arguments)}return(0,l.Z)(r,[{key:"open",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l,u,c,f,h,d,p,m;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this._fetchData(t);case 4:return r=e.sent,e.next=7,this._fetchAuxiliaryData(t);case 7:return n=e.sent,i=n.spatialReference,s=n.statistics,o=n.histograms,l=n.transform,(u=!i)&&(i=new we.Z({wkid:3857})),(null===o||void 0===o?void 0:o.length)&&null==s&&(s=(0,ye.Oh)(o)),c=r.width,f=r.height,h=new te.Z({xmin:-.5,ymin:.5-f,xmax:c-.5,ymax:.5,spatialReference:i}),d=l?l.forwardTransform(h):h,!0,l&&(p=l.forwardCoefficients,p&&0===p[1]&&0===p[2]&&(l=null,h=d)),m=new Ne({data:{extent:d,nativeExtent:h,transform:l,pixelBlock:r,statistics:s,histograms:o,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:u}}),e.next=22,m.open();case 22:m.data=null,this._set("rasterInfo",m.rasterInfo),this._inMemoryRaster=m;case 25:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this._inMemoryRaster.fetchRawTile(e,t,r,n)}},{key:"_fetchData",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.request(this.url,{responseType:"array-buffer",signal:null===t||void 0===t?void 0:t.signal});case 2:if(r=e.sent,n=r.data,"JPG"===(i=(0,K.y)(n).toUpperCase())||"PNG"===i||"GIF"===i||"BMP"===i){e.next=7;break}throw new y.Z("image-aux-raster:open","the data is not a supported format");case 7:return this._set("datasetFormat",i),s=i.toLowerCase(),o="gif"===s||"bmp"===s||!(0,_.Z)("ios"),e.next=12,this.decodePixelBlock(n,{format:s,useCanvas:o,hasNoZlibMask:!0});case 12:if(null!=(l=e.sent)){e.next=15;break}throw new y.Z("image-aux-raster:open","the data cannot be decoded");case 15:return e.abrupt("return",l);case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchAuxiliaryData",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l,u,c,f,h,d;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=null===t||void 0===t?void 0:t.signal,s=null!==(r=this.ioConfig.skipExtensions)&&void 0!==r?r:[],o=s.includes("aux.xml")?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:i}),l=this.datasetFormat,c=(u="JPG"===l?"jgw":"PNG"===l?"pgw":"BMP"===l?"bpw":null)&&s.includes(u)?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+u,{responseType:"text",signal:i}),e.next=8,(0,b.as)([o,c]);case 8:if(f=e.sent,null===i||void 0===i||!i.aborted){e.next=11;break}throw(0,b.zE)();case 11:return(h=Ke(null===(n=f[0].value)||void 0===n?void 0:n.data)).transform||(d=f[1].value?f[1].value.data.split("\n").slice(0,6).map((function(e){return Number(e)})):null,h.transform=6===(null===d||void 0===d?void 0:d.length)?new Ue.Z({forwardCoefficients:[d[4],d[5],d[0],-d[1],d[2],-d[3]]}):null),e.abrupt("return",h);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),r}(ie);(0,p._)([(0,w.Cb)({type:String,json:{write:!0}})],Qe.prototype,"datasetFormat",void 0);var $e=Qe=(0,p._)([(0,R.j)("esri.layers.support.rasterDatasets.ImageAuxRaster")],Qe),et=r(92026),tt=r(35995),rt=r(34810),nt=r(3089),it=r(38045),at=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments))._levelOffset=0,e._tilemapCache=null,e._slices=null,e.datasetFormat="RasterTileServer",e.tileType=null,e}return(0,l.Z)(r,[{key:"open",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l,u,c,f,h,d,p,m,v,x,g,b,k,w,I,Z,_,S,R,T,C,M,F,O,D,B;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:if(l=null===t||void 0===t?void 0:t.signal,!this.sourceJSON){e.next=7;break}e.t0={data:this.sourceJSON},e.next=10;break;case 7:return e.next=9,this.request(this.url,{query:{f:"json"},signal:l});case 9:e.t0=e.sent;case 10:if((u=e.t0).ssl&&(this.url=this.url.replace(/^http:/i,"https:")),c=u.data,this.sourceJSON=c,c){e.next=15;break}throw new y.Z("imageserverraster:open","cannot initialize tiled image service, missing service info");case 15:if(c.tileInfo){e.next=17;break}throw new y.Z("imageserverraster:open","use ImageryLayer to open non-tiled image services");case 17:return this._fixScaleInServiceInfo(),f=["jpg","jpeg","png","png8","png24","png32","mixed"],this.tileType=c.cacheType,null==this.tileType&&(f.includes(c.tileInfo.format.toLowerCase())?this.tileType="Map":"lerc"===c.tileInfo.format.toLowerCase()?this.tileType="Elevation":this.tileType="Raster"),this.datasetName=null!==(r=null===(n=c.name)||void 0===n?void 0:n.slice(c.name.indexOf("/")+1))&&void 0!==r?r:"",e.next=22,this._fetchRasterInfo({signal:l});case 22:if(null!=(h=e.sent)){e.next=25;break}throw new y.Z("image-server-raster:open","cannot initialize image service");case 25:(0,it.n$)(h,c),d="Map"===this.tileType?st(c.tileInfo,c):W.Z.fromJSON(c.tileInfo),(0,et.O3)(d),p=this._computeMinMaxLOD(h,d),m=(0,P.Z)(p,2),v=m[0],x=m[1],g=h.extent,b=h.pixelSize,k=.5/h.width*b.x,w=Math.max(b.x,b.y),I=d.lods,("Map"!==this.tileType&&0!==c.maxScale||Math.abs(b.x-b.y)>k||!I.some((function(e){return Math.abs(e.resolution-w)<k})))&&(b.x=b.y=v.resolution,h.width=Math.ceil((g.xmax-g.xmin)/b.x-.1),h.height=Math.ceil((g.ymax-g.ymin)/b.y-.1)),Z=v.level-x.level,_=(0,P.Z)(d.size,2),S=_[0],R=_[1],T=[],C=[],I.forEach((function(e,t){e.level>=x.level&&e.level<=v.level&&T.push({x:e.resolution,y:e.resolution}),t<I.length-1&&C.push(Math.round(10*e.resolution/I[t+1].resolution)/10)})),T.sort((function(e,t){return e.x-t.x})),M=this.computeBlockBoundary(g,S,R,d.origin,T,Z),F=T.length>1?T.slice(1):null,c.transposeInfo&&(O={tileSize:[c.transposeInfo.rows,c.transposeInfo.cols],packetSize:null!==(i=null===(s=h.keyProperties)||void 0===s?void 0:s._yxs.PacketSize)&&void 0!==i?i:0}),D=C.length<=1||C.length>=3&&C.slice(0,-1).every((function(e){return e===C[0]}))?null!==(o=C[0])&&void 0!==o?o:2:Math.round(10/Math.pow(x.resolution/v.resolution,-1/Z))/10,h.storageInfo=new U.Z({blockWidth:d.size[0],blockHeight:d.size[1],pyramidBlockWidth:d.size[0],pyramidBlockHeight:d.size[1],pyramidResolutions:F,pyramidScalingFactor:D,compression:d.format,origin:d.origin,firstPyramidLevel:1,maximumPyramidLevel:Z,tileInfo:d,transposeInfo:O,blockBoundary:M}),this._fixGCSShift(h),this._set("rasterInfo",h),c.capabilities.toLowerCase().includes("tilemap")&&(B={tileInfo:h.storageInfo.tileInfo,parsedUrl:(0,tt.mN)(this.url),url:this.url,tileServers:[]},this._tilemapCache=new rt.y({layer:B}));case 36:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s,o,l,u,c,f,h,d,p,m,v,y,x,g,b,k,w,I,Z,_,S,R,T,C,M,F,P,O=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=O.length>3&&void 0!==O[3]?O[3]:{},s=this.rasterInfo,o=s.storageInfo,l=s.extent,u=o.transposeInfo,c=null!=u&&!!i.transposedVariableName,!this._slices||c||null!=i.sliceId){e.next=4;break}return e.abrupt("return",null);case 4:return f=c?0:o.maximumPyramidLevel-t+this._levelOffset,h="".concat(this.url,"/tile/").concat(f,"/").concat(r,"/").concat(n),d=this._slices?c?{variable:i.transposedVariableName}:{sliceId:i.sliceId||0}:null,e.next=9,this.request(h,{query:d,responseType:"array-buffer",signal:i.signal});case 9:if(p=e.sent,m=p.data){e.next=13;break}return e.abrupt("return",null);case 13:return v=c?u.tileSize:o.tileInfo.size,e.next=16,this.decodePixelBlock(m,{width:v[0],height:v[1],planes:null,pixelType:null,isPoint:"Elevation"===this.tileType,returnInterleaved:c,noDataValue:this.rasterInfo.noDataValue});case 16:if(null!=(y=e.sent)){e.next=19;break}return e.abrupt("return",null);case 19:if(x=o.blockBoundary[t],!("jpg"!==o.compression||n>x.minCol&&n<x.maxCol&&r>x.minRow&&r<x.maxRow)){e.next=22;break}return e.abrupt("return",y);case 22:return g=o.origin,b=o.blockWidth,k=o.blockHeight,w=this.getPyramidPixelSize(t),I=w.x,Z=w.y,_=Math.round((l.xmin-g.x)/I)%b,S=Math.round((l.xmax-g.x)/I)%b||b,R=Math.round((g.y-l.ymax)/Z)%k,T=Math.round((g.y-l.ymin)/Z)%k||k,C=n===x.minCol?_:0,M=r===x.minRow?R:0,F=n===x.maxCol?S:b,P=r===x.maxRow?T:k,e.abrupt("return",((0,Q.pW)(y,{x:C,y:M},{width:F-C,height:P-M}),y));case 24:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"getSliceIndex",value:function(e){if(!this._slices||null==e||0===e.length)return null;for(var t=e,r=0;r<this._slices.length;r++){var n=this._slices[r].multidimensionalDefinition;if(n.length===t.length&&!n.some((function(e){var r=t.find((function(t){return e.variableName===t.variableName&&t.dimensionName===e.dimensionName}));return!r||(Array.isArray(e.values[0])?"".concat(e.values[0][0],"-").concat(e.values[0][1]):e.values[0])!==(Array.isArray(r.values[0])?"".concat(r.values[0][0],"-").concat(r.values[0][1]):r.values[0])})))return r}return null}},{key:"fetchVariableStatisticsHistograms",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,i,s,o;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.request(this.url+"/statistics",{query:{variable:t,f:"json"},signal:r}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.statistics})),s=this.request(this.url+"/histograms",{query:{variable:t,f:"json"},signal:r}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.histograms})),e.next=4,Promise.all([i,s]);case 4:return o=e.sent,e.abrupt("return",(o[0]&&o[0].forEach((function(e){e.avg=e.mean,e.stddev=e.standardDeviation})),null!==(n=o[1])&&void 0!==n&&null!==(n=n[0])&&void 0!==n&&null!==(n=n.counts)&&void 0!==n&&n.length||(o[1]=null),{statistics:o[0]||null,histograms:o[1]||null}));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"computeBestPyramidLevelForLocation",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l,u=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>1&&void 0!==u[1]?u[1]:{},this._tilemapCache){e.next=3;break}return e.abrupt("return",0);case 3:if(null!==(n=this.identifyPixelLocation(t,0,r.datumTransformation))){e.next=6;break}return e.abrupt("return",null);case 6:i=0,s=this.rasterInfo.storageInfo.maximumPyramidLevel,o=s-i+this._levelOffset,l=n.srcLocation;case 10:if(!(o>=0)){e.next=25;break}return e.prev=11,e.next=14,this._tilemapCache.fetchAvailability(o,n.row,n.col,r);case 14:if(e.t0=e.sent,"available"!==e.t0){e.next=17;break}return e.abrupt("break",25);case 17:e.next=21;break;case 19:e.prev=19,e.t1=e.catch(11);case 21:if(o--,i++,null!==(n=this.identifyPixelLocation(l,i,r.datumTransformation))){e.next=23;break}return e.abrupt("return",null);case 23:e.next=10;break;case 25:return e.abrupt("return",-1===o||null==n?null:i);case 26:case"end":return e.stop()}}),e,this,[[11,19]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchRasterInfo",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l,u,c,f,h;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.sourceJSON,"Map"!==this.tileType){e.next=4;break}return n=r.fullExtent||r.extent,i=Math.ceil((n.xmax-n.xmin)/r.pixelSizeX-.1),s=Math.ceil((n.ymax-n.ymin)/r.pixelSizeY-.1),o=we.Z.fromJSON(r.spatialReference||n.spatialReference),l=new re.Z({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:o}),e.abrupt("return",new Fe.Z({width:i,height:s,bandCount:3,extent:te.Z.fromJSON(n),spatialReference:o,pixelSize:l,pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}}));case 4:return u=t.signal,c=(0,it.gh)(this.url,this.sourceJSON,{signal:u,query:this.ioConfig.customFetchParameters}),f=r.hasMultidimensions?this.request("".concat(this.url,"/slices"),{query:{f:"json"},signal:u}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.slices})).catch((function(){return null})):null,e.next=9,Promise.all([c,f]);case 9:return h=e.sent,e.abrupt("return",(this._slices=h[1],h[0]));case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fixScaleInServiceInfo",value:function(){var e=this.sourceJSON;e.minScale&&e.minScale<0&&(e.minScale=0),e.maxScale&&e.maxScale<0&&(e.maxScale=0)}},{key:"_fixGCSShift",value:function(e){var t=e.extent,r=e.spatialReference;t.xmin>-1&&t.xmax>181&&(null===r||void 0===r?void 0:r.wkid)&&r.isGeographic&&(e.nativeExtent=e.extent,e.transform=new nt.Z,e.extent=e.transform.forwardTransform(t))}},{key:"_computeMinMaxLOD",value:function(e,t){var r,n,i,a=e.pixelSize,s=.5/e.width*a.x,o=t.lods,l=t.lodAt(Math.max.apply(null,o.map((function(e){return e.level})))),u=t.lodAt(Math.min.apply(null,o.map((function(e){return e.level})))),c=this.tileType;if("Map"===c)return this._levelOffset=o[0].level,[l,u];if("Raster"===c)return[null!==(i=o.find((function(e){return e.resolution===a.x})))&&void 0!==i?i:l,u];var f=this.sourceJSON,h=f.minScale,d=f.maxScale,p=l;d>0&&(p=o.find((function(e){return Math.abs(e.scale-d)<s})),p||(p=null!==(r=o.filter((function(e){return e.scale>d})).sort((function(e,t){return e.scale>t.scale?1:-1}))[0])&&void 0!==r?r:l));var m=u;return h>0&&(m=null!==(n=o.find((function(e){return Math.abs(e.scale-h)<s})))&&void 0!==n?n:u,this._levelOffset=m.level-u.level),[p,m]}}]),r}(ie);function st(e,t){if(!e)return null;var r=t.minScale,n=t.maxScale,a=t.minLOD,s=t.maxLOD;if(null!=a&&null!=s)return W.Z.fromJSON((0,i.Z)((0,i.Z)({},e),{},{lods:e.lods.filter((function(e){var t=e.level;return null!=t&&t>=a&&t<=s}))}));if(0!==r&&0!==n){var o=function(e){return Math.round(1e4*e)/1e4},l=r?o(r):1/0,u=n?o(n):-1/0;return W.Z.fromJSON((0,i.Z)((0,i.Z)({},e),{},{lods:e.lods.filter((function(e){var t=o(e.scale);return t<=l&&t>=u}))}))}return W.Z.fromJSON(e)}(0,p._)([(0,w.Cb)({type:String,json:{write:!0}})],at.prototype,"datasetFormat",void 0),(0,p._)([(0,w.Cb)()],at.prototype,"tileType",void 0);var ot=at=(0,p._)([(0,R.j)("esri.layers.support.rasterDatasets.ImageServerRaster")],at),lt=r(60263),ut=new Map;ut.set("Int8","s8"),ut.set("UInt8","u8"),ut.set("Int16","s16"),ut.set("UInt16","u16"),ut.set("Int32","s32"),ut.set("UInt32","u32"),ut.set("Float32","f32"),ut.set("Float64","f32"),ut.set("Double64","f32");var ct=new Map;ct.set("none",{blobExtension:".til",isOneSegment:!0,decoderFormat:"bip"}),ct.set("lerc",{blobExtension:".lrc",isOneSegment:!1,decoderFormat:"lerc"}),ct.set("deflate",{blobExtension:".pzp",isOneSegment:!0,decoderFormat:"deflate"}),ct.set("jpeg",{blobExtension:".pjg",isOneSegment:!0,decoderFormat:"jpg"});var ft=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments))._files=null,e._storageIndex=null,e.datasetFormat="MRF",e}return(0,l.Z)(r,[{key:"open",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l,u,c,f,h,d,p,m,v,y,x,g,b,k,w,I,Z;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),n=t?t.signal:null,e.next=6,this.request(this.url,{responseType:"xml",signal:n});case 6:if(i=e.sent,s=this._parseHeader(i.data),o=s.rasterInfo,l=s.files,-1!==(null===(r=this.ioConfig.skipExtensions)||void 0===r?void 0:r.indexOf("aux.xml"))){e.next=15;break}return e.next=13,this._fetchAuxiliaryData(t);case 13:null!=(c=e.sent)&&(o.statistics=null!==(u=c.statistics)&&void 0!==u?u:o.statistics,o.histograms=c.histograms,c.histograms&&null==o.statistics&&(o.statistics=(0,ye.Oh)(c.histograms)));case 15:return this._set("rasterInfo",o),this._files=l,e.next=18,this.request(l.index,{responseType:"array-buffer",signal:n});case 18:for(f=e.sent,this._storageIndex=this._parseIndex(f.data),h=this.rasterInfo.storageInfo,d=h.blockWidth,p=h.blockHeight,m=this.rasterInfo.storageInfo.pyramidScalingFactor,v=this.rasterInfo,y=v.width,x=v.height,g=[],b=this._getBandSegmentCount(),k=0,w=-1;k<this._storageIndex.length;)w++,I=Math.ceil(y/d/Math.pow(m,w))-1,Z=Math.ceil(x/p/Math.pow(m,w))-1,k+=(I+1)*(Z+1)*b*4,g.push({maxRow:Z,maxCol:I,minCol:0,minRow:0});this.rasterInfo.storageInfo.blockBoundary=g,w>0&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=w),this.updateTileInfo();case 24:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s,o,l,u,c,f,h,d,p,m,v,y,x,g,b,k,w,I,Z,_,S,R,T,C,M,F,P,O,D,B=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=B.length>3&&void 0!==B[3]?B[3]:{},s=this.rasterInfo.storageInfo,o=s.blockWidth,l=s.blockHeight,u=s.blockBoundary,!(!(c=u[t])||c.maxRow<r||c.maxCol<n||c.minRow>r||c.minCol>n)){e.next=4;break}return e.abrupt("return",null);case 4:if(f=this.rasterInfo,h=f.bandCount,d=f.pixelType,p=this._getTileLocation(t,r,n),m=p.ranges,v=p.actualTileWidth,y=p.actualTileHeight,m&&0!==m.length){e.next=7;break}return e.abrupt("return",null);case 7:if(0!==m[0].from||0!==m[0].to){e.next=10;break}return x=new Uint8Array(o*l),e.abrupt("return",new ue.Z({width:o,height:l,pixels:null,mask:x,validPixelCount:0}));case 10:for(g=this.ioConfig.bandIds,b=this._getBandSegmentCount(),k=[],w=0,w=0;w<b;w++)g&&!g.includes(w)||k.push(this.request(this._files.data,{range:{from:m[w].from,to:m[w].to},responseType:"array-buffer",signal:i.signal}));return e.next=15,Promise.all(k);case 15:for(I=e.sent,Z=I.map((function(e){return e.data.byteLength})).reduce((function(e,t){return e+t})),_=new Uint8Array(Z),S=0,w=0;w<b;w++)_.set(new Uint8Array(I[w].data),S),S+=I[w].data.byteLength;return R=ct.get(this.rasterInfo.storageInfo.compression).decoderFormat,e.next=23,this.decodePixelBlock(_.buffer,{width:o,height:l,format:R,planes:(null===g||void 0===g?void 0:g.length)||h,pixelType:d});case 23:if(null!=(T=e.sent)){e.next=26;break}return e.abrupt("return",null);case 26:if(null!=(C=this.rasterInfo.noDataValue)&&"lerc"!==R&&!T.mask&&null!=(C=C[0])){if(M=T.width*T.height,F=new Uint8Array(M),Math.abs(C)>1e24)for(w=0;w<M;w++)Math.abs((T.pixels[0][w]-C)/C)>1e-6&&(F[w]=1);else for(w=0;w<M;w++)T.pixels[0][w]!==C&&(F[w]=1);T.mask=F}if(P=0,O=0,v!==o||y!==l)if(D=T.mask)for(w=0;w<l;w++)if(O=w*o,w<y)for(P=v;P<o;P++)D[O+P]=0;else for(P=0;P<o;P++)D[O+P]=0;else for(D=new Uint8Array(o*l),T.mask=D,w=0;w<y;w++)for(O=w*o,P=0;P<v;P++)D[O+P]=1;return e.abrupt("return",T);case 31:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_parseIndex",value:function(e){if(e.byteLength%16>0)throw new Error("invalid array buffer must be multiples of 16");var t,r,n,i,a,s;if(lt.f){for(r=new Uint8Array(e),i=new ArrayBuffer(e.byteLength),n=new Uint8Array(i),a=0;a<e.byteLength/4;a++)for(s=0;s<4;s++)n[4*a+s]=r[4*a+3-s];t=new Uint32Array(i)}else t=new Uint32Array(e);return t}},{key:"_getBandSegmentCount",value:function(){return ct.get(this.rasterInfo.storageInfo.compression).isOneSegment?1:this.rasterInfo.bandCount}},{key:"_getTileLocation",value:function(e,t,r){var n,i,a,s=this.rasterInfo.storageInfo,o=s.blockWidth,l=s.blockHeight,u=s.pyramidScalingFactor,c=this.rasterInfo,f=c.width,h=c.height,d=this._getBandSegmentCount(),p=0,m=0;for(a=0;a<e;a++)m=Math.pow(u,a),p+=(n=Math.ceil(f/o/m))*(i=Math.ceil(h/l/m));m=Math.pow(u,e),n=Math.ceil(f/o/m),i=Math.ceil(h/l/m),p+=t*n+r,p*=4*d;for(var v=this._storageIndex.subarray(p,p+4*d),y=0,x=0,g=[],b=0;b<d;b++)x=(y=v[4*b]*Math.pow(2,32)+v[4*b+1])+v[4*b+2]*Math.pow(2,32)+v[4*b+3],g.push({from:y,to:x});return{ranges:g,actualTileWidth:r<n-1?o:Math.ceil(f/m)-o*(n-1),actualTileHeight:t<i-1?l:Math.ceil(h/m)-l*(i-1)}}},{key:"_parseHeader",value:function(e){var t=Le(e,"MRF_META/Raster");if(!t)throw new y.Z("mrf:open","not a valid MRF format");var r=Le(t,"Size"),n=parseInt(r.getAttribute("x"),10),i=parseInt(r.getAttribute("y"),10),a=parseInt(r.getAttribute("c"),10),s=(We(t,"Compression")||"none").toLowerCase();if(!ct.has(s))throw new y.Z("mrf:open","currently does not support compression "+s);var o=We(t,"DataType")||"UInt8",l=ut.get(o);if(null==l)throw new y.Z("mrf:open","currently does not support pixel type "+o);var u,c,f=Le(t,"PageSize"),h=parseInt(f.getAttribute("x"),10),d=parseInt(f.getAttribute("y"),10),p=Le(t,"DataValues");if(p&&(null!=(c=p.getAttribute("NoData"))&&(u=c.trim().split(" ").map((function(e){return parseFloat(e)})))),Le(e,"MRF_META/CachedSource"))throw new y.Z("mrf:open","currently does not support MRF referencing other data files");var m,v=Le(e,"MRF_META/GeoTags"),x=Le(v,"BoundingBox"),g=!1;if(null!=x){var b,k=parseFloat(x.getAttribute("minx")),w=parseFloat(x.getAttribute("miny")),I=parseFloat(x.getAttribute("maxx")),Z=parseFloat(x.getAttribute("maxy")),_=We(v,"Projection")||"",S=we.Z.WGS84;if("LOCAL_CS[]"!==_)if(_.toLowerCase().startsWith("epsg:")){var R=Number(_.slice(5));isNaN(R)||0===R||(S=new we.Z({wkid:R}))}else S=null!==(b=Ye(_))&&void 0!==b?b:we.Z.WGS84;else g=!0,S=new we.Z({wkid:3857});(m=new te.Z(k,w,I,Z)).spatialReference=S}else g=!0,m=new te.Z({xmin:-.5,ymin:.5-i,xmax:n-.5,ymax:.5,spatialReference:new we.Z({wkid:3857})});var T=Le(e,"MRF_META/Rsets"),C=parseInt((null===T||void 0===T?void 0:T.getAttribute("scale"))||"2",10),M=m.spatialReference,F=new U.Z({origin:new re.Z({x:m.xmin,y:m.ymax,spatialReference:M}),blockWidth:h,blockHeight:d,pyramidBlockWidth:h,pyramidBlockHeight:d,compression:s,pyramidScalingFactor:C}),P=new re.Z({x:m.width/n,y:m.height/i,spatialReference:M}),O=new Fe.Z({width:n,height:i,extent:m,isPseudoSpatialReference:g,spatialReference:M,bandCount:a,pixelType:l,pixelSize:P,noDataValue:u,storageInfo:F}),D=We(e,"datafile"),B=We(e,"IndexFile");return{rasterInfo:O,files:{mrf:this.url,index:B||this.url.replace(".mrf",".idx"),data:D||this.url.replace(".mrf",ct.get(s).blobExtension)}}}},{key:"_fetchAuxiliaryData",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".aux.xml",{responseType:"xml",signal:null===t||void 0===t?void 0:t.signal});case 3:return r=e.sent,n=r.data,e.abrupt("return",Ke(n));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(t){return e.apply(this,arguments)}}()}]),r}(ie);(0,p._)([(0,w.Cb)()],ft.prototype,"_files",void 0),(0,p._)([(0,w.Cb)()],ft.prototype,"_storageIndex",void 0),(0,p._)([(0,w.Cb)({type:String,json:{write:!0}})],ft.prototype,"datasetFormat",void 0);var ht=ft=(0,p._)([(0,R.j)("esri.layers.support.rasterIO.MRFRaster")],ft),dt=r(58424),pt=r(92217),mt=function(e,t){var r;return null===(r=e.get(t))||void 0===r?void 0:r.values},vt=function(e,t){var r;return null===(r=e.get(t))||void 0===r||null===(r=r.values)||void 0===r?void 0:r[0]},yt=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments))._files=null,e._headerInfo=null,e._bufferSize=1048576,e.datasetFormat="TIFF",e}return(0,l.Z)(r,[{key:"open",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,s,o,l,u,c,f,h,d,p,m,v,g,b,k,w,I,Z;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return s=t?t.signal:null,e.next=5,this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:s});case 5:if(o=e.sent,l=o.data){e.next=9;break}throw new y.Z("tiffraster:open","failed to open url "+this.url);case 9:return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1,this.url.lastIndexOf(".")),u=(0,dt.cK)(l),c=u.littleEndian,f=u.firstIFDPos,h=u.isBigTiff,d=[],e.next=13,this._readIFDs(d,l,c,f,0,h?8:4,s);case 13:if(p=this._parseIFDs(d),m=p.imageInfo,v=p.rasterInfo,g=(0,dt.ee)(d),b=(0,dt.I7)(d),this._headerInfo=(0,i.Z)({littleEndian:c,isBigTiff:h,ifds:d,pyramidIFDs:g,maskIFDs:b},m),this._set("rasterInfo",v),m.isSupported){e.next=16;break}throw new y.Z("tiffraster:open","this tiff is not supported: "+m.message);case 16:if(m.tileWidth){e.next=18;break}throw new y.Z("tiffraster:open","none-tiled tiff is not optimized for access, convert to COG and retry.");case 18:if(v.isPseudoSpatialReference&&x.Z.getLogger(this).warn("The spatial reference for this tiff is unsupported. Only EPSG spatial reference codes and Esri WKTs are supported."),k=null===(r=d[0].get("PREDICTOR"))||void 0===r||null===(r=r.values)||void 0===r?void 0:r[0],3!==(null===(n=d[0].get("SAMPLEFORMAT"))||void 0===n||null===(n=n.values)||void 0===n?void 0:n[0])||2!==k){e.next=22;break}throw new y.Z("tiffraster:open","unsupported horizontal difference encoding. Predictor=3 is supported for floatting point data");case 22:if(w=this.ioConfig.skipExtensions,(I=void 0===w?[]:w).includes("aux.xml")){e.next=28;break}return e.next=26,this._fetchAuxiliaryMetaData(t);case 26:null!=(Z=e.sent)&&this._processPAMInfo(Z,v);case 28:if(e.t0=I.includes("vat.dbf")||1!==v.bandCount||"u8"!==v.pixelType,e.t0){e.next=34;break}return e.next=32,this._fetchAuxiliaryTable(t);case 32:v.attributeTable=e.sent,null!=v.attributeTable&&(v.keyProperties.DataType="thematic");case 34:this.updateTileInfo();case 35:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s,o,l,u=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=u.length>3&&void 0!==u[3]?u[3]:{},null!==(i=this._headerInfo)&&void 0!==i&&i.isSupported&&!this.isBlockOutside(t,r,n)){e.next=3;break}return e.abrupt("return",null);case 3:return e.next=5,this._fetchRawTiffTile(t,r,n,!1,s);case 5:if(null==(o=e.sent)||!this._headerInfo.hasMaskBand){e.next=11;break}return e.next=9,this._fetchRawTiffTile(t,r,n,!0,s);case 9:null!=(l=e.sent)&&l.pixels[0]instanceof Uint8Array&&(o.mask=l.pixels[0]);case 11:return e.abrupt("return",o);case 12:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_parseIFDs",value:function(e){var t,r,n=(0,dt.FI)(e),a=n.width,s=n.height,o=n.tileWidth,l=n.tileHeight,u=n.planes,c=n.pixelType,f=n.compression,h=n.firstPyramidLevel,d=n.maximumPyramidLevel,p=n.pyramidBlockWidth,m=n.pyramidBlockHeight,v=n.tileBoundary,y=n.affine,x=n.metadata,g=Ye((null===(t=n.extent.spatialReference)||void 0===t?void 0:t.wkt)||(null===(r=n.extent.spatialReference)||void 0===r?void 0:r.wkid)),b=!!n.isPseudoGeographic;null==g&&(b=!0,g=new we.Z({wkid:3857}));var k=new te.Z((0,i.Z)((0,i.Z)({},n.extent),{},{spatialReference:g})),w=new re.Z(k?{x:k.xmin,y:k.ymax,spatialReference:g}:{x:0,y:0}),I=new U.Z({blockWidth:o,blockHeight:l,pyramidBlockWidth:p,pyramidBlockHeight:m,compression:f,origin:w,firstPyramidLevel:h,maximumPyramidLevel:d,blockBoundary:v}),Z=new re.Z({x:(k.xmax-k.xmin)/a,y:(k.ymax-k.ymin)/s,spatialReference:g}),_=x?{BandProperties:x.bandProperties,DataType:x.dataType}:{},S=null,R=vt(e[0],"PHOTOMETRICINTERPRETATION"),T=mt(e[0],"COLORMAP");if(R<=3&&(null===T||void 0===T?void 0:T.length)>3&&T.length%3==0){S=[];for(var C=T.length/3,M=0;M<C;M++)S.push([M,T[M]>>>8,T[M+C]>>>8,T[M+2*C]>>>8])}var F=new Fe.Z({width:a,height:s,bandCount:u,pixelType:c,pixelSize:Z,storageInfo:I,spatialReference:g,isPseudoSpatialReference:b,keyProperties:_,extent:k,colormap:S,statistics:x?x.statistics:null});return null!==y&&void 0!==y&&y.length&&(F.nativeExtent=new te.Z({xmin:-.5,ymin:.5-s,xmax:a-.5,ymax:.5,spatialReference:g}),F.transform=new Ue.Z({polynomialOrder:1,forwardCoefficients:[y[2]+y[0]/2,y[5]-y[3]/2,y[0],y[3],-y[1],-y[4]]}),F.extent=F.transform.forwardTransform(F.nativeExtent),F.pixelSize=new re.Z({x:(k.xmax-k.xmin)/a,y:(k.ymax-k.ymin)/s,spatialReference:g}),I.origin.x=-.5,I.origin.y=.5),{imageInfo:n,rasterInfo:F}}},{key:"_processPAMInfo",value:function(e,t){var r;if(t.statistics=null!==(r=e.statistics)&&void 0!==r?r:t.statistics,t.histograms=e.histograms,e.histograms&&null==t.statistics&&(t.statistics=(0,ye.Oh)(e.histograms)),e.transform&&null==t.transform){t.transform=e.transform,t.nativeExtent=t.extent;var n=t.transform.forwardTransform(t.nativeExtent);t.pixelSize=new re.Z({x:(n.xmax-n.xmin)/t.width,y:(n.ymax-n.ymin)/t.height,spatialReference:t.spatialReference}),t.extent=n}t.isPseudoSpatialReference&&e.spatialReference&&(t.spatialReference=e.spatialReference,t.extent.spatialReference=t.nativeExtent.spatialReference=t.storageInfo.origin.spatialReference=t.spatialReference)}},{key:"_readIFDs",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n,i,s){var o,l,u,c=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=c.length>5&&void 0!==c[5]?c[5]:4,l=c.length>6?c[6]:void 0,i){e.next=4;break}return e.abrupt("return",null);case 4:if(!(i>=r.byteLength||i<0)){e.next=10;break}return e.next=7,this.request(this.url,{range:{from:i+s,to:i+s+this._bufferSize},responseType:"array-buffer",signal:l});case 7:r=e.sent.data,s=i+s,i=0;case 10:return e.next=12,this._readIFD(r,n,i,s,pt.Z.tiffTags,o,l);case 12:if(u=e.sent,t.push(u.ifd),u.nextIFD){e.next=15;break}return e.abrupt("return",null);case 15:return e.next=17,this._readIFDs(t,r,n,u.nextIFD-s,s,o,l);case 17:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,a){return e.apply(this,arguments)}}()},{key:"_readIFD",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n,i){var s,o,l,u,c,f,h,d,p,m,v,y,x,g,b,k,w=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=w.length>4&&void 0!==w[4]?w[4]:pt.Z.tiffTags,o=w.length>5&&void 0!==w[5]?w[5]:4,l=w.length>6?w[6]:void 0,t){e.next=5;break}return e.abrupt("return",null);case 5:if(!(u=(0,dt.vr)(t,r,n,i,s,o)).success){e.next=25;break}if(h=[],null!==(c=u.ifd)&&void 0!==c&&c.forEach((function(e){e.values||h.push(e)})),!(h.length>0)){e.next=16;break}if(d=h.map((function(e){return e.offlineOffsetSize})).filter(Z.pC),p=Math.min.apply(null,d.map((function(e){return e[0]}))),!(Math.min.apply(null,d.map((function(e){return e[0]+e[1]})))-p<=this._bufferSize)){e.next=16;break}return e.next=13,this.request(this.url,{range:{from:p,to:p+this._bufferSize},responseType:"array-buffer",signal:l});case 13:m=e.sent,v=m.data,t=v,i=p,h.forEach((function(e){return(0,dt.Dq)(t,r,e,i)}));case 16:if(null===(f=u.ifd)||void 0===f||!f.has("GEOKEYDIRECTORY")){e.next=24;break}if(y=u.ifd.get("GEOKEYDIRECTORY"),!((x=null===y||void 0===y?void 0:y.values)&&x.length>4)){e.next=24;break}return g=x[0]+"."+x[1]+"."+x[2],e.next=22,this._readIFD(t,r,y.valueOffset+6-i,i,pt.Z.geoKeys,2,l);case 22:b=e.sent,y.data=b.ifd,y.data&&y.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[g]});case 24:return e.abrupt("return",u);case 25:if(!u.requiredBufferSize||u.requiredBufferSize===t.byteLength){e.next=30;break}return e.next=28,this.request(this.url,{range:{from:i,to:i+u.requiredBufferSize+4},responseType:"array-buffer",signal:l});case 28:return k=e.sent,e.abrupt("return",(t=k.data).byteLength<u.requiredBufferSize?null:this._readIFD(t,r,0,i,pt.Z.tiffTags,4,l));case 30:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_fetchRawTiffTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n,i){var s,o,l,u,c,f,h,d,p,m,v,y,x,g,b,k,w,I,Z,_,S,R,T,C,M=this,F=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=F.length>4&&void 0!==F[4]?F[4]:{},o=this._getTileLocation(t,r,n,i)){e.next=4;break}return e.abrupt("return",null);case 4:return l=o.ranges,u=o.actualTileWidth,c=o.actualTileHeight,f=o.ifd,h=l.map((function(e){return M.request(M.url,{range:e,responseType:"array-buffer",signal:s.signal})})),e.next=11,Promise.all(h);case 11:if(d=e.sent,p=d.map((function(e){return e.data.byteLength})).reduce((function(e,t){return e+t})),m=1===d.length?d[0].data:new ArrayBuffer(p),v=[0],y=[0],d.length>1)for(x=new Uint8Array(m),g=0,b=0;g<d.length;g++)k=d[g].data,x.set(new Uint8Array(k),b),v[g]=b,b+=k.byteLength,y[g]=k.byteLength;return w=this.getBlockWidthHeight(t),I=w.blockWidth,Z=w.blockHeight,e.next=22,this.decodePixelBlock(m,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:f,offsets:v,sizes:y},width:I,height:Z,planes:null,pixelType:null});case 22:if(null!=(_=e.sent)){e.next=25;break}return e.abrupt("return",null);case 25:if(u!==I||c!==Z)if(C=_.mask)for(S=0;S<Z;S++)if(T=S*I,S<c)for(R=u;R<I;R++)C[T+R]=0;else for(R=0;R<I;R++)C[T+R]=0;else for(C=new Uint8Array(I*Z),_.mask=C,S=0;S<c;S++)for(T=S*I,R=0;R<u;R++)C[T+R]=1;return e.abrupt("return",_);case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_getTileLocation",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=this.rasterInfo.storageInfo,a=i.firstPyramidLevel,s=i.blockBoundary,o=0===e?0:e-(a-1),l=this._headerInfo;if(!l)return null;var u=n?l.maskIFDs[o]:0===o?null===l||void 0===l?void 0:l.ifds[0]:null===l||void 0===l?void 0:l.pyramidIFDs[o-1];if(!u)return null;var c=(0,dt.If)(u,l),f=mt(u,"TILEOFFSETS");if(void 0===f)return null;var h=mt(u,"TILEBYTECOUNTS"),d=s[o],p=d.minRow,m=d.minCol,v=d.maxRow,y=d.maxCol;if(t>v||r>y||t<p||r<m)return null;var x=vt(u,"IMAGEWIDTH"),g=vt(u,"IMAGELENGTH"),b=vt(u,"TILEWIDTH"),k=vt(u,"TILELENGTH"),w=[];if(c)for(var I=this.rasterInfo.bandCount,Z=0;Z<I;Z++){var _=Z*(v+1)*(y+1)+t*(y+1)+r;w[Z]={from:f[_],to:f[_]+h[_]-1}}else{var S=t*(y+1)+r;w.push({from:f[S],to:f[S]+h[S]-1})}for(var R=0;R<w.length;R++)if(null==w[R].from||!w[R].to||w[R].to<0)return null;return{ranges:w,ifd:u,actualTileWidth:r===y&&x%b||b,actualTileHeight:t===v&&g%k||k}}},{key:"_fetchAuxiliaryMetaData",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".aux.xml",{responseType:"xml",signal:null===t||void 0===t?void 0:t.signal});case 3:return r=e.sent,n=r.data,e.abrupt("return",Ke(n));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchAuxiliaryTable",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".vat.dbf",{responseType:"array-buffer",signal:null===t||void 0===t?void 0:t.signal});case 3:return r=e.sent,n=r.data,i=De.parse(n),e.abrupt("return",null!==i&&void 0!==i&&i.recordSet?ae.Z.fromJSON(i.recordSet):null);case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",null);case 12:case"end":return e.stop()}}),e,this,[[0,9]])})));return function(t){return e.apply(this,arguments)}}()}]),r}(ie);(0,p._)([(0,w.Cb)()],yt.prototype,"_files",void 0),(0,p._)([(0,w.Cb)()],yt.prototype,"_headerInfo",void 0),(0,p._)([(0,w.Cb)()],yt.prototype,"_bufferSize",void 0),(0,p._)([(0,w.Cb)({type:String,json:{write:!0}})],yt.prototype,"datasetFormat",void 0);var xt=yt=(0,p._)([(0,R.j)("esri.layers.support.rasterDatasets.TIFFRaster")],yt),gt=new Map;gt.set("CRF",{desc:"Cloud Raster Format",constructor:Ee}),gt.set("MRF",{desc:"Meta Raster Format",constructor:ht}),gt.set("TIFF",{desc:"GeoTIFF",constructor:xt}),gt.set("RasterTileServer",{desc:"Raster Tile Server",constructor:ot}),gt.set("JPG",{desc:"JPG Raster Format",constructor:$e}),gt.set("PNG",{desc:"PNG Raster Format",constructor:$e}),gt.set("GIF",{desc:"GIF Raster Format",constructor:$e}),gt.set("BMP",{desc:"BMP Raster Format",constructor:$e});var bt=function(){function e(){(0,o.Z)(this,e)}return(0,l.Z)(e,null,[{key:"supportedFormats",get:function(){var e=new Set;return gt.forEach((function(t,r){return e.add(r)})),e}},{key:"open",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l,u,c,f,h;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.url,n=t.ioConfig,i=t.sourceJSON,null==(s=t.datasetFormat)&&r.lastIndexOf(".")&&(s=r.slice(r.lastIndexOf(".")+1).toUpperCase()),"OVR"===s||"TIF"===s?s="TIFF":"JPG"!==s&&"JPEG"!==s&&"JFIF"!==s||(s="JPG"),r.toLowerCase().includes("/imageserver")&&!r.toLowerCase().includes("/wcsserver")&&(s="RasterTileServer"),o={url:r,sourceJSON:i,datasetFormat:s,ioConfig:null!==n&&void 0!==n?n:{bandIds:null,sampling:null}},!s||!this.supportedFormats.has(s)){e.next=12;break}if("CRF"!==s||null!==n&&void 0!==n&&n.enableCRF){e.next=7;break}throw new y.Z("rasterfactory:open","cannot open raster: ".concat(r));case 7:return l=gt.get(s).constructor,u=new l(o),e.next=11,u.open({signal:t.signal});case 11:return e.abrupt("return",u);case 12:if(!s){e.next=14;break}throw new y.Z("rasterfactory:open","not a supported format "+s);case 14:return c=Array.from(gt.keys()),f=0,h=function e(){return(s=c[f++])&&("CRF"!==s||null!==n&&void 0!==n&&n.enableCRF)?(l=gt.get(s).constructor,(u=new l(o)).open({signal:t.signal}).then((function(){return u})).catch((function(){return e()}))):null},e.abrupt("return",h());case 18:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"register",value:function(e,t,r){gt.has(e.toUpperCase())||gt.set(e.toUpperCase(),{desc:t,constructor:r})}}]),e}(),kt=r(81085),wt=r(84933),It=function(e){(0,h.Z)(p,e);var t=(0,d.Z)(p);function p(){var e;(0,o.Z)(this,p);for(var n=arguments.length,i=new Array(n),l=0;l<n;l++)i[l]=arguments[l];return(e=t.call.apply(t,[this].concat(i)))._primaryRasters=[],e.bandIds=null,e.interpolation=null,e.legendEnabled=!0,e.isReference=null,e.listMode="show",e.sourceJSON=null,e.version=null,e.type="imagery-tile",e.operationalLayerType="ArcGISTiledImageServiceLayer",e.popupEnabled=!0,e.popupTemplate=null,e.fields=null,e._debouncedSaveOperations=(0,b.Ds)(function(){var t=(0,s.Z)((0,a.Z)().mark((function t(n,i,s){var o,l,c;return(0,a.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,r.e(3275).then(r.bind(r,63275));case 2:o=t.sent,l=o.save,c=o.saveAs,t.t0=n,t.next=t.t0===wt.x.SAVE?8:t.t0===wt.x.SAVE_AS?9:10;break;case 8:return t.abrupt("return",l((0,u.Z)(e),i));case 9:return t.abrupt("return",c((0,u.Z)(e),s,i));case 10:case"end":return t.stop()}}),t)})));return function(e,r,n){return t.apply(this,arguments)}}()),e}return(0,l.Z)(p,[{key:"normalizeCtorArgs",value:function(e,t){return"string"==typeof e?(0,i.Z)({url:e},t):e}},{key:"load",value:function(e){var t=this,r=null!=e?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},e).catch(b.r9).then((function(){return t._openRaster(r)}))),Promise.resolve(this)}},{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"rasterFields",get:function(){var e=[new Ce.Z({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"}),new Ce.Z({name:"Raster.ServicePixelValue.Raw",alias:"Raw Pixel Value",domain:null,editable:!1,length:50,type:"string"})],t=this.rasterInfo,r=null===t||void 0===t?void 0:t.attributeTable,i=null!=r?r.fields:null;if(i){var a=i.filter((function(e){return"oid"!==e.type&&"value"!==e.name.toLowerCase()})).map((function(e){var t=e.clone();return t.name="Raster."+e.name,t}));e.push.apply(e,(0,n.Z)(a))}var s=null===t||void 0===t?void 0:t.dataType,o=null===t||void 0===t?void 0:t.multidimensionalInfo;if(("vector-magdir"===s||"vector-uv"===s)&&null!=o){var l,u=null===(l=o.variables[0].unit)||void 0===l?void 0:l.trim(),c="Magnitude"+(u?" (".concat(u,")"):"");e.push(new Ce.Z({name:"Raster.Magnitude",alias:c,domain:null,editable:!1,type:"double"})),e.push(new Ce.Z({name:"Raster.Direction",alias:"Direction (\xb0)",domain:null,editable:!1,type:"double"}))}return e}},{key:"createPopupTemplate",value:function(e){var t=this.rasterFields,r=new Set(t.map((function(e){return e.name})).filter((function(e){return"raster.servicepixelvalue.raw"!==e.toLowerCase()})));return(0,kt.eZ)({fields:t,title:this.title},(0,i.Z)((0,i.Z)({},e),{},{visibleFieldNames:r}))}},{key:"generateRasterInfo",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,i,s,o,l;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=(0,I.TJ)(H.Z,t)){e.next=2;break}return e.abrupt("return",this.rasterInfo);case 2:return e.prev=2,s={raster:this._primaryRasters[0]},this._primaryRasters.length>1&&this._primaryRasters.forEach((function(e){return s[e.url]=e})),o=(0,ve.Ue)(null!==(n=null===(i=t.functionDefinition)||void 0===i?void 0:i.toJSON())&&void 0!==n?n:t.toJSON(),s),l=new oe({rasterFunction:o}),e.next=8,l.open(r);case 8:return e.abrupt("return",l.rasterInfo);case 11:if(e.prev=11,e.t0=e.catch(2),!(e.t0 instanceof y.Z)){e.next=15;break}throw e.t0;case 15:throw new y.Z("imagery-tile-layer","the given raster function is not supported");case 16:case"end":return e.stop()}}),e,this,[[2,11]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"save",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._debouncedSaveOperations(wt.x.SAVE,t));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"saveAs",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._debouncedSaveOperations(wt.x.SAVE_AS,r,t));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"write",value:function(e,t){var r,n=null!==(r=this._primaryRasters[0])&&void 0!==r?r:this.raster;if(this.loaded?"RasterTileServer"===n.datasetFormat&&("Raster"===n.tileType||"Map"===n.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))return(0,c.Z)((0,f.Z)(p.prototype),"write",this).call(this,e,t);if(null!==t&&void 0!==t&&t.messages){var i="".concat(t.origin,"/").concat(t.layerContainerType||"operational-layers");t.messages.push(new y.Z("layer:unsupported","Layers (".concat(this.title,", ").concat(this.id,") of type '").concat(this.declaredClass,"' are not supported in the context of '").concat(i,"'"),{layer:this}))}return null}},{key:"_openRaster",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,s,o,l,u,c,f,h,d,p,m,v,g=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=!1,!this.raster){e.next=10;break}if(e.t0=this.raster.rasterInfo,e.t0){e.next=6;break}return e.next=6,this.raster.open();case 6:"Function"===this.raster.datasetFormat?(r=!0,this._primaryRasters=this.raster.primaryRasters.rasters):this._primaryRasters=[this.raster],this.url=this.raster.url,e.next=35;break;case 10:return n=this.rasterFunction,s=[this.url],n&&(0,ve.G8)(n.toJSON(),s),e.next=14,Promise.all(s.map((function(e){return bt.open({url:e,sourceJSON:g.sourceJSON,ioConfig:(0,i.Z)((0,i.Z)({sampling:"closest"},g.ioConfig),{},{customFetchParameters:g.customParameters}),signal:t})})));case 14:if(o=e.sent,l=o.findIndex((function(e){return null==e})),!(l>-1)){e.next=18;break}throw new y.Z("imagery-tile-layer:open","cannot open raster: ".concat(s[l]));case 18:if(this._primaryRasters=o,!n){e.next=34;break}return f={raster:this._primaryRasters[0]},this._primaryRasters.length>1&&this._primaryRasters.forEach((function(e){return f[e.url]=e})),h=(0,ve.Ue)(null!==(u=null===(c=n.functionDefinition)||void 0===c?void 0:c.toJSON())&&void 0!==u?u:n.toJSON(),f),d=new oe({rasterFunction:h}),e.prev=22,e.next=25,d.open();case 25:this.raster=d,e.next=32;break;case 28:e.prev=28,e.t1=e.catch(22),p=x.Z.getLogger(this),e.t1 instanceof y.Z&&p.error("imagery-tile-layer:open",e.t1.message),p.warn("imagery-tile-layer:open","the raster function cannot be applied and is removed"),this._set("rasterFunction",null),this.raster=o[0];case 32:e.next=35;break;case 34:this.raster=o[0];case 35:if(m=this.raster.rasterInfo){e.next=38;break}throw new y.Z("imagery-tile-layer:load","cannot load resources on "+this.url);case 38:this._set("rasterInfo",r?m:this._primaryRasters[0].rasterInfo),this._set("spatialReference",m.spatialReference),this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,null!=this.sourceJSON?(v="Map"===this.raster.tileType&&null!=this.sourceJSON.minLOD&&null!=this.sourceJSON.maxLOD?this.sourceJSON:(0,i.Z)((0,i.Z)({},this.sourceJSON),{},{minScale:0,maxScale:0}),this.read(v,{origin:"service"})):this.read({tileInfo:this.rasterInfo.storageInfo.tileInfo.toJSON()},{origin:"service"}),this.title||(this.title=this.raster.datasetName),"Map"===this.raster.tileType&&(this.popupEnabled=!1),this._configDefaultSettings(),this.addHandles((0,k.YP)((function(){return g.customParameters}),(function(e){g.raster&&(g.raster.ioConfig.customFetchParameters=e)})));case 40:case"end":return e.stop()}}),e,this,[[22,28]])})));return function(t){return e.apply(this,arguments)}}()}]),p}((0,M.h)((0,Re.M)((0,Ze.q)((0,_e.I)((0,F.N)(function(e){var t=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e,r;(0,o.Z)(this,n);for(var i=arguments.length,a=new Array(i),s=0;s<i;s++)a[s]=arguments[s];return(r=t.call.apply(t,[this].concat(a)))._isConstructedFromFunctionRaster=!1,r._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},r.bandIds=null,r.copyright=null,r.interpolation="nearest",r.multidimensionalSubset=null,r.raster=null,r.rasterInfo=null,r.sourceJSON=null,r.spatialReference=null,r.symbolizer=null,r._isConstructedFromFunctionRaster="Function"===(null===(e=a[0])||void 0===e||null===(e=e.raster)||void 0===e?void 0:e.datasetFormat),r}return(0,l.Z)(n,[{key:"fullExtent",get:function(){var e;return null===(e=this.rasterInfo)||void 0===e?void 0:e.extent}},{key:"multidimensionalDefinition",set:function(e){this._set("multidimensionalDefinition",e),this.updateRenderer()}},{key:"rasterFunction",set:function(e){var t;"none"===(null===(t=e)||void 0===t||null===(t=t.functionName)||void 0===t?void 0:t.toLowerCase())&&(e=void 0),this._set("rasterFunction",e),this.updateRasterFunction()}},{key:"url",set:function(e){this._set("url",(0,A.Nm)(e,Ie))}},{key:"renderer",set:function(e){null==e&&null==this.rasterFunction?this._configDefaultRenderer("override"):(this._set("renderer",e),this.updateRenderer())}},{key:"readRenderer",value:function(e,t,r){var n,i=null===t||void 0===t||null===(n=t.layerDefinition)||void 0===n||null===(n=n.drawingInfo)||void 0===n?void 0:n.renderer;return(0,O.ij)(i,r)||void 0}},{key:"convertVectorFieldData",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t&&this.rasterInfo){e.next=2;break}return e.abrupt("return",null);case 2:return n=this._rasterJobHandler.instance,i=this.rasterInfo.dataType,e.abrupt("return",n?n.convertVectorFieldData({pixelBlock:t,dataType:i},r):(0,ee.KC)(t,i));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"computeStatisticsHistograms",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,s,o,l,u,c,f,h,d,p,m,v,x;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=(0,I.TJ)(be.Z,t).clone(),s=this.rasterInfo,null!=(o=t.geometry)){e.next=4;break}throw new y.Z("imagery-tile-mixin:compute-statistics-histograms","geometry must be specified");case 4:if(l=o,u=s.spatialReference,e.t0=o.spatialReference.equals(u),e.t0){e.next=11;break}return e.next=10,(0,$.zD)();case 10:l="extent"===o.type?(0,$.tB)(o,u):(0,$.Wt)(o,u);case 11:return c=null!==(n=t.pixelSize)&&void 0!==n?n:new re.Z({x:s.pixelSize.x,y:s.pixelSize.y,spatialReference:u}),f=me(s,l,c),h=f.extent,d=f.width,p=f.height,e.next=18,this.fetchPixels(h,d,p,(0,i.Z)((0,i.Z)({},r),{},{interpolation:"nearest"}));case 18:if(null!=(m=e.sent).pixelBlock){e.next=21;break}throw new y.Z("imagery-tile-mixin:compute-statistics-histograms","failed to fetch pixels");case 21:return e.next=23,ce(m.pixelBlock,h,l);case 23:return v=e.sent,x=this._rasterJobHandler.instance,e.abrupt("return",x?x.computeStatisticsHistograms({pixelBlock:v},r):(0,ye.js)(v));case 26:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"createFlowMesh",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._rasterJobHandler.instance,e.abrupt("return",n?n.createFlowMesh(t,r):(0,ke.GE)(t.meshType,t.simulationSettings,t.flowData,null!=r.signal?r.signal:(new AbortController).signal));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"normalizeRasterFetchOptions",value:function(e){var t,r,n=(null!==(t=this.rasterInfo)&&void 0!==t?t:{}).multidimensionalInfo;if(null==n)return e;var a=e.multidimensionalDefinition||this.multidimensionalDefinition;(null===(r=a)||void 0===r?void 0:r.length)||(a=(0,V.Tj)(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset}));var s=e.timeExtent||this.timeExtent;if(null!=a&&null!=s&&(null!=s.start||null!=s.end)){var o;a=a.map((function(e){return e.clone()}));var l=null===(o=n.variables.find((function(e){return e.name===a[0].variableName})))||void 0===o||null===(o=o.dimensions)||void 0===o?void 0:o.find((function(e){return"StdTime"===e.name})),u=a.find((function(e){return"StdTime"===e.dimensionName}));if(!l||!u)return(0,i.Z)((0,i.Z)({},e),{},{multidimensionalDefinition:null});var c=s.start,f=s.end,h=null==c?null:c.getTime(),d=null==f?null:f.getTime(),p=null!==h&&void 0!==h?h:d,m=null!==d&&void 0!==d?d:h;if(null!=l.values){var v=l.values.filter((function(e){if(Array.isArray(e)){if(p===m)return e[0]<=p&&e[1]>=p;var t=e[0]<=p&&e[1]>p||e[0]<m&&e[1]>=m,r=e[0]>=p&&e[1]<=m||e[0]<p&&e[1]>m;return t||r}return p===m?e===p:e>=p&&e<=m}));if(v.length){var y=v.sort((function(e,t){var r=Array.isArray(e)?e[0]:e,n=Array.isArray(e)?e[1]:e,i=Array.isArray(t)?t[0]:t,a=Array.isArray(t)?t[1]:t;return p===m?r-i:Math.abs(n-m)-Math.abs(a-m)}))[0];u.values=[y]}else a=null}else if(l.hasRegularIntervals&&l.extent){var x=(0,P.Z)(l.extent,2),g=x[0],b=x[1];p>b||m<g?a=null:u.values=p===m?[p]:[Math.max(g,p),Math.min(b,m)]}}return null!=a&&(0,V.nb)(a,this.multidimensionalSubset)?(0,i.Z)((0,i.Z)({},e),{},{multidimensionalDefinition:null}):(0,i.Z)((0,i.Z)({},e),{},{multidimensionalDefinition:a})}},{key:"updateRasterFunction",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(){var t,r,n,i,s,o,l,u,c,f,h,d,p,m,v;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.loaded&&"imagery-tile"===this.type&&(this.rasterFunction||this._cachedRasterFunctionJson)&&JSON.stringify(this.rasterFunction)!==JSON.stringify(this._cachedRasterFunctionJson)){e.next=2;break}return e.abrupt("return");case 2:if(!this._isConstructedFromFunctionRaster||"Function"!==this.raster.datasetFormat){e.next=5;break}return r=this.raster.rasterFunction.toJSON(),e.abrupt("return",(!this.rasterFunction&&r&&this._set("rasterFunction",H.Z.fromJSON(r)),void(this._cachedRasterFunctionJson=null===(t=this.rasterFunction)||void 0===t?void 0:t.toJSON())));case 5:if(i=this.raster,s=!1,"Function"===i.datasetFormat?(n=i.primaryRasters.rasters,i=n[0],s=!0):n=[i],!(o=this.rasterFunction)){e.next=19;break}return f={raster:i},n.length>1&&n.forEach((function(e){return f[e.url]=e})),h=(0,ve.Ue)(null!==(l=null===(u=o.functionDefinition)||void 0===u?void 0:u.toJSON())&&void 0!==l?l:o.toJSON(),f),(d=new oe({rasterFunction:h})).rasterJobHandler=this._rasterJobHandler.instance,e.next=15,d.open();case 15:this._cachedRasterFunctionJson=null===(c=this.rasterFunction)||void 0===c?void 0:c.toJSON(),this.raster=d,e.next=23;break;case 19:return this.raster=i,this._cachedRasterFunctionJson=null,e.next=23,i.when();case 23:if(this._cachedRendererJson=null,s||o){e.next=25;break}return e.abrupt("return");case 25:p=this.bandIds,m=this.raster.rasterInfo.bandCount,v=null!==p&&void 0!==p&&p.length?p.some((function(e){return e>=m})):m>=3,p&&(v||this.renderer&&"raster-stretch"!==this.renderer.type)&&this._set("bandIds",null),this._configDefaultRenderer("auto");case 27:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"updateRenderer",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(){var t,r,n,s,o,l,u;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.loaded,r=this.symbolizer,t&&r&&this.renderer){e.next=3;break}return e.abrupt("return");case 3:if(n=this.raster.rasterInfo,s=(0,V.WY)(n,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}),o=null===s||void 0===s?void 0:s.name,l=(0,xe.ol)((0,i.Z)((0,i.Z)({},this.renderer.toJSON()),{},{variableName:o})),JSON.stringify(this._cachedRendererJson)!==JSON.stringify(l)){e.next=6;break}return e.abrupt("return");case 6:if(u=this._rasterJobHandler.instance,e.t0=u,!e.t0){e.next=15;break}return r.rasterInfo=(0,xe.FI)(n,o),r.rendererJSON=l,r.bind(),e.next=14,u.updateSymbolizer(r);case 14:this._cachedRendererJson=l;case 15:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"applyRenderer",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,s,o,l,u;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=(s=null===t||void 0===t?void 0:t.pixelBlock)&&s.pixels&&s.pixels.length>0){e.next=3;break}return e.abrupt("return",null);case 3:return e.next=5,this.updateRenderer();case 5:if(l=this._rasterJobHandler.instance,u=null!==(n=this.bandIds)&&void 0!==n?n:[],!l){e.next=12;break}return e.next=9,l.symbolize((0,i.Z)((0,i.Z)({},t),{},{simpleStretchParams:r,bandIds:u}));case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=this.symbolizer.symbolize((0,i.Z)((0,i.Z)({},t),{},{simpleStretchParams:r,bandIds:u}));case 13:return o=e.t0,e.abrupt("return",o);case 15:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getTileUrl",value:function(e,t,r){return"RasterTileServer"===this.raster.datasetFormat?"".concat(this.url,"/tile/").concat(e,"/").concat(t,"/").concat(r):""}},{key:"getCompatibleTileInfo",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.loaded||null==t)return null;if(r&&e.equals(this.spatialReference))return this.tileInfo;var n=(0,z.C5)(e);return W.Z.create({size:256,spatialReference:e,origin:n?{x:n.origin[0],y:n.origin[1]}:{x:t.xmin,y:t.ymax}})}},{key:"getCompatibleFullExtent",value:function(e){return this.loaded?(this._compatibleFullExtent&&this._compatibleFullExtent.spatialReference.equals(e)||(this._compatibleFullExtent=this.raster.computeExtent(e)),this._compatibleFullExtent):null}},{key:"fetchTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,n,s){var o,l,u,c,f,h=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(l=h.length>3&&void 0!==h[3]?h[3]:{},r(this),!l.requestAsImageElement){e.next=4;break}return u=this.getTileUrl(t,n,s),e.abrupt("return",(0,D.Z)(u,{responseType:"image",query:(0,i.Z)((0,i.Z)({},this.refreshParameters),this.raster.ioConfig.customFetchParameters),signal:l.signal}).then((function(e){return e.data})));case 4:if(null==(c=this.rasterInfo).multidimensionalInfo||null!=(l=this.normalizeRasterFetchOptions(l)).multidimensionalDefinition){e.next=8;break}return f=l.tileInfo||c.storageInfo.tileInfo,e.abrupt("return",{extent:this.raster.getTileExtentFromTileInfo(t,n,s,f),pixelBlock:null});case 8:return e.next=10,this._initJobHandler();case 10:return e.next=12,this.updateRasterFunction();case 12:return"raster-shaded-relief"===(null===(o=this.renderer)||void 0===o?void 0:o.type)&&(l=(0,i.Z)((0,i.Z)({},l),{},{buffer:{cols:1,rows:1}})),e.abrupt("return",this.raster.fetchTile(t,n,s,l));case 14:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,n){var i,s=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=s.length>3&&void 0!==s[3]?s[3]:{},null==this.rasterInfo.multidimensionalInfo||null!=(i=this.normalizeRasterFetchOptions(i)).multidimensionalDefinition){e.next=5;break}e.t0={extent:t,pixelBlock:null},e.next=12;break;case 5:return e.next=7,this._initJobHandler();case 7:return e.next=9,this.updateRasterFunction();case 9:r=Math.round(r),n=Math.round(n),e.t0=this.raster.fetchPixels(t,r,n,i);case 12:return e.abrupt("return",e.t0);case 13:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"identify",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n,i,s,o,l=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=l.length>1&&void 0!==l[1]?l[1]:{},i=this.raster,null==(s=this.rasterInfo).multidimensionalInfo){e.next=5;break}if(s.hasMultidimensionalTranspose&&((0,V.WU)(n.multidimensionalDefinition)||n.transposedVariableName||n.timeExtent)||null!=(n=this.normalizeRasterFetchOptions(n)).multidimensionalDefinition){e.next=5;break}return e.abrupt("return",{location:t,value:null});case 5:if(!(o=null===(r=this.multidimensionalSubset)||void 0===r?void 0:r.areaOfInterest)||o.contains(t)){e.next=8;break}throw new y.Z("imagery-tile-mixin:identify","the request cannot be fulfilled when falling outside of the multidimensional subset");case 8:return e.abrupt("return",i.identify(t,n));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"increaseRasterJobHandlerUsage",value:function(){this._rasterJobHandler.refCount++}},{key:"decreaseRasterJobHandlerUsage",value:function(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()}},{key:"hasStandardTime",value:function(){var e,t,r,n=null===(e=this.rasterInfo)||void 0===e?void 0:e.multidimensionalInfo;if(null==n||"standard-time"!==(null===(t=this.rasterInfo)||void 0===t?void 0:t.dataType))return!1;var i=this.multidimensionalDefinition,a=null===i||void 0===i||null===(r=i[0])||void 0===r?void 0:r.variableName;return n.variables.some((function(e){return e.name===a&&(!(null!==i&&void 0!==i&&i[0].dimensionName)||e.dimensions.some((function(e){return"StdTime"===e.name})))}))}},{key:"getStandardTimeValue",value:function(e){return new Date(24*(e-25569)*3600*1e3).toString()}},{key:"getMultidimensionalSubsetVariables",value:function(e){var t,r=null!==e&&void 0!==e?e:null===(t=this.rasterInfo)||void 0===t?void 0:t.multidimensionalInfo;return(0,V.jj)(this.multidimensionalSubset,r)}},{key:"_configDefaultSettings",value:function(){this._configDefaultInterpolation(),this.multidimensionalDefinition||(this.multidimensionalDefinition=(0,V.Tj)(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset})),this.rasterFunction&&"Function"===this.raster.datasetFormat&&(this._cachedRasterFunctionJson=this.rasterFunction.toJSON()),this._configDefaultRenderer()}},{key:"_initJobHandler",value:function(){var e=this;if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;var t=new L.Z;return this._rasterJobHandler.connectionPromise=t.initialize().then((0,s.Z)((0,a.Z)().mark((function n(){return(0,a.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(r(e),e._rasterJobHandler.instance=t,e.raster.rasterJobHandler=t,"Function"===e.raster.datasetFormat&&e.raster.syncJobHandler(),n.t0=e.rasterFunction,!n.t0){n.next=8;break}return n.next=8,e.updateRasterFunction().catch((function(){}));case 8:e.renderer&&e.updateRenderer();case 9:case"end":return n.stop()}}),n)})))).catch((function(){})),this._rasterJobHandler.connectionPromise}},{key:"_shutdownJobHandler",value:function(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0,this._cachedRendererJson=null,this.raster&&(this.raster.rasterJobHandler=null)}},{key:"_configDefaultInterpolation",value:function(){if(null==this.interpolation){var e;r(this);var t=this.raster,n=(0,xe.In)(t.rasterInfo,t.tileType,null===(e=this.sourceJSON)||void 0===e?void 0:e.defaultResamplingMethod);this._set("interpolation",n)}}},{key:"_configDefaultRenderer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"no";r(this);var t=this.raster.rasterInfo;!this.bandIds&&t.bandCount>1&&(this.bandIds=(0,xe.YD)(t));var n=(0,V.WY)(t,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}),a=null===n||void 0===n?void 0:n.name;if(!this.renderer||"override"===e){var s,o,l=(0,xe.Ob)(t,{bandIds:this.bandIds,variableName:a}),u=t.statistics,c=u&&u.length>0?u[0]:null,f=null!==(s=null===c||void 0===c?void 0:c.max)&&void 0!==s?s:0,h=null!==(o=null===c||void 0===c?void 0:c.min)&&void 0!==o?o:0;"WCSServer"===this.raster.datasetFormat&&"raster-stretch"===l.type&&(f>1e24||h<-1e24)&&(l.dynamicRangeAdjustment=!0,l.statistics=null,"none"===l.stretchType&&(l.stretchType="min-max")),this.renderer=l}var d=(0,xe.ol)((0,i.Z)((0,i.Z)({},this.renderer.toJSON()),{},{variableName:a})),p=(0,xe.FI)(t,a);this.symbolizer?(this.symbolizer.rendererJSON=d,this.symbolizer.rasterInfo=p):this.symbolizer=new ge.Z({rendererJSON:d,rasterInfo:p});var m=this.symbolizer.bind();if(m.success){if("auto"===e){var v=this.raster.rasterInfo.colormap,y=this.renderer;if(null!=v&&"raster-colormap"===y.type){var x=(0,xe.Ob)(this.raster.rasterInfo);JSON.stringify(x)!==JSON.stringify(y)&&this._configDefaultRenderer("override")}else if("raster-stretch"===y.type){var g,b,k=null===(g=this.bandIds)||void 0===g?void 0:g.length,w=null===(b=y.statistics)||void 0===b?void 0:b.length;!y.dynamicRangeAdjustment&&w&&k&&w!==k&&this._configDefaultRenderer("override")}}}else Ie.warn("imagery-tile-mixin",m.error||"The given renderer is not supported by the layer."),"auto"===e&&this._configDefaultRenderer("override")}}]),n}(e);function r(e){if(!e.raster||!e.rasterInfo)throw new y.Z("imagery-tile","no raster")}return(0,p._)([(0,w.Cb)({clonable:!1})],t.prototype,"_cachedRendererJson",void 0),(0,p._)([(0,w.Cb)({clonable:!1})],t.prototype,"_cachedRasterFunctionJson",void 0),(0,p._)([(0,w.Cb)({clonable:!1})],t.prototype,"_compatibleFullExtent",void 0),(0,p._)([(0,w.Cb)({clonable:!1})],t.prototype,"_isConstructedFromFunctionRaster",void 0),(0,p._)([(0,w.Cb)({clonable:!1})],t.prototype,"_rasterJobHandler",void 0),(0,p._)([(0,w.Cb)()],t.prototype,"bandIds",void 0),(0,p._)([(0,w.Cb)({json:{origins:{service:{read:{source:"copyrightText"}}}}})],t.prototype,"copyright",void 0),(0,p._)([(0,w.Cb)({json:{read:!1}})],t.prototype,"fullExtent",null),(0,p._)([(0,w.Cb)()],t.prototype,"interpolation",void 0),(0,p._)([(0,w.Cb)()],t.prototype,"ioConfig",void 0),(0,p._)([(0,w.Cb)({type:[J.Z],json:{write:!0}})],t.prototype,"multidimensionalDefinition",null),(0,p._)([(0,w.Cb)({type:N.Z,json:{write:!0}})],t.prototype,"multidimensionalSubset",void 0),(0,p._)([(0,w.Cb)()],t.prototype,"raster",void 0),(0,p._)([(0,w.Cb)({type:H.Z,json:{name:"renderingRule",write:!0}})],t.prototype,"rasterFunction",null),(0,p._)([(0,w.Cb)()],t.prototype,"rasterInfo",void 0),(0,p._)([(0,w.Cb)()],t.prototype,"sourceJSON",void 0),(0,p._)([(0,w.Cb)({readOnly:!0,type:we.Z,json:{read:!1}})],t.prototype,"spatialReference",void 0),(0,p._)([(0,w.Cb)({type:W.Z})],t.prototype,"tileInfo",void 0),(0,p._)([(0,w.Cb)(E.HQ)],t.prototype,"url",null),(0,p._)([(0,w.Cb)({types:O.dr,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:function(){var e,t="raster-stretch"===(null===(e=this.renderer)||void 0===e?void 0:e.type)&&"none"===this.renderer.stretchType&&!this.renderer.useGamma;return{enabled:!this.loaded||"Raster"===this.raster.tileType||!t}}},origins:{"web-scene":{types:O.FK,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:function(e){return{enabled:e&&"vector-field"!==e.type&&"flow"!==e.type}}}}}}})],t.prototype,"renderer",null),(0,p._)([(0,B.r)("renderer")],t.prototype,"readRenderer",null),(0,p._)([(0,w.Cb)({clonable:!1})],t.prototype,"symbolizer",void 0),t=(0,p._)([(0,R.j)("esri.layers.ImageryTileMixin")],t),t}((0,Te.n)((0,C.Y)((0,Se.Q)((0,g.R)((0,v.J)(T.Z))))))))))));(0,p._)([(0,w.Cb)({clonable:!1})],It.prototype,"_primaryRasters",void 0),(0,p._)([(0,w.Cb)({type:[I.z8],json:{write:{overridePolicy:function(){var e;return{enabled:!this.loaded||"Raster"===this.raster.tileType||"0,1,2"!==(null===(e=this.bandIds)||void 0===e?void 0:e.join(","))}}}}})],It.prototype,"bandIds",void 0),(0,p._)([(0,w.Cb)({json:{write:{overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType||"bilinear"!==this.interpolation}}}}}),(0,S.J)(Me.cl)],It.prototype,"interpolation",void 0),(0,p._)([(0,w.Cb)(E.rn)],It.prototype,"legendEnabled",void 0),(0,p._)([(0,w.Cb)({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:function(){return{enabled:!1}}}}})],It.prototype,"isReference",void 0),(0,p._)([(0,w.Cb)({type:["show","hide"]})],It.prototype,"listMode",void 0),(0,p._)([(0,w.Cb)({json:{read:!0,write:!0}})],It.prototype,"blendMode",void 0),(0,p._)([(0,w.Cb)()],It.prototype,"sourceJSON",void 0),(0,p._)([(0,w.Cb)({readOnly:!0,json:{origins:{service:{read:{source:"currentVersion"}}}}})],It.prototype,"version",void 0),(0,p._)([(0,w.Cb)({readOnly:!0,json:{read:!1}})],It.prototype,"type",void 0),(0,p._)([(0,w.Cb)({type:["ArcGISTiledImageServiceLayer"]})],It.prototype,"operationalLayerType",void 0),(0,p._)([(0,w.Cb)({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:function(e,t){return!t.disablePopup}},write:{target:"disablePopup",overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}},writer:function(e,t,r){t[r]=!e}}}})],It.prototype,"popupEnabled",void 0),(0,p._)([(0,w.Cb)({type:m.Z,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}}}}})],It.prototype,"popupTemplate",void 0),(0,p._)([(0,w.Cb)({readOnly:!0})],It.prototype,"defaultPopupTemplate",null),(0,p._)([(0,w.Cb)({readOnly:!0,type:[Ce.Z]})],It.prototype,"fields",void 0),(0,p._)([(0,w.Cb)({readOnly:!0,type:[Ce.Z]})],It.prototype,"rasterFields",null);var Zt=It=(0,p._)([(0,R.j)("esri.layers.ImageryTileLayer")],It)},34810:function(e,t,r){r.d(t,{y:function(){return F}});var n=r(74165),i=r(15861),a=r(1413),s=r(15671),o=r(43144),l=r(60136),u=r(29388),c=r(27366),f=r(76200),h=r(7138),d=r(70116),p=r(10064),m=r(42537),v=r(16054),y=r(27546),x=r(66978),g=r(94172),b=r(99346),k=r(35995),w=r(49861),I=(r(25243),r(63780)),Z=(r(93169),r(69912)),_=r(87960),S=r(84652),R=r(18722);var T,C=function(){function e(t){(0,s.Z)(this,e),this._validateJSON(t);var r=t.location,n=t.data;this.location=Object.freeze((0,S.d9)(r));for(var i=this.location.width,a=this.location.height,o=!0,l=!0,u=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e<=R.c8?t?new Array(e).fill(0):new Array(e):new Uint32Array(e)}(Math.ceil(i*a/32)),c=0,f=0;f<n.length;f++){var h=f%32;n[f]?(l=!1,u[c]|=1<<h):o=!1,31===h&&++c}l?(this._availability="unavailable",this.byteSize=40):o?(this._availability="available",this.byteSize=40):(this._availability=u,this.byteSize=40+(0,R.Xw)(u))}return(0,o.Z)(e,[{key:"getAvailability",value:function(e,t){if("unavailable"===this._availability||"available"===this._availability)return this._availability;var r=(e-this.location.top)*this.location.width+(t-this.location.left),n=r%32,i=r>>5,a=this._availability;return i<0||i>a.length?"unknown":a[i]&1<<n?"available":"unavailable"}},{key:"_validateJSON",value:function(e){if(null===e||void 0===e||!e.location)throw new p.Z("tilemap:missing-location","Location missing from tilemap response");if(!1===e.valid)throw new p.Z("tilemap:invalid","Tilemap response was marked as invalid");if(!e.data)throw new p.Z("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(e.data))throw new p.Z("tilemap:data-mismatch","Data must be an array of numbers");if(e.data.length!==e.location.width*e.location.height)throw new p.Z("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}}],[{key:"fromDefinition",value:function(t,r){var n=t.service.request||f.Z,i=t.row,s=t.col,o=t.width,l=t.height,u={query:{f:"json"}};return r=r?(0,a.Z)((0,a.Z)({},u),r):u,n(function(e){var t,r;if(null!==(t=e.service.tileServers)&&void 0!==t&&t.length){var n=e.service.tileServers;r="".concat(n&&n.length?n[e.row%n.length]:e.service.url,"/tilemap/").concat(e.level,"/").concat(e.row,"/").concat(e.col,"/").concat(e.width,"/").concat(e.height)}else r="".concat(e.service.url,"/tilemap/").concat(e.level,"/").concat(e.row,"/").concat(e.col,"/").concat(e.width,"/").concat(e.height);var i=e.service.query;return i&&(r="".concat(r,"?").concat(i)),r}(t),r).then((function(e){return e.data})).catch((function(e){if(e&&e.details&&422===e.details.httpStatus)return{location:{top:i,left:s,width:o,height:l},valid:!0,data:(0,I.a9)(o*l,0)};throw e})).then((function(t){if(t.location&&(t.location.top!==i||t.location.left!==s||t.location.width!==o||t.location.height!==l))throw new p.Z("tilemap:location-mismatch","Tilemap response for different location than requested",{response:t,definition:{top:i,left:s,width:o,height:l}});return e.fromJSON(t)}))}},{key:"fromJSON",value:function(t){return Object.freeze(new e(t))}}]),e}();function M(e){return"".concat(e.level,"/").concat(e.row,"/").concat(e.col,"/").concat(e.width,"/").concat(e.height)}var F=T=function(e){(0,l.Z)(r,e);var t=(0,u.Z)(r);function r(e){var n;return(0,s.Z)(this,r),(n=t.call(this,e))._pendingTilemapRequests={},n.request=f.Z,n.size=32,n._prefetchingEnabled=!0,n}return(0,o.Z)(r,[{key:"initialize",value:function(){var e=this;this._tilemapCache=new v.z(2*d.Y.MEGABYTES),this.addHandles([(0,g.YP)((function(){var t=e.layer;return[null===t||void 0===t?void 0:t.parsedUrl,null===t||void 0===t?void 0:t.tileServers,null===t||void 0===t?void 0:t.apiKey,null===t||void 0===t?void 0:t.customParameters]}),(function(){return e._initializeTilemapDefinition()}),g.nn)])}},{key:"effectiveMinLOD",get:function(){var e;return null!==(e=this.minLOD)&&void 0!==e?e:this.layer.tileInfo.lods[0].level}},{key:"effectiveMaxLOD",get:function(){var e;return null!==(e=this.maxLOD)&&void 0!==e?e:this.layer.tileInfo.lods[this.layer.tileInfo.lods.length-1].level}},{key:"fetchTilemap",value:function(e,t,r,n){var i,s=this;if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return Promise.reject(new p.Z("tilemap-cache:level-unavailable","Level ".concat(e," is unavailable in the service")));var o=this._tmpTilemapDefinition,l=this._tilemapFromCache(e,t,r,o);if(l)return Promise.resolve(l);var u=null===(i=n)||void 0===i?void 0:i.signal;return n=(0,a.Z)((0,a.Z)({},n),{},{signal:null}),new Promise((function(e,t){(0,x.fu)(u,(function(){return t((0,x.zE)())}));var r=M(o),i=s._pendingTilemapRequests[r];if(!i){i=C.fromDefinition(o,n).then((function(e){return s._tilemapCache.put(r,e,e.byteSize),e}));var a=function(){delete s._pendingTilemapRequests[r]};s._pendingTilemapRequests[r]=i,i.then(a,a)}i.then(e,t)}))}},{key:"getAvailability",value:function(e,t,r){if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return"unavailable";var n=this._tilemapFromCache(e,t,r,this._tmpTilemapDefinition);return n?n.getAvailability(t,r):"unknown"}},{key:"fetchAvailability",value:function(e,t,r,n){return!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD?Promise.reject(new p.Z("tile-map:tile-unavailable","Tile is not available",{level:e,row:t,col:r})):this.fetchTilemap(e,t,r,n).catch((function(e){return e})).then((function(n){if(n instanceof C){var i=n.getAvailability(t,r);if("unavailable"===i)throw new p.Z("tile-map:tile-unavailable","Tile is not available",{level:e,row:t,col:r});return i}if((0,x.D_)(n))throw n;return"unknown"}))}},{key:"fetchAvailabilityUpsample",value:function(e,t,r,n,i){var a=this;n.level=e,n.row=t,n.col=r;var s=this.layer.tileInfo;s.updateTileInfo(n);var o=this.fetchAvailability(e,t,r,i).catch((function(e){if((0,x.D_)(e))throw e;if(s.upsampleTile(n))return a.fetchAvailabilityUpsample(n.level,n.row,n.col,n,i);throw e}));return this._fetchAvailabilityUpsamplePrefetch(n.id,e,t,r,i,o),o}},{key:"_fetchAvailabilityUpsamplePrefetch",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i,s,o,l){var u,c,f,h,d,p,v,y,g=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._prefetchingEnabled&&null!=t){e.next=2;break}return e.abrupt("return");case 2:if(u="prefetch-".concat(t),!this.hasHandles(u)){e.next=5;break}return e.abrupt("return");case 5:return c=new AbortController,l.then((function(){return c.abort()}),(function(){return c.abort()})),f=!1,h=(0,m.kB)((function(){f||(f=!0,c.abort())})),this.addHandles(h,u),e.next=12,(0,b.MU)(10,c.signal).catch((function(){}));case 12:if(f||(f=!0,this.removeHandles(u)),!(0,x.Hc)(c)){e.next=15;break}return e.abrupt("return");case 15:d=new _.f(t,r,i,s),p=(0,a.Z)((0,a.Z)({},o),{},{signal:c.signal}),v=this.layer.tileInfo,y=(0,n.Z)().mark((function e(){var t,r;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=g.fetchAvailability(d.level,d.row,d.col,p),T._prefetches.push(t),r=function(){T._prefetches.removeUnordered(t)},t.then(r,r);case 4:case"end":return e.stop()}}),e)})),0;case 18:if(!(T._prefetches.length<T._maxPrefetch&&v.upsampleTile(d))){e.next=23;break}return e.delegateYield(y(),"t0",20);case 20:e.next=18;break;case 23:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,a,s){return e.apply(this,arguments)}}()},{key:"_initializeTilemapDefinition",value:function(){var e;if(this.layer.parsedUrl){var t=this.layer,r=t.parsedUrl,n=t.apiKey,i=t.customParameters;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:r.path,query:(0,k.B7)((0,a.Z)((0,a.Z)((0,a.Z)({},r.query),i),{},{token:null!==n&&void 0!==n?n:null===(e=r.query)||void 0===e?void 0:e.token})),tileServers:this.layer.tileServers,request:this.request},width:this.size,height:this.size,level:0,row:0,col:0}}}},{key:"_tilemapFromCache",value:function(e,t,r,n){n.level=e,n.row=t-t%this.size,n.col=r-r%this.size;var i=M(n);return this._tilemapCache.get(i)}},{key:"test",get:function(){var e=this;return{get prefetchingEnabled(){return e._prefetchingEnabled},set prefetchingEnabled(t){e._prefetchingEnabled=t},hasTilemap:function(t,r,n){return!!e._tilemapFromCache(t,r,n,e._tmpTilemapDefinition)}}}}]),r}(h.Z);F._maxPrefetch=4,F._prefetches=new y.Z({initialSize:T._maxPrefetch}),(0,c._)([(0,w.Cb)({constructOnly:!0})],F.prototype,"layer",void 0),(0,c._)([(0,w.Cb)({constructOnly:!0})],F.prototype,"minLOD",void 0),(0,c._)([(0,w.Cb)({constructOnly:!0})],F.prototype,"maxLOD",void 0),(0,c._)([(0,w.Cb)({constructOnly:!0})],F.prototype,"request",void 0),(0,c._)([(0,w.Cb)({constructOnly:!0})],F.prototype,"size",void 0),F=T=(0,c._)([(0,Z.j)("esri.layers.support.TilemapCache")],F)},55635:function(e,t,r){r.d(t,{OE:function(){return d},Gc:function(){return v},Qg:function(){return p},Rq:function(){return c},gX:function(){return m},z2:function(){return f},ET:function(){return h},Vx:function(){return x}});r(59486);var n=r(15671),i=r(43144),a=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15e3,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;(0,n.Z)(this,e),this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,r)}return(0,i.Z)(e,[{key:"decreaseRefCount",value:function(e,t){var r=e+"/"+t,n=this._cachedBlocks;if(n.has(r)){var i=n.get(r);return i.refCount--,i.refCount<=0&&(n.delete(r),i.controller&&i.controller.abort()),i.refCount}return 0}},{key:"getBlock",value:function(e,t){var r=e+"/"+t,n=this._cachedBlocks;if(n.has(r)){var i=n.get(r);return i.ts=Date.now(),i.refCount++,n.delete(r),n.set(r,i),i.block}return null}},{key:"putBlock",value:function(e,t,r,n){var i=this._cachedBlocks,a=e+"/"+t;if(i.has(a)){var s=i.get(a);s.ts=Date.now(),s.refCount++}else i.set(a,{block:r,ts:Date.now(),refCount:1,controller:n});this._trim(),this._updateTimer()}},{key:"deleteBlock",value:function(e,t){var r=this._cachedBlocks,n=e+"/"+t;r.has(n)&&r.delete(n)}},{key:"updateMaxSize",value:function(e){this._size=e,this._trim()}},{key:"empty",value:function(){this._cachedBlocks.clear(),this._clearTimer()}},{key:"getCurrentSize",value:function(){return this._cachedBlocks.size}},{key:"_updateTimer",value:function(){var e=this;if(null==this._timer){var t=this._cachedBlocks;this._timer=setInterval((function(){for(var r=Array.from(t),n=Date.now(),i=0;i<r.length&&r[i][1].ts<=n-e._duration;i++)t.delete(r[i][0]);0===t.size&&e._clearTimer()}),this._interval)}}},{key:"_trim",value:function(){var e=this._cachedBlocks;if(!(-1===this._size||this._size>=e.size))for(var t=Array.from(e),r=0;r<t.length-this._size;r++)e.delete(t[r][0])}},{key:"_clearTimer",value:function(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}]),e}(),s=r(80394),o=r(585),l=new Map,u=new a;function c(e,t){return null==t?e:"".concat(e,"?sliceId=").concat(t)}function f(e,t){var r={extent:null,rasterInfo:t,cache:new Map},n=l.get(e);return n?(n.push(r),n.length-1):(l.set(e,[r]),0)}function h(e,t){var r=l.get(e);r&&(r[t]=null,r.some((function(e){return null!=e}))||l.delete(e))}function d(e,t,r){var n,i=l.get(e);if(!i)return null==t?u.decreaseRefCount(e,r):0;if(null==t||null==i[t])return u.decreaseRefCount(e,r);var a=null===(n=i[t])||void 0===n?void 0:n.cache,s=null===a||void 0===a?void 0:a.get(r);if(a&&s){if(s.refCount--,0===s.refCount){a.delete(r);for(var o=0;o<i.length;o++){var c;null===(c=i[o])||void 0===c||c.cache.delete(r)}s.controller&&s.controller.abort()}return s.refCount}return 0}function p(e,t,r){var n,i=l.get(e);if(!i)return null==t?u.getBlock(e,r):null;if(null==t||null==i[t]){for(var a=0;a<i.length;a++){var s,o=null===(s=i[a])||void 0===s?void 0:s.cache.get(r);if(o)return o.refCount++,o.block}return u.getBlock(e,r)}var c=null===(n=i[t])||void 0===n?void 0:n.cache.get(r);if(c)return c.refCount++,c.block;for(var f=0;f<i.length;f++){var h;if(f!==t&&i[f]){var d=null===(h=i[f])||void 0===h?void 0:h.cache,p=null===d||void 0===d?void 0:d.get(r);if(d&&p)return p.refCount++,d.set(r,p),p.block}}return null}function m(e,t,r,n){var i,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=l.get(e);if(s)if(null!=t&&null!=s[t]){var o={refCount:1,block:n,isResolved:!1,isRejected:!1,controller:a};n.then((function(){return o.isResolved=!0})).catch((function(){return o.isRejected=!0})),null===(i=s[t])||void 0===i||i.cache.set(r,o)}else u.putBlock(e,r,n,a);else null==t&&u.putBlock(e,r,n,a)}function v(e,t,r){var n,i=l.get(e);i?null!=t&&null!=i[t]?null===(n=i[t])||void 0===n||n.cache.delete(r):u.deleteBlock(e,r):null==t&&u.deleteBlock(e,r)}function y(e,t){var r,n=l.get(e);return n&&null!==(r=n[t])&&void 0!==r?r:null}function x(e,t,r,n,i,a){var l,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,c=y(e,t);if(c){var f=c.extent,h=c.cache,d=c.rasterInfo;if(!f||f.xmin!==r.xmin||f.xmax!==r.xmax||f.ymin!==r.ymin||f.ymax!==r.ymax){n=null!==(l=n)&&void 0!==l?l:0;for(var p=r.clone().normalize(),m=d.spatialReference,v=d.transform,x=new Set,g=0;g<p.length;g++){var b=p[g];if(!(b.xmax-b.xmin<=n||b.ymax-b.ymin<=n)){var k=(0,s.tB)(b,m,u);null!=v&&(k=v.inverseTransform(k));var w=new o.Z({x:n,y:n,spatialReference:b.spatialReference});if(null==i&&!(i=(0,s.VO)(w,m,b,u)))return;var I=(0,s.kr)(i,d,a||"closest"),Z=I.pyramidLevel,_=I.pyramidResolution;if(I.excessiveReading)return;for(var S=d.storageInfo,R=S.origin,T={x:Math.max(0,Math.floor((k.xmin-R.x)/_.x)),y:Math.max(0,Math.floor((R.y-k.ymax)/_.y))},C=Math.ceil((k.xmax-k.xmin)/_.x-.1),M=Math.ceil((k.ymax-k.ymin)/_.y-.1),F=Z>0?S.pyramidBlockWidth:S.blockWidth,P=Z>0?S.pyramidBlockHeight:S.blockHeight,O=Math.max(0,Math.floor(T.x/F)-1),D=Math.max(0,Math.floor(T.y/P)-1),B=Math.floor((T.x+C-1)/F)+1,z=Math.floor((T.y+M-1)/P)+1,A=D;A<=z;A++)for(var E=O;E<=B;E++)x.add("".concat(Z,"/").concat(A,"/").concat(E))}}h.forEach((function(e,t){if(!x.has(t)){var r=h.get(t);(null==r||r.isResolved||r.isRejected)&&h.delete(t)}})),c.extent={xmin:r.xmin,ymin:r.ymin,xmax:r.xmax,ymax:r.ymax}}}}}}]);
//# sourceMappingURL=3064.ab66f29e.chunk.js.map