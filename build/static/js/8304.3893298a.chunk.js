"use strict";(self.webpackChunkamit_kumar_rathi=self.webpackChunkamit_kumar_rathi||[]).push([[8304],{38330:function(e,t,r){r.d(t,{t:function(){return o}});var i=r(74165),n=r(1413),s=r(15861),a=r(76200);function o(e,t){return u.apply(this,arguments)}function u(){return u=(0,s.Z)((0,i.Z)().mark((function e(t,r){var s,o;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,a.Z)(t,(0,n.Z)({responseType:"image"},r));case 2:return s=e.sent,o=s.data,e.abrupt("return",o);case 5:case"end":return e.stop()}}),e)}))),u.apply(this,arguments)}},59001:function(e,t,r){r.d(t,{Z:function(){return l}});var i=r(74165),n=r(15861),s=r(15671),a=r(43144),o=r(82272),u=r(51e3),l=function(){function e(){(0,s.Z)(this,e),this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}return(0,a.Z)(e,[{key:"destroy",value:function(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}},{key:"getResource",value:function(e){var t;return null!==(t=this._resourceMap.get(e))&&void 0!==t?t:null}},{key:"fetchResource",value:function(){var e=(0,n.Z)((0,i.Z)().mark((function e(t,r){var n,s,a=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this._resourceMap.get(t))){e.next=3;break}return e.abrupt("return",{width:n.width,height:n.height});case 3:return s=this._inFlightResourceMap.get(t),e.abrupt("return",s?s.then((function(e){return{width:e.width,height:e.height}})):(s=(0,u.n$)(t,r),this._inFlightResourceMap.set(t,s),s.then((function(e){return a._inFlightResourceMap.delete(t),a._resourceMap.set(t,e),{width:e.width,height:e.height}}),(function(){return{width:0,height:0}}))));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"deleteResource",value:function(e){this._inFlightResourceMap.delete(e),this._resourceMap.delete(e)}},{key:"loadFont",value:function(e){return(0,o.mx)(e)}}]),e}()},58304:function(e,t,r){r.r(t),r.d(t,{GraphicContainer:function(){return pt.Z},GraphicsView2D:function(){return _t.Z},LabelManager:function(){return ft.Q},MagnifierView2D:function(){return Ot},MapViewNavigation:function(){return vt.Z},Stage:function(){return dt}});var i=r(74165),n=r(1413),s=r(15861),a=r(37762),o=r(15671),u=r(43144),l=r(97326),h=r(60136),c=r(29388),d=r(10064),f=r(93169),_=r(92026),p=r(99346),v=r(76432),g=r(23588),m=r(59001),b=r(33624),y=r(29439),w=r(91505),x=r(98928),B=r(42537),T=r(16889),E=r(22018),F=r(89494),O=r(83826),k=function(){function e(t){var r=this;(0,o.Z)(this,e),this.events=new w.Z,this._hasMajorPerformanceCaveat=!1,this._lastRenderFrameCounter=0,this._canvas=document.createElement("canvas"),this._canvas.setAttribute("style","width: 100%; height:100%; display:block; willChange:transform");var i={failIfMajorPerformanceCaveat:!0,alpha:!0,antialias:!1,depth:!0,stencil:!0};t.appendChild(this._canvas);var s=(0,O.dz)("2d",this._canvas,i);s||(s=(0,O.dz)("2d",this._canvas,(0,n.Z)((0,n.Z)({},i),{},{failIfMajorPerformanceCaveat:!1})),this._hasMajorPerformanceCaveat=!0),this._gl=s,this._handles=(0,B.AL)([(0,x.on)(this._canvas,"webglcontextlost",(function(e){return r.events.emit("webgl-context-lost",e)}))])}return(0,u.Z)(e,[{key:"destroy",value:function(){var e;null!==(e=this._canvas.parentNode)&&void 0!==e&&e.removeChild(this._canvas),this._canvas=null,this._handles.remove(),this._gl=null}},{key:"gl",get:function(){return this._gl}},{key:"render",value:function(e,t){if(this._hasMajorPerformanceCaveat||(0,f.Z)("esri-force-performance-mode")){if(++this._lastRenderFrameCounter>=(0,f.Z)("esri-performance-mode-frames-between-render")&&(t(),this._lastRenderViewState=e.state.clone(),this._lastRenderFrameCounter=0),this._lastRenderViewState){var r=this._computeViewTransform(this._lastRenderViewState,e.state),i=(0,y.Z)(r,6),n=i[0],s=i[1],a=i[2],o=i[3],u=i[4],l=i[5];this._canvas.style.transform="matrix(".concat(n,", ").concat(s,", ").concat(a,", ").concat(o,", ").concat(u,", ").concat(l,")")}}else t()}},{key:"resize",value:function(e){var t=this._canvas,r=t.style,i=e.state.size,n=e.pixelRatio,s=i[0],a=i[1],o=Math.round(s*n),u=Math.round(a*n);t.width===o&&t.height===u||(t.width=o,t.height=u),r.width=s+"px",r.height=a+"px"}},{key:"_computeViewTransform",value:function(e,t){var r=(0,y.Z)(e.center,2),i=r[0],n=r[1],s=(0,y.Z)(t.center,2),a=s[0],o=s[1],u=e.toScreen([0,0],a,o),l=(0,y.Z)(u,2),h=l[0],c=l[1],d=e.toScreen([0,0],i,n),f=(0,y.Z)(d,2),_=f[0]-h,p=f[1]-c,v=e.scale/t.scale,g=t.rotation-e.rotation,m=(0,F.c)();return(0,E.c)(m),(0,E.s)(m,m,[v,v]),(0,E.r)(m,m,(0,T.Vl)(g)),(0,E.t)(m,m,[_,p]),m}}]),e}(),M=r(39484),R=r(80613),P=r(62272),S=r(10106),C=r(34052),A=r(65706),Z=function(e){return(0,A.K)({ID:e.id,PATTERN:e.pattern})},U={shaders:function(e){return{vertexShader:Z(e)+(0,C.w)("background/background.vert"),fragmentShader:Z(e)+(0,C.w)("background/background.frag")}}},z=function(e){return(0,A.K)({ID:e.id})},L={shaders:function(e){return{vertexShader:z(e)+(0,C.w)("circle/circle.vert"),fragmentShader:z(e)+(0,C.w)("circle/circle.frag")}}},I=function(e){return(0,A.K)({ID:e.id,PATTERN:e.pattern})},D={shaders:function(e){return{vertexShader:I(e)+(0,C.w)("fill/fill.vert"),fragmentShader:I(e)+(0,C.w)("fill/fill.frag")}}},N=function(e){return(0,A.K)({ID:e.id})},H={shaders:function(e){return{vertexShader:N(e)+(0,C.w)("outline/outline.vert"),fragmentShader:N(e)+(0,C.w)("outline/outline.frag")}}},V=function(e){return(0,A.K)({ID:e.id,SDF:e.sdf})},q={shaders:function(e){return{vertexShader:V(e)+(0,C.w)("icon/icon.vert"),fragmentShader:V(e)+(0,C.w)("icon/icon.frag")}}},G=function(e){return(0,A.K)({ID:e.id,PATTERN:e.pattern,SDF:e.sdf})},W={shaders:function(e){return{vertexShader:G(e)+(0,C.w)("line/line.vert"),fragmentShader:G(e)+(0,C.w)("line/line.frag")}}},j=function(e){return(0,A.K)({ID:e.id})},K={shaders:function(e){return{vertexShader:j(e)+(0,C.w)("text/text.vert"),fragmentShader:j(e)+(0,C.w)("text/text.frag")}}},X=function(){function e(){(0,o.Z)(this,e),this._programByKey=new Map}return(0,u.Z)(e,[{key:"dispose",value:function(){this._programByKey.forEach((function(e){return e.dispose()})),this._programByKey.clear()}},{key:"getMaterialProgram",value:function(e,t,r){var i=t.key<<3|this._getMaterialOptionsValue(t.type,r);if(this._programByKey.has(i))return this._programByKey.get(i);var n=(0,this._getProgramTemplate(t.type).shaders)(r),s=n.vertexShader,a=n.fragmentShader,o=t.getShaderHeader(),u=t.getShaderMain(),l=s.replace("#pragma header",o).replace("#pragma main",u),h=e.programCache.acquire(l,a,t.getAttributeLocations());return this._programByKey.set(i,h),h}},{key:"_getMaterialOptionsValue",value:function(e,t){switch(e){case S._K.BACKGROUND:var r=t;return(r.pattern?1:0)<<1|(r.id?1:0);case S._K.FILL:var i=t;return(i.pattern?1:0)<<1|(i.id?1:0);case S._K.OUTLINE:return t.id?1:0;case S._K.LINE:var n=t;return(n.sdf?1:0)<<2|(n.pattern?1:0)<<1|(n.id?1:0);case S._K.ICON:var s=t;return(s.sdf?1:0)<<1|(s.id?1:0);case S._K.CIRCLE:case S._K.TEXT:return t.id?1:0;default:return 0}}},{key:"_getProgramTemplate",value:function(e){switch(e){case S._K.BACKGROUND:return U;case S._K.CIRCLE:return L;case S._K.FILL:return D;case S._K.ICON:return q;case S._K.LINE:return W;case S._K.OUTLINE:return H;case S._K.TEXT:return K;default:return null}}}]),e}(),Y=r(61441),Q=r(53456),$=r(44070),J=r(8548),ee=r(96721),te=r(45412),re=function(){function e(){(0,o.Z)(this,e),this._initialized=!1}return(0,u.Z)(e,[{key:"dispose",value:function(){this._program=(0,_.M2)(this._program),this._vertexArrayObject=(0,_.M2)(this._vertexArrayObject)}},{key:"render",value:function(e,t,r,i){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(J.zi.ONE,J.zi.ONE_MINUS_SRC_ALPHA,J.zi.ONE,J.zi.ONE_MINUS_SRC_ALPHA),e.bindVAO(this._vertexArrayObject),e.useProgram(this._program),t.setSamplingMode(r),e.bindTexture(t,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",i),e.drawArrays(J.MX.TRIANGLE_STRIP,0,4),e.bindTexture(null,0),e.bindVAO())}},{key:"_initialize",value:function(e){if(this._initialized)return!0;var t=(0,ee.H)(e,Q.Q);if(!t)return!1;var r=new Int8Array(16);r[0]=-1,r[1]=-1,r[2]=0,r[3]=0,r[4]=1,r[5]=-1,r[6]=1,r[7]=0,r[8]=-1,r[9]=1,r[10]=0,r[11]=1,r[12]=1,r[13]=1,r[14]=1,r[15]=1;var i=Q.Q.attributes,n=new te.U(e,i,Y.As,{geometry:$.f.createVertex(e,J.l1.STATIC_DRAW,r)});return this._program=t,this._vertexArrayObject=n,this._initialized=!0,!0}}]),e}(),ie=r(4942),ne=r(40658),se=function(e){return e===R.jx.HITTEST||e===R.jx.LABEL_ALPHA},ae=function(e,t,r){var i=e.rendererInfo,n=e.drawPhase;return"".concat(t.getVariationHash(),"-").concat(function(e){return(se(e)?1:0)|(e===R.jx.HIGHLIGHT?2:0)}(n),"-").concat(i.getVariationHash(),"-").concat(null!=r&&r.join("."))},oe=function(){function e(t){(0,o.Z)(this,e),this._rctx=t,this._programByKey=new Map}return(0,u.Z)(e,[{key:"dispose",value:function(){this._programByKey.forEach((function(e){return e.dispose()})),this._programByKey.clear()}},{key:"getProgram",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=e.vsPath+"."+e.fsPath+JSON.stringify(t);if(this._programByKey.has(r))return this._programByKey.get(r);var i=(0,n.Z)({},t.map((function(e){return"string"==typeof e?{name:e,value:!0}:e})).reduce((function(e,t){return(0,n.Z)((0,n.Z)({},e),{},(0,ie.Z)({},t.name,t.value))}),{})),s=e.vsPath,a=e.fsPath,o=e.attributes,u=(0,ne.s)(s,a,o,i),l=this._rctx.programCache.acquire(u.shaders.vertexShader,u.shaders.fragmentShader,u.attributes);if(!l)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(r,l),l}},{key:"getMaterialProgram",value:function(e,t,r,i,s){var o=ae(e,t,s);if(this._programByKey.has(o))return this._programByKey.get(o);var u=function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(i=(0,n.Z)((0,n.Z)((0,n.Z)((0,n.Z)({},i),t.getVariation()),e.rendererInfo.getVariation()),{},{highlight:e.drawPhase===R.jx.HIGHLIGHT,id:se(e.drawPhase)}),null!=r){var s,o=(0,a.Z)(r);try{for(o.s();!(s=o.n()).done;)i[s.value]=!0}catch(u){o.e(u)}finally{o.f()}}return i}(e,t,s,{ignoresSamplerPrecision:e.context.driverTest.ignoresSamplerPrecision.result}),l=(0,ne.s)(r,r,i,u),h=this._rctx.programCache.acquire(l.shaders.vertexShader,l.shaders.fragmentShader,l.attributes);if(!h)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(o,h),h}}]),e}(),ue=r(99267),le=r(66978),he=r(94109),ce=function(){function e(t,r){(0,o.Z)(this,e),this._queue=[],this._context=t,this._refreshable=r}return(0,u.Z)(e,[{key:"destroy",value:function(){this._queue=[]}},{key:"enqueueTextureUpdate",value:function(e,t){var r=(0,le.hh)(),i=e,n=he.Uz,s=Math.ceil(i.height/n);if((0,le.k_)(t),this._context.type===O.zO.WEBGL1)this._queue.push({type:"no-chunk",request:e,resolver:r,options:t});else for(var a=0;a<s;a++){var o=a*n,u=a===s-1,l=u?i.height-n*a:n;this._queue.push({type:"chunk",request:e,resolver:r,chunk:a,chunkOffset:o,destHeight:l,chunkIsLast:u,options:t})}return(0,le.$F)(t,(function(e){return r.reject(e)})),r.promise}},{key:"upload",value:function(){for(var e=0;this._queue.length;){var t=performance.now(),r=this._queue.shift();if(r){if(null!=r.options.signal&&r.options.signal.aborted)continue;switch(r.type){case"chunk":this._uploadChunk(r);break;case"no-chunk":this._uploadNoChunk(r)}var i=performance.now()-t;if((e+=i)+i>=he.NG)break}}this._queue.length&&this._refreshable.requestRender()}},{key:"_uploadChunk",value:function(e){var t=e.request,r=e.resolver,i=e.chunkOffset,n=e.chunkIsLast,s=e.destHeight,a=t.data,o=t.texture,u=t.width;null!=a&&(o.updateData(0,0,i,u,s,a,i),n&&r.resolve())}},{key:"_uploadNoChunk",value:function(e){var t=e.request,r=e.resolver,i=t.data;t.texture.setData(i),r.resolve()}}]),e}(),de=r(26277),fe=r(22753),_e=r(6394),pe=r(11186),ve=r(71353),ge=r(25866),me=r(92841),be=(0,_e.f)(-.5,-.5),ye=function(){function e(){(0,o.Z)(this,e),this._centerNdc=(0,ve.c)(),this._pxToNdc=(0,ve.c)(),this._worldDimensionsPx=(0,ve.c)(),this._mat3=(0,g.c)(),this._initialized=!1}return(0,u.Z)(e,[{key:"dispose",value:function(){this._program=(0,_.M2)(this._program),this._quad=(0,_.M2)(this._quad)}},{key:"render",value:function(e,t,r){var i=e.context,n=this._updateGeometry(e,r);if(null!=t){var s=t.r,a=t.g,o=t.b,u=t.a;i.setClearColor(u*s/255,u*a/255,u*o/255,u)}else i.setClearColor(0,0,0,0);if(i.setStencilFunction(J.wb.ALWAYS,0,255),i.setStencilWriteMask(255),!n)return i.setClearStencil(1),void i.clear(i.gl.STENCIL_BUFFER_BIT|i.gl.COLOR_BUFFER_BIT);i.setClearStencil(0),i.clear(i.gl.STENCIL_BUFFER_BIT|i.gl.COLOR_BUFFER_BIT),this._initialized||this._initialize(i),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setColorMask(!1,!1,!1,!1),i.setBlendingEnabled(!1),i.setStencilOp(J.xS.KEEP,J.xS.KEEP,J.xS.REPLACE),i.setStencilFunction(J.wb.ALWAYS,1,255),i.setStencilTestEnabled(!0),i.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind()}},{key:"_initialize",value:function(e){if(!this._initialized){var t=(0,ee.H)(e,me.H);t&&(this._program=t,this._quad=new ge.Z(e,[0,0,1,0,0,1,1,1]),this._initialized=!0)}}},{key:"_updateGeometry",value:function(e,t){var r=e.state,i=e.pixelRatio,n=r.size,s=r.rotation,a=Math.round(n[0]*i),o=Math.round(n[1]*i);if(!r.spatialReference.isWrappable)return!1;var u=(0,de.t)(s),l=Math.abs(Math.cos(u)),h=Math.abs(Math.sin(u)),c=Math.round(a*l+o*h),d=Math.round(r.worldScreenWidth);if(c<=d)return!1;var f=a*h+o*l,_=d*i,p=(t.left-t.right)*i/a,v=(t.bottom-t.top)*i/o;(0,pe.s)(this._worldDimensionsPx,_,f,1),(0,pe.s)(this._pxToNdc,2/a,-2/o,1),(0,pe.s)(this._centerNdc,p,v,1);var g=this._mat3;return(0,fe.k)(g,this._centerNdc),(0,fe.c)(g,g,this._pxToNdc),0!==s&&(0,fe.r)(g,g,u),(0,fe.c)(g,g,this._worldDimensionsPx),(0,fe.h)(g,g,be),!0}}]),e}(),we=r(93879),xe=function(e){(0,h.Z)(r,e);var t=(0,c.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).defines=[],e._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])},e}return(0,u.Z)(r,[{key:"dispose",value:function(){this._quad&&this._quad.dispose()}},{key:"bind",value:function(){}},{key:"unbind",value:function(){}},{key:"draw",value:function(e,t){if(null!==t&&void 0!==t&&t.size){var r=e.context,i=e.renderingOptions;this._quad||(this._quad=new ge.Z(r,[0,0,1,0,0,1,1,1]));var n=r.getBoundFramebufferObject(),s=r.getViewport(),a=s.x,o=s.y,u=s.width,l=s.height;t.bindTextures(r);var h=t.getBlock(he.S);if(null!=h){var c=h.getFBO(r),d=h.getFBO(r,1);r.setViewport(0,0,t.size,t.size),this._computeDelta(e,d,i.labelsAnimationTime),this._updateAnimationState(e,d,c),r.bindFramebuffer(n),r.setViewport(a,o,u,l)}}}},{key:"_computeDelta",value:function(e,t,r){var i=e.context,n=e.painter,s=e.displayLevel,a=n.materialManager.getProgram(this._desc,["delta"]);i.bindFramebuffer(t),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT),i.useProgram(a);var o=(0,f.Z)("featurelayer-animation-enabled")?r:1;a.setUniform1i("u_maskTexture",he.XO),a.setUniform1i("u_sourceTexture",he.jS),a.setUniform1f("u_timeDelta",e.deltaTime),a.setUniform1f("u_animationTime",o),a.setUniform1f("u_zoomLevel",Math.round(10*s)),this._quad.draw()}},{key:"_updateAnimationState",value:function(e,t,r){var i=e.context,n=e.painter.materialManager.getProgram(this._desc,["update"]);i.bindTexture(t.colorTexture,1),i.useProgram(n),n.setUniform1i("u_sourceTexture",1),i.bindFramebuffer(r),i.setClearColor(0,0,0,0),i.clear(i.gl.COLOR_BUFFER_BIT),this._quad.draw()}}]),r}(we.Q),Be=r(23174),Te=function(e){(0,h.Z)(r,e);var t=(0,c.Z)(r);function r(e){var i;return(0,o.Z)(this,r),(i=t.call(this)).name=i.constructor.name,i.defines=[e],i}return(0,u.Z)(r,[{key:"dispose",value:function(){}},{key:"bind",value:function(e){var t=e.context,r=e.painter;this._prev=t.getBoundFramebufferObject();var i=r.getFbos().effect0;t.bindFramebuffer(i),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(){}},{key:"draw",value:function(e,t){var r,i=e.context,n=e.painter,s=n.getPostProcessingEffects(t),o=i.getBoundFramebufferObject(),u=(0,a.Z)(s);try{for(u.s();!(r=u.n()).done;){var l=r.value,h=l.postProcessingEffect,c=l.effect;h.draw(e,o,c)}}catch(d){u.e(d)}finally{u.f()}i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),n.blitTexture(i,o.colorTexture,J.cw.NEAREST),i.setStencilTestEnabled(!0)}}]),r}(we.Q),Ee=r(17615),Fe=r(93985),Oe=r(61109),ke=function(){function e(){(0,o.Z)(this,e),this._width=void 0,this._height=void 0,this._resources=null}return(0,u.Z)(e,[{key:"dispose",value:function(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}},{key:"preBlur",value:function(e,t){e.bindTexture(t,he.Zt),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Ee.bM),e.bindVAO(this._resources.quadVAO),e.drawArrays(J.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"finalBlur",value:function(e,t){e.bindTexture(t,he.Zt),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Ee.dl),e.bindVAO(this._resources.quadVAO),e.drawArrays(J.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"renderHighlight",value:function(e,t,r){e.bindTexture(t,he.Zt),e.useProgram(this._resources.highlightProgram),r.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(J.zi.ONE,J.zi.ONE_MINUS_SRC_ALPHA),e.drawArrays(J.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}},{key:"_initialize",value:function(e,t,r){this._width=t,this._height=r;var i=$.f.createVertex(e,J.l1.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),n=new te.U(e,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[new Oe.G("a_position",2,J.g.BYTE,0,4),new Oe.G("a_texcoord",2,J.g.UNSIGNED_BYTE,2,4)]},{geometry:i}),s=(0,ee.H)(e,Fe.C),a=(0,ee.H)(e,Fe.y);e.useProgram(s),s.setUniform1i("u_texture",he.Zt),s.setUniform1i("u_shade",he.Sf),s.setUniform1f("u_sigma",Ee.pW),e.useProgram(a),a.setUniform1i("u_texture",he.Zt),a.setUniform1f("u_sigma",Ee.pW),this._resources={quadGeometry:i,quadVAO:n,highlightProgram:s,blurProgram:a}}},{key:"setup",value:function(e,t,r){this._resources?(this._width=t,this._height=r):this._initialize(e,t,r)}}]),e}(),Me=r(53634),Re=r(3479),Pe=r(52311);function Se(e,t,r){var i=new Pe.X(t,r);return i.wrapMode=J.e8.CLAMP_TO_EDGE,new Me.X(e,i,new Re.Y(J.Tg.STENCIL_INDEX8,t,r))}var Ce=function(){function e(){(0,o.Z)(this,e),this._width=void 0,this._height=void 0,this._resources=null}return(0,u.Z)(e,[{key:"dispose",value:function(){this._resources&&(this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}},{key:"_initialize",value:function(e,t,r){this._width=t,this._height=r;var i=Se(e,t,r),n=Se(e,t,r);this._resources={sharedBlur1Fbo:i,sharedBlur2Fbo:n}}},{key:"setup",value:function(e,t,r){!this._resources||this._width===t&&this._height===r||this.dispose(),this._resources||this._initialize(e,t,r)}},{key:"sharedBlur1Tex",get:function(){return this._resources.sharedBlur1Fbo.colorTexture}},{key:"sharedBlur1Fbo",get:function(){return this._resources.sharedBlur1Fbo}},{key:"sharedBlur2Tex",get:function(){return this._resources.sharedBlur2Fbo.colorTexture}},{key:"sharedBlur2Fbo",get:function(){return this._resources.sharedBlur2Fbo}}]),e}(),Ae=function(e){(0,h.Z)(r,e);var t=(0,c.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).defines=["highlight"],e._hlRenderer=new ke,e._width=void 0,e._height=void 0,e._boundFBO=null,e._hlSurfaces=new Ce,e._adjustedWidth=void 0,e._adjustedHeight=void 0,e._blitRenderer=new re,e}return(0,u.Z)(r,[{key:"dispose",value:function(){var e,t;null!==(e=this._hlSurfaces)&&void 0!==e&&e.dispose(),null!==(t=this._hlRenderer)&&void 0!==t&&t.dispose(),this._boundFBO=null}},{key:"bind",value:function(e){var t=e.context,r=e.painter,i=t.getViewport(),n=i.width,s=i.height,a=r.getFbos().effect0;this.setup(e,n,s),t.bindFramebuffer(a),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(){}},{key:"setup",value:function(e,t,r){var i=e.context;this._width=t,this._height=r;var n=t%4,s=r%4;t+=n<2?-n:4-n,r+=s<2?-s:4-s,this._adjustedWidth=t,this._adjustedHeight=r,this._boundFBO=i.getBoundFramebufferObject();var a=Math.round(1*t),o=Math.round(1*r);this._hlRenderer.setup(i,a,o),this._hlSurfaces.setup(i,a,o)}},{key:"draw",value:function(e){var t=e.context,r=e.highlightGradient;if(r){var i=t.getBoundFramebufferObject();t.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setStencilTestEnabled(!1),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(t,i.colorTexture,J.cw.NEAREST,1),t.setStencilTestEnabled(!1),t.setBlendingEnabled(!1),t.setColorMask(!1,!1,!1,!0),t.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(t,this._hlSurfaces.sharedBlur1Tex),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(t,this._hlSurfaces.sharedBlur2Tex),t.bindFramebuffer(this._boundFBO),t.setBlendingEnabled(!0),t.setColorMask(!0,!0,!0,!0),t.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(t,this._hlSurfaces.sharedBlur1Tex,r),this._boundFBO=null}}}]),r}(we.Q),Ze=function(e){(0,h.Z)(r,e);var t=(0,c.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).name=e.constructor.name,e.defines=["hittest"],e}return(0,u.Z)(r,[{key:"dispose",value:function(){null!=this._fbo&&this._fbo.dispose()}},{key:"createOptions",value:function(e,t){var r=e.pixelRatio,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:he.nY;if(!t.length)return null;var n=t.shift(),s=n.x,a=n.y;return this._outstanding=n,{type:"hittest",distance:i*r,position:[s,a]}}},{key:"bind",value:function(e){var t=e.context,r=e.attributeView;if(r.size){var i=r.getBlock(he.U8);if(null!=i){var n=i.getFBO(t);t.setViewport(0,0,r.size,r.size),t.bindFramebuffer(n),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT)}}}},{key:"unbind",value:function(e){}},{key:"draw",value:function(e){if(null!=this._outstanding){var t=this._outstanding;this._outstanding=null,this._resolve(e,t.resolvers)}}},{key:"_resolve",value:function(){var e=(0,s.Z)((0,i.Z)().mark((function e(t,r){var n,s,a,o,u,l,h,c,d,f;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.context,s=t.attributeView,null!=(a=s.getBlock(he.U8))){e.next=3;break}return e.abrupt("return",void r.forEach((function(e){return e.resolve([])})));case 3:return o=a.getFBO(n),u=new Uint8Array(o.width*o.height*4),e.prev=4,e.next=7,o.readPixelsAsync(0,0,o.width,o.height,J.VI.RGBA,J.Br.UNSIGNED_BYTE,u);case 7:e.next=12;break;case 9:return e.prev=9,e.t0=e.catch(4),e.abrupt("return",void r.forEach((function(e){return e.resolve([])})));case 12:for(l=[],h=0;h<u.length;h+=4)c=u[h],d=u[h+3],c&&l.push({id:h/4,directHits:d});l.sort((function(e,t){return t.directHits===e.directHits?t.id-e.id:t.directHits-e.directHits})),f=l.map((function(e){return e.id})),r.forEach((function(e){return e.resolve(f)}));case 17:case"end":return e.stop()}}),e,null,[[4,9]])})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(we.Q),Ue=function(e){(0,h.Z)(r,e);var t=(0,c.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.apply(this,arguments)).name=e.constructor.name,e.defines=["id"],e._lastSize=0,e._boundFBO=null,e}return(0,u.Z)(r,[{key:"dispose",value:function(){null!=this._fbo&&this._fbo.dispose()}},{key:"bind",value:function(e){var t=e.context,r=e.painter;this._boundFBO=t.getBoundFramebufferObject();var i=r.getFbos().effect0;t.bindFramebuffer(i),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(e){e.context.bindFramebuffer(this._boundFBO),this._boundFBO=null}},{key:"draw",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2*he.nY;this._resolve(e,t,r)}},{key:"_resolve",value:function(){var e=(0,s.Z)((0,i.Z)().mark((function e(t,r,n){var a,o,u,l,h,c,d,f,_=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=t.context,o=t.state,u=t.pixelRatio,l=a.getBoundFramebufferObject(),h=o.size[1]*u,c=Math.round(n*u),d=c/2,f=c/2,this._ensureBuffer(c),r.forEach(function(){var e=(0,s.Z)((0,i.Z)().mark((function e(t,n){var s,a,o,p,v,g,m,b,y,w;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=new Map,a=Math.floor(n.x*u-c/2),o=Math.floor(h-n.y*u-c/2),e.next=3,l.readPixelsAsync(a,o,c,c,J.VI.RGBA,J.Br.UNSIGNED_BYTE,_._buf);case 3:for(p=0;p<_._buf32.length;p++)4294967295!==(v=_._buf32[p])&&0!==v&&(g=p%c,m=c-Math.floor(p/c),b=(d-g)*(d-g)+(f-m)*(f-m),y=s.has(v)?s.get(v):4294967295,s.set(v,Math.min(b,y)));w=Array.from(s).sort((function(e,t){return e[1]-t[1]})).map((function(e){return e[0]})),t.resolve(w),r.delete(n);case 6:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}());case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"_ensureBuffer",value:function(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}]),r}(we.Q),ze=[1,0],Le=[0,1],Ie=[1,.8,.6,.4,.2],De=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],Ne=function(){function e(){(0,o.Z)(this,e),this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,u.Z)(e,[{key:"dispose",value:function(){if(this._quad=(0,_.M2)(this._quad),this._intensityFBO=(0,_.M2)(this._intensityFBO),this._compositeFBO=(0,_.M2)(this._compositeFBO),this._mipsFBOs){for(var e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}},{key:"draw",value:function(e,t,r){var i=t.width,n=t.height,s=e.context,a=e.painter.materialManager,o=s.gl,u=this._programDesc,l=r.strength,h=r.radius,c=r.threshold;this._quad||(this._quad=new ge.Z(s,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,i,n),s.setStencilTestEnabled(!1),s.setBlendingEnabled(!0),s.setBlendFunction(J.zi.ONE,J.zi.ONE_MINUS_SRC_ALPHA),s.setStencilWriteMask(0);var d=this._quad;d.bind(),s.bindFramebuffer(this._intensityFBO);var f=a.getProgram(u.luminosityHighPass);s.useProgram(f),s.bindTexture(t.colorTexture,0),f.setUniform1i("u_texture",0),f.setUniform3fv("u_defaultColor",[0,0,0]),f.setUniform1f("u_defaultOpacity",0),f.setUniform1f("u_luminosityThreshold",c),f.setUniform1f("u_smoothWidth",.01);var _=[Math.round(i/2),Math.round(n/2)];s.setViewport(0,0,_[0],_[1]),s.setClearColor(0,0,0,0),s.clear(o.COLOR_BUFFER_BIT),d.draw(),s.setBlendingEnabled(!1);for(var p=this._intensityFBO.colorTexture,v=0;v<this._nMips;v++){var g=a.getProgram(u.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[v]}]);s.useProgram(g),s.bindTexture(p,v+1),g.setUniform1i("u_colorTexture",v+1),g.setUniform2fv("u_texSize",_),g.setUniform2fv("u_direction",ze),s.setViewport(0,0,_[0],_[1]);var m=this._mipsFBOs[v];s.bindFramebuffer(m.horizontal),d.draw(),p=m.horizontal.colorTexture,s.bindFramebuffer(m.vertical),s.bindTexture(p,v+1),g.setUniform2fv("u_direction",Le),d.draw(),p=m.vertical.colorTexture,_[0]=Math.round(_[0]/2),_[1]=Math.round(_[1]/2)}s.setViewport(0,0,i,n);var b=a.getProgram(u.composite,[{name:"nummips",value:5}]);s.bindFramebuffer(this._compositeFBO),s.useProgram(b),b.setUniform1f("u_bloomStrength",l),b.setUniform1f("u_bloomRadius",h),b.setUniform1fv("u_bloomFactors",Ie),b.setUniform3fv("u_bloomTintColors",De),s.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),b.setUniform1i("u_blurTexture1",1),s.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),b.setUniform1i("u_blurTexture2",2),s.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),b.setUniform1i("u_blurTexture3",3),s.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),b.setUniform1i("u_blurTexture4",4),s.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),b.setUniform1i("u_blurTexture5",5),d.draw(),s.bindFramebuffer(t),s.setBlendingEnabled(!0);var y=a.getProgram(u.blit);s.useProgram(y),s.bindTexture(this._compositeFBO.colorTexture,6),y.setUniform1i("u_texture",6),s.setBlendFunction(J.zi.ONE,J.zi.ONE),d.draw(),d.unbind(),s.setBlendFunction(J.zi.ONE,J.zi.ONE_MINUS_SRC_ALPHA),s.setStencilTestEnabled(!0)}},{key:"_createOrResizeResources",value:function(e,t,r){var i=e.context;if(!this._compositeFBO||this._size[0]!==t||this._size[1]!==r){this._size[0]=t,this._size[1]=r;var n=[Math.round(t/2),Math.round(r/2)];if(this._compositeFBO)this._compositeFBO.resize(t,r);else{var s=new Pe.X(t,r);s.internalFormat=J.VI.RGBA,s.wrapMode=J.e8.CLAMP_TO_EDGE,this._compositeFBO=new Me.X(i,s)}if(this._intensityFBO)this._intensityFBO.resize(n[0],n[1]);else{var a=new Pe.X(n[0],n[1]);a.internalFormat=J.VI.RGBA,a.wrapMode=J.e8.CLAMP_TO_EDGE,this._intensityFBO=new Me.X(i,a)}for(var o=0;o<this._nMips;o++){if(this._mipsFBOs[o])this._mipsFBOs[o].horizontal.resize(n[0],n[1]),this._mipsFBOs[o].vertical.resize(n[0],n[1]);else{var u=new Pe.X(n[0],n[1]);u.internalFormat=J.VI.RGBA,u.wrapMode=J.e8.CLAMP_TO_EDGE,this._mipsFBOs[o]={horizontal:new Me.X(i,u),vertical:new Me.X(i,u)}}n[0]=Math.round(n[0]/2),n[1]=Math.round(n[1]/2)}}}}]),e}(),He=[1,0],Ve=[0,1],qe=function(){function e(){(0,o.Z)(this,e),this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,u.Z)(e,[{key:"dispose",value:function(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}},{key:"draw",value:function(e,t,r){var i=e.context,n=r.type,s=r.radius;if(0!==s){this._createOrResizeResources(e),this._quad||(this._quad=new ge.Z(i,[-1,-1,1,-1,-1,1,1,1]));var a=this._quad;a.bind(),"blur"===n?this._gaussianBlur(e,t,s):this._radialBlur(e,t),a.unbind()}}},{key:"_gaussianBlur",value:function(e,t,r){var i=e.context,n=e.state,s=e.painter,a=e.pixelRatio,o=n.size,u=s.materialManager,l=this._programDesc,h=this._quad,c=[Math.round(a*o[0]),Math.round(a*o[1])],d=this._blurFBO,f=u.getProgram(l.gaussianBlur,[{name:"radius",value:Math.ceil(r)}]);i.useProgram(f),i.setBlendingEnabled(!1),i.bindFramebuffer(d),i.bindTexture(t.colorTexture,4),f.setUniform1i("u_colorTexture",4),f.setUniform2fv("u_texSize",c),f.setUniform2fv("u_direction",He),f.setUniform1f("u_sigma",r),h.draw(),i.bindFramebuffer(t),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.bindTexture(null===d||void 0===d?void 0:d.colorTexture,5),f.setUniform1i("u_colorTexture",5),f.setUniform2fv("u_direction",Ve),h.draw(),i.setBlendingEnabled(!0),i.setBlendFunction(J.zi.ONE,J.zi.ONE_MINUS_SRC_ALPHA),i.setStencilTestEnabled(!0)}},{key:"_radialBlur",value:function(e,t){var r=e.context,i=e.painter.materialManager,n=this._programDesc,s=this._quad,a=this._blurFBO;r.bindFramebuffer(a);var o=i.getProgram(n.radialBlur);r.useProgram(o),r.setBlendingEnabled(!1),r.bindTexture(t.colorTexture,4),o.setUniform1i("u_colorTexture",4),s.draw(),r.bindFramebuffer(t),r.setStencilWriteMask(0),r.setStencilTestEnabled(!1),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setBlendingEnabled(!0);var u=i.getProgram(n.blit);r.useProgram(u),r.bindTexture(null===a||void 0===a?void 0:a.colorTexture,5),u.setUniform1i("u_texture",5),r.setBlendFunction(J.zi.ONE,J.zi.ONE_MINUS_SRC_ALPHA),s.draw()}},{key:"_createOrResizeResources",value:function(e){var t=e.context,r=e.state,i=e.pixelRatio,n=r.size,s=Math.round(i*n[0]),a=Math.round(i*n[1]);if(!this._blurFBO||this._size[0]!==s||this._size[1]!==a)if(this._size[0]=s,this._size[1]=a,this._blurFBO)this._blurFBO.resize(s,a);else{var o=new Pe.X(s,a);o.internalFormat=J.VI.RGBA,o.wrapMode=J.e8.CLAMP_TO_EDGE,this._blurFBO=new Me.X(t,o)}}}]),e}(),Ge=r(57808),We=function(){function e(){(0,o.Z)(this,e),this._layerFBOTexture=null,this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}return(0,u.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture=(0,_.M2)(this._layerFBOTexture)}},{key:"draw",value:function(e,t,r){var i=t.width,n=t.height;this._createOrResizeResources(e,i,n);var s=e.context,a=e.painter.materialManager,o=this._programDesc,u=this._quad,l=r.colorMatrix;u.bind();var h=this._layerFBOTexture;s.bindFramebuffer(t),t.copyToTexture(0,0,i,n,0,0,h),s.setBlendingEnabled(!1),s.setStencilTestEnabled(!1);var c=a.getProgram(o);s.useProgram(c),s.bindTexture(h,2),c.setUniformMatrix4fv("u_coefficients",l),c.setUniform1i("u_colorTexture",2),u.draw(),s.setBlendingEnabled(!0),s.setBlendFunction(J.zi.ONE,J.zi.ONE_MINUS_SRC_ALPHA),s.setStencilTestEnabled(!0),u.unbind()}},{key:"_createOrResizeResources",value:function(e,t,r){var i=e.context;if(!this._layerFBOTexture||this._size[0]!==t||this._size[1]!==r){if(this._size[0]=t,this._size[1]=r,this._layerFBOTexture)this._layerFBOTexture.resize(t,r);else{var n=new Pe.X;n.internalFormat=J.VI.RGBA,n.wrapMode=J.e8.CLAMP_TO_EDGE,n.width=t,n.height=r,this._layerFBOTexture=new Ge.x(i,n)}this._quad||(this._quad=new ge.Z(i,[-1,-1,1,-1,-1,1,1,1]))}}}]),e}(),je=r(17842),Ke=[1,0],Xe=[0,1],Ye=function(){function e(){(0,o.Z)(this,e),this._layerFBOTexture=null,this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._quad=null,this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}return(0,u.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture=(0,_.M2)(this._layerFBOTexture),this._horizontalBlurFBO=(0,_.M2)(this._horizontalBlurFBO),this._verticalBlurFBO=(0,_.M2)(this._verticalBlurFBO)}},{key:"draw",value:function(e,t,r){var i=e.context,n=e.state,s=e.painter.materialManager,a=this._programDesc,o=t.width,u=t.height,l=[Math.round(o),Math.round(u)],h=r.blurRadius,c=r.offsetX,d=r.offsetY,f=r.color,_=[(0,je.F2)(c),(0,je.F2)(d)];this._createOrResizeResources(e,o,u,l);var p=this._horizontalBlurFBO,v=this._verticalBlurFBO;i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1);var g=this._layerFBOTexture;t.copyToTexture(0,0,o,u,0,0,g),this._quad||(this._quad=new ge.Z(i,[-1,-1,1,-1,-1,1,1,1])),i.setViewport(0,0,l[0],l[1]);var m=this._quad;m.bind(),i.setBlendingEnabled(!1);var b=s.getProgram(a.blur,[{name:"radius",value:Math.ceil(h)}]);i.useProgram(b),i.bindFramebuffer(p),i.bindTexture(t.colorTexture,4),b.setUniform1i("u_colorTexture",4),b.setUniform2fv("u_texSize",l),b.setUniform2fv("u_direction",Ke),b.setUniform1f("u_sigma",h),m.draw(),i.bindFramebuffer(v),i.bindTexture(null===p||void 0===p?void 0:p.colorTexture,5),b.setUniform1i("u_colorTexture",5),b.setUniform2fv("u_direction",Xe),m.draw(),i.bindFramebuffer(t),i.setViewport(0,0,o,u);var y=s.getProgram(a.composite);i.useProgram(y),i.bindTexture(null===v||void 0===v?void 0:v.colorTexture,2),y.setUniform1i("u_blurTexture",2),i.bindTexture(g,3),y.setUniform1i("u_layerFBOTexture",3),y.setUniform4fv("u_shadowColor",[f[3]*(f[0]/255),f[3]*(f[1]/255),f[3]*(f[2]/255),f[3]]),y.setUniformMatrix3fv("u_displayViewMat3",n.displayMat3),y.setUniform2fv("u_shadowOffset",_),m.draw(),i.setBlendingEnabled(!0),i.setStencilTestEnabled(!0),i.setBlendFunction(J.zi.ONE,J.zi.ONE_MINUS_SRC_ALPHA),m.unbind()}},{key:"_createOrResizeResources",value:function(e,t,r,i){var n=e.context;if(!this._horizontalBlurFBO||this._size[0]!==t||this._size[1]!==r){if(this._size[0]=t,this._size[1]=r,this._horizontalBlurFBO)this._horizontalBlurFBO.resize(i[0],i[1]);else{var s=new Pe.X(i[0],i[1]);s.internalFormat=J.VI.RGBA,s.wrapMode=J.e8.CLAMP_TO_EDGE,this._horizontalBlurFBO=new Me.X(n,s)}if(this._verticalBlurFBO)this._verticalBlurFBO.resize(i[0],i[1]);else{var a=new Pe.X(i[0],i[1]);a.internalFormat=J.VI.RGBA,a.wrapMode=J.e8.CLAMP_TO_EDGE,this._verticalBlurFBO=new Me.X(n,a)}if(this._layerFBOTexture)this._layerFBOTexture.resize(t,r);else{var o=new Pe.X;o.internalFormat=J.VI.RGBA,o.wrapMode=J.e8.CLAMP_TO_EDGE,o.width=t,o.height=r,this._layerFBOTexture=new Ge.x(n,o)}}}}]),e}(),Qe=function(){function e(){(0,o.Z)(this,e),this._size=[0,0],this._layerFBOTexture=null}return(0,u.Z)(e,[{key:"dispose",value:function(){this._layerFBOTexture=(0,_.M2)(this._layerFBOTexture)}},{key:"draw",value:function(e,t,r){var i=t.width,n=t.height;this._createOrResizeResources(e,i,n);var s=e.context,a=e.painter,o=r.amount,u=s.gl,l=this._layerFBOTexture;s.bindFramebuffer(t),t.copyToTexture(0,0,i,n,0,0,l),s.setBlendingEnabled(!0),s.setStencilTestEnabled(!1),s.setDepthTestEnabled(!1),s.setClearColor(0,0,0,0),s.clear(u.COLOR_BUFFER_BIT),a.blitTexture(s,l,J.cw.NEAREST,o)}},{key:"_createOrResizeResources",value:function(e,t,r){var i=e.context;if(!this._layerFBOTexture||this._size[0]!==t||this._size[1]!==r)if(this._size[0]=t,this._size[1]=r,this._layerFBOTexture)this._layerFBOTexture.resize(t,r);else{var n=new Pe.X;n.internalFormat=J.VI.RGBA,n.wrapMode=J.e8.CLAMP_TO_EDGE,n.samplingMode=J.cw.NEAREST,n.width=t,n.height=r,this._layerFBOTexture=new Ge.x(i,n)}}}]),e}();function $e(e){switch(e){case"bloom":case"blur":case"opacity":case"drop-shadow":return e;default:return"colorize"}}var Je={colorize:function(){return new We},blur:function(){return new qe},bloom:function(){return new Ne},opacity:function(){return new Qe},"drop-shadow":function(){return new Ye}},et=function(){function e(){(0,o.Z)(this,e),this._effectMap=new Map}return(0,u.Z)(e,[{key:"dispose",value:function(){this._effectMap.forEach((function(e){return e.dispose()})),this._effectMap.clear()}},{key:"getPostProcessingEffects",value:function(e){if(!e||0===e.length)return[];var t,r=[],i=(0,a.Z)(e);try{for(i.s();!(t=i.n()).done;){var n=t.value,s=$e(n.type),o=this._effectMap.get(s);o||(o=Je[s](),this._effectMap.set(s,o)),r.push({postProcessingEffect:o,effect:n})}}catch(u){i.e(u)}finally{i.f()}return r}}]),e}(),tt=r(63780),rt=function(){function e(t,r){var i;(0,o.Z)(this,e),this.brushes=t,this.name=r.name,this.drawPhase=r.drawPhase||R.jx.MAP,this._targetFn=r.target,this.effects=r.effects||[],this.enableDefaultDraw=null!==(i=r.enableDefaultDraw)&&void 0!==i?i:function(){return!0},this.forceDrawByDisplayOrder=!!r.forceDrawByDisplayOrder}return(0,u.Z)(e,[{key:"render",value:function(e){var t=e.context,r=e.profiler,i=this._targetFn(),n=this.drawPhase&e.drawPhase;if(r.recordPassStart(this.name),n){this.enableDefaultDraw()&&this._doRender(e,i),r.recordPassEnd();var s,o=(0,a.Z)(this.effects);try{for(o.s();!(s=o.n()).done;){var u,l=s.value;if(l.enable()){var h=l.apply,c=null===(u=l.args)||void 0===u?void 0:u.call(l),d=t.getViewport(),f=t.getBoundFramebufferObject(),_=e.passOptions;this._bindEffect(e,h,c),this._doRender(e,i,h.defines),this._drawAndUnbindEffect(e,h,d,f,_,c)}}}catch(p){o.e(p)}finally{o.f()}}}},{key:"_doRender",value:function(e,t,r){if(null!=t){var i=e.profiler,n=e.context;if(this.forceDrawByDisplayOrder){var s,o=(0,a.Z)(this.brushes);try{for(o.s();!(s=o.n()).done;){var u=s.value;if(i.recordBrushStart(u.name),null!=u.brushEffect){var l=n.getViewport(),h=n.getBoundFramebufferObject(),c=e.passOptions;this._bindEffect(e,u.brushEffect),this._drawWithBrush(u,e,t,r),this._drawAndUnbindEffect(e,u.brushEffect,l,h,c)}else this._drawWithBrush(u,e,t,r);i.recordBrushEnd()}}catch(T){o.e(T)}finally{o.f()}var d=t,f=e;f.attributeView.bindTextures(e.context);var _,p=(0,a.Z)(d);try{var v=function(){var e=_.value;if(!e.visible)return 1;e.commit(f),f.context.setStencilFunction(J.wb.EQUAL,e.stencilRef,255);var t=e.getGeometry(R.LW.MARKER),i=e.getGeometry(R.LW.TEXT);if(null!==t&&void 0!==t&&t.records&&null!==i&&void 0!==i&&i.records){for(var n=new Map,s=t.records.getCursor();s.next();)n.set(s.id,[s.getDrawInfo(t,R.LW.MARKER)]);for(var o=i.records.getCursor();o.next();){var u=n.get(o.id),l=o.getDrawInfo(i,R.LW.TEXT);u?u.push(l):n.set(o.id,[l])}var h,c=Array.from(n.entries()).sort((function(e,t){var r=(0,y.Z)(e,2),i=r[0],n=(r[1],(0,y.Z)(t,2)),s=n[0];n[1];return s-i})),d=(0,a.Z)(c);try{for(d.s();!(h=d.n()).done;){var p,v=(0,y.Z)(h.value,2),g=(v[0],v[1]),m=(0,a.Z)(g);try{for(m.s();!(p=m.n()).done;){var b=p.value,w=f.painter.getBrush(b.geometryType,R.mD.DEFAULT);w.prepareState(f,r),w.drawGeometry(f,e,b,r)}}catch(T){m.e(T)}finally{m.f()}}}catch(T){d.e(T)}finally{d.f()}}else if(t){var x=f.painter.getBrush(R.LW.MARKER,R.mD.DEFAULT);x.prepareState(f,r),t.forEachCommand((function(t){x.drawGeometry(f,e,t,r)}))}else if(i){var B=f.painter.getBrush(R.LW.TEXT,R.mD.DEFAULT);B.prepareState(f,r),i.forEachCommand((function(t){B.drawGeometry(f,e,t,r)}))}};for(p.s();!(_=p.n()).done;)v()}catch(T){p.e(T)}finally{p.f()}}else{var g,m=(0,a.Z)(this.brushes);try{for(m.s();!(g=m.n()).done;){var b=g.value;if(i.recordBrushStart(b.name),null!=b.brushEffect){var w=n.getViewport(),x=n.getBoundFramebufferObject(),B=e.passOptions;this._bindEffect(e,b.brushEffect),this._drawWithBrush(b,e,t,r),this._drawAndUnbindEffect(e,b.brushEffect,w,x,B)}else this._drawWithBrush(b,e,t,r);i.recordBrushEnd()}}catch(T){m.e(T)}finally{m.f()}}}}},{key:"_drawWithBrush",value:function(e,t,r,i){(0,tt.zG)(r)?(e.prepareState(t,i),e.drawMany(t,r,i)):r.visible&&(e.prepareState(t,i),e.draw(t,r,i))}},{key:"_bindEffect",value:function(e,t,r){e.profiler.recordPassStart(this.name+"."+t.name),t.bind(e,r);var i=t.createOptions(e,r);e.passOptions=i}},{key:"_drawAndUnbindEffect",value:function(e,t,r,i,n,s){var a=e.profiler,o=e.context;e.passOptions=n,a.recordBrushStart(t.name),t.draw(e,s),t.unbind(e,s),o.bindFramebuffer(i);var u=r.x,l=r.y,h=r.width,c=r.height;o.setViewport(u,l,h,c),a.recordBrushEnd(),a.recordPassEnd()}}]),e}(),it=r(15880);var nt=function(){function e(t,r,i){(0,o.Z)(this,e),this.context=t,this._blitRenderer=new re,this._worldExtentRenderer=new ye,this._brushCache=new Map,this._lastWidth=null,this._lastHeight=null,this._vtlMaterialManager=new X,this._blendEffect=new Be.k,this._stencilBuf=null,this._prevBeforeLayerFBOStack=[],this._fboPool=[],this.effects={highlight:new Ae,hittest:new Ze,hittestVTL:new Ue,integrate:new xe,insideEffect:new Te("inside"),outsideEffect:new Te("outside")},this.materialManager=new oe(t),this.textureManager=new ue.Z(r,i,t.type===O.zO.WEBGL2),this.textureUploadManager=new ce(t,r),this._effectsManager=new et}return(0,u.Z)(e,[{key:"dispose",value:function(){var e;if(this.materialManager.dispose(),this.textureManager.dispose(),this.textureUploadManager.destroy(),this._blitRenderer=(0,_.M2)(this._blitRenderer),this._worldExtentRenderer=(0,_.M2)(this._worldExtentRenderer),this._brushCache&&(this._brushCache.forEach((function(e){return e.dispose()})),this._brushCache.clear(),this._brushCache=null),this._fbos)for(e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();var t,r,i=(0,a.Z)(this._fboPool);try{for(i.s();!(t=i.n()).done;){t.value.dispose()}}catch(n){i.e(n)}finally{i.f()}if(this._fboPool.length=0,this.effects)for(r in this.effects)this.effects[r]&&this.effects[r].dispose();this._effectsManager.dispose(),this._blendEffect.dispose(this.context),this._vtlMaterialManager=(0,_.M2)(this._vtlMaterialManager)}},{key:"blitRenderer",get:function(){return this._blitRenderer}},{key:"vectorTilesMaterialManager",get:function(){return this._vtlMaterialManager}},{key:"getFbos",value:function(){if(!this._fbos)throw new Error("InternalError: Painter FBOs not initialized");return this._fbos}},{key:"acquireFbo",value:function(e,t){var r;if(this._fboPool.length>0)r=this._fboPool.pop();else{var i=new Pe.X(e,t);i.samplingMode=J.cw.NEAREST,i.wrapMode=J.e8.CLAMP_TO_EDGE,r=new Me.X(this.context,i,this._stencilBuf)}return r.width===e&&r.height===t||r.resize(e,t),r}},{key:"releaseFbo",value:function(e){this._fboPool.push(e)}},{key:"getSharedStencilBuffer",value:function(){return this._stencilBuf}},{key:"beforeRenderPhases",value:function(e,t,r){var i=e.context;this._worldExtentRenderer.render(e,t,r);var n=i.getViewport(),s=n.width,a=n.height;if(this.updateFBOs(s,a),this._prevFBO=i.getBoundFramebufferObject(),i.bindFramebuffer(this.getFbos().output),i.setColorMask(!0,!0,!0,!0),null!=t){var o=t.r,u=t.g,l=t.b,h=t.a;i.setClearColor(h*o/255,h*u/255,h*l/255,h)}else i.setClearColor(0,0,0,0);i.setDepthWriteEnabled(!0),i.setClearDepth(1),i.clear(i.gl.COLOR_BUFFER_BIT|i.gl.DEPTH_BUFFER_BIT),i.setDepthWriteEnabled(!1)}},{key:"afterRenderPhases",value:function(e){var t=e.context;t.bindFramebuffer(this._prevFBO),t.setStencilFunction(J.wb.EQUAL,1,255),t.setStencilTestEnabled(!0),t.setDepthTestEnabled(!1),this.blitTexture(t,this.getFbos().output.colorTexture,J.cw.NEAREST)}},{key:"beforeRenderLayer",value:function(e,t,r){var i=e.context,n=e.blendMode,s=e.effects,a=e.drawPhase;if(e.requireFBO||st(a,n,s,r)){var o=i.getBoundFramebufferObject();this._prevBeforeLayerFBOStack.push(o);var u=i.getViewport(),l=u.width,h=u.height,c=this.acquireFbo(l,h);i.bindFramebuffer(c),i.setColorMask(!0,!0,!0,!0),i.setClearColor(0,0,0,0),i.setDepthWriteEnabled(!0),i.setClearDepth(1),i.clear(i.gl.COLOR_BUFFER_BIT|i.gl.DEPTH_BUFFER_BIT),i.setDepthWriteEnabled(!1)}i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setStencilTestEnabled(!0),i.setClearStencil(t),i.setStencilWriteMask(255),i.clear(i.gl.STENCIL_BUFFER_BIT)}},{key:"afterRenderLayer",value:function(e,t){var r=e.context,i=e.blendMode,n=e.effects,s=e.requireFBO,a=e.drawPhase;if(s||st(a,i,n,t)){var o=r.getBoundFramebufferObject();null!=n&&n.length>0&&a===R.jx.MAP&&this._applyEffects(e,n,o),r.bindFramebuffer(this._prevBeforeLayerFBOStack.pop()),r.setStencilTestEnabled(!1),r.setStencilWriteMask(0),r.setBlendingEnabled(!0),r.setBlendFunctionSeparate(J.zi.ONE,J.zi.ONE_MINUS_SRC_ALPHA,J.zi.ONE,J.zi.ONE_MINUS_SRC_ALPHA),r.setColorMask(!0,!0,!0,!0);var u=null==i||a===R.jx.HIGHLIGHT?"normal":i;this._blendEffect.draw(e,o.colorTexture,J.cw.NEAREST,u,t),this.releaseFbo(o)}}},{key:"getBrush",value:function(e,t){var r=function(e,t){switch(e){case R.LW.LINE:return P.U.line;case R.LW.TEXT:return P.U.text;case R.LW.LABEL:return P.U.label;case R.LW.FILL:return t===R.mD.DOT_DENSITY?P.U.dotDensity:P.U.fill;case R.LW.MARKER:switch(t){case R.mD.HEATMAP:return P.U.heatmap;case R.mD.PIE_CHART:return P.U.pieChart;default:return P.U.marker}}}(e,t),i=this._brushCache.get(r);return void 0===i&&(i=new r,this._brushCache.set(r,i)),i}},{key:"renderObject",value:function(e,t,r,i){var n=P.U[r];if(n){var s=this._brushCache.get(n);void 0===s&&(s=new n,this._brushCache.set(n,s)),s.prepareState(e,i),s.draw(e,t,i)}}},{key:"renderObjects",value:function(e,t,r,i){var n=P.U[r];if(n){var s=this._brushCache.get(n);void 0===s&&(s=new n,this._brushCache.set(n,s)),s.drawMany(e,t,i)}}},{key:"registerRenderPass",value:function(e){var t=this,r=e.brushes.map((function(e){return t._brushCache.has(e)||t._brushCache.set(e,new e),t._brushCache.get(e)}));return new rt(r,e)}},{key:"blitTexture",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(J.zi.ONE,J.zi.ONE_MINUS_SRC_ALPHA,J.zi.ONE,J.zi.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,r,i)}},{key:"getPostProcessingEffects",value:function(e){return this._effectsManager.getPostProcessingEffects(e)}},{key:"updateFBOs",value:function(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){var r;for(r in this._fbos)this._fbos[r].resize(e,t);return}var i=new Pe.X(e,t);i.samplingMode=J.cw.NEAREST,i.wrapMode=J.e8.CLAMP_TO_EDGE;var n=new Re.Y(J.Tg.DEPTH_STENCIL,e,t);this._stencilBuf=new it.r(this.context,n),this._fbos={output:new Me.X(this.context,i,this._stencilBuf),effect0:new Me.X(this.context,i,this._stencilBuf)}}}},{key:"_applyEffects",value:function(e,t,r){var i,n=e.context,s=this._effectsManager.getPostProcessingEffects(t),o=(0,a.Z)(s);try{for(o.s();!(i=o.n()).done;){var u=i.value,l=u.postProcessingEffect,h=u.effect;n.bindFramebuffer(r),l.draw(e,r,h)}}catch(c){o.e(c)}finally{o.f()}}}]),e}();function st(e,t,r,i){return e!==R.jx.LABEL_ALPHA&&e!==R.jx.LABEL&&e!==R.jx.HIGHLIGHT&&(1!==i||null!=t&&"normal"!==t||null!=r&&r.length>0)}var at=r(13163),ot=r(84786),ut=r(7796),lt=r(20396),ht=r(30308),ct=r(51e3),dt=function(e){(0,h.Z)(r,e);var t=(0,c.Z)(r);function r(e,i){var n,s;(0,o.Z)(this,r),(s=t.call(this))._trash=new Set,s._renderRemainingTime=0,s._lastFrameRenderTime=0,s._renderRequested=(0,v.t)(!1),s.stage=(0,l.Z)(s),s._stationary=!0,s._canvas=new k(e),s.context=new lt.x(s._canvas.gl,null!==(n=i.contextOptions)&&void 0!==n?n:{}),s.resourceManager=new m.Z,s.painter=new nt(s.context,(0,l.Z)(s),s.resourceManager),(0,f.Z)("esri-2d-profiler")&&(s._debugOutput=document.createElement("div"),s._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(s._debugOutput));return s._renderParameters={drawPhase:0,state:s.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:s.context,painter:s.painter,timeline:i.timeline||new ot.T,renderingOptions:i.renderingOptions,requestRender:function(){return s.requestRender()},allowDelayedRender:!1,requireFBO:!1,profiler:new at.Q(s.context,s._debugOutput),dataUploadCounter:0,get highlightGradient(){return s._highlightGradient},backgroundColor:i.backgroundColor},s._taskHandle=(0,p.A)({render:function(e){return s.renderFrame(e)}}),s._taskHandle.pause(),s._lostWebGLContextHandle=s._canvas.events.on("webgl-context-lost",(function(e){return s.emit("webgl-error",{error:new d.Z("webgl-context-lost",e.statusMessage)})})),s._bufferPool=new M.Q,s}return(0,u.Z)(r,[{key:"destroy",value:function(){var e;this.removeAllChildren(),this._emptyTrash(),this._taskHandle=(0,_.hw)(this._taskHandle),this._lostWebGLContextHandle=(0,_.hw)(this._lostWebGLContextHandle),this._canvas.destroy(),null!==(e=this._debugOutput)&&void 0!==e&&null!==(e=e.parentNode)&&void 0!==e&&e.removeChild(this._debugOutput),this._bufferPool.destroy(),this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}},{key:"backgroundColor",get:function(){return this._renderParameters.backgroundColor},set:function(e){this._renderParameters.backgroundColor=e,this.requestRender()}},{key:"bufferPool",get:function(){return this._bufferPool}},{key:"renderingOptions",get:function(){return this._renderingOptions},set:function(e){this._renderingOptions=e,this.requestRender()}},{key:"renderRequested",get:function(){return this._renderRequested.value}},{key:"state",get:function(){return this._state},set:function(e){this._state=e,this.requestRender()}},{key:"stationary",get:function(){return this._stationary},set:function(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}},{key:"trashDisplayObject",value:function(e){this._trash.add(e),this.requestRender()}},{key:"untrashDisplayObject",value:function(e){return this._trash.delete(e)}},{key:"requestRender",value:function(){this._renderRemainingTime=2e3,this.renderRequested||(this._renderRequested.value=!0,this._taskHandle.resume())}},{key:"renderFrame",value:function(e){var t=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=t,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this._renderRequested.value=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash()}},{key:"_createTransforms",value:function(){return{dvs:(0,g.c)()}}},{key:"renderChildren",value:function(e){var t,r=this,i=(0,a.Z)(this.children);try{for(i.s();!(t=i.n()).done;){t.value.beforeRender(e)}}catch(o){i.e(o)}finally{i.f()}this._canvas.render(e,(function(){return r._renderChildren(r.children,e)}));var n,s=(0,a.Z)(this.children);try{for(s.s();!(n=s.n()).done;){n.value.afterRender(e)}}catch(o){s.e(o)}finally{s.f()}}},{key:"_renderChildren",value:function(e,t){var r=this.context;this.painter.textureUploadManager.upload(),r.resetInfo(),t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,this.painter.beforeRenderPhases(t,t.backgroundColor,this.state.padding),t.drawPhase=R.jx.MAP;var i,n=(0,a.Z)(e);try{for(n.s();!(i=n.n()).done;){i.value.processRender(t)}}catch(d){n.e(d)}finally{n.f()}if(this.children.some((function(e){return e.hasHighlight}))){t.drawPhase=R.jx.HIGHLIGHT;var s,o=(0,a.Z)(e);try{for(o.s();!(s=o.n()).done;){s.value.processRender(t)}}catch(d){o.e(d)}finally{o.f()}}if(this.children.some((function(e){return e.hasLabels}))){t.drawPhase=R.jx.LABEL;var u,l=(0,a.Z)(e);try{for(l.s();!(u=l.n()).done;){u.value.processRender(t)}}catch(d){l.e(d)}finally{l.f()}}if((0,f.Z)("esri-tiles-debug")){t.drawPhase=R.jx.DEBUG;var h,c=(0,a.Z)(e);try{for(c.s();!(h=c.n()).done;){h.value.processRender(t)}}catch(d){c.e(d)}finally{c.f()}}this.painter.afterRenderPhases(t),t.profiler.recordEnd("drawLayers"),r.logInfo()}},{key:"doRender",value:function(e){var t=this.context,r=e.state,i=e.pixelRatio;this._canvas.resize(e),t.setViewport(0,0,i*r.size[0],i*r.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),this.renderChildren(e)}},{key:"takeScreenshot",value:function(){var e=(0,s.Z)((0,i.Z)().mark((function e(t,r,s,a){var o,u,l,h,c,d,f,_,p,v,g,m,b,y,w;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=Math.round(this.state.size[0]*t.resolutionScale),u=Math.round(this.state.size[1]*t.resolutionScale),l=t.resolutionScale,h=this.context,c=this._state.clone(),null!=a&&(d=c.viewpoint,c.viewpoint.rotation=a,c.viewpoint=d),f=(0,n.Z)((0,n.Z)({},this._renderParameters),{},{drawPhase:null,globalOpacity:1,stationary:!0,state:c,pixelRatio:l,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1,backgroundColor:s}),_=(0,ht.Z)(h.gl),(p=new Pe.X(o,u)).wrapMode=J.e8.CLAMP_TO_EDGE,p.internalFormat=_?J.lP.RGBA8:J.VI.RGBA,p.isImmutable=_,v=new Me.X(h,p,new Re.Y(J.Tg.DEPTH_STENCIL,o,u)),g=h.getBoundFramebufferObject(),m=h.getViewport(),h.bindFramebuffer(v),h.setViewport(0,0,o,u),this._renderChildren(null!==r&&void 0!==r?r:this.children,f),b=this._readbackScreenshot(v,(0,n.Z)((0,n.Z)({},t.cropArea),{},{y:u-(t.cropArea.y+t.cropArea.height)})),h.bindFramebuffer(g),h.setViewport(m.x,m.y,m.width,m.height),this.requestRender(),e.next=10,b;case 10:return y=e.sent,e.abrupt("return",(1===t.outputScale?w=y:(w=new ImageData(Math.round(y.width*t.outputScale),Math.round(y.height*t.outputScale)),(0,ut.TT)(y,w,!0)),v.dispose(),w));case 12:case"end":return e.stop()}}),e,this)})));return function(t,r,i,n){return e.apply(this,arguments)}}()},{key:"_readbackScreenshot",value:function(){var e=(0,s.Z)((0,i.Z)().mark((function e(t,r){var n;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,ct.r7)(r.width,r.height,document.createElement("canvas")),e.next=3,t.readPixelsAsync(r.x,r.y,r.width,r.height,J.VI.RGBA,J.Br.UNSIGNED_BYTE,new Uint8Array(n.data.buffer));case 3:return e.abrupt("return",n);case 4:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_emptyTrash",value:function(){for(;this._trash.size>0;){var e=Array.from(this._trash);this._trash.clear();for(var t=0,r=e;t<r.length;t++){r[t].processDetach()}}}}]),r}(b.W),ft=r(70812),_t=r(77318),pt=r(75391),vt=r(91908),gt=r(76200),mt=r(14921),bt=r(100),yt=r(94172),wt=r(35995),xt=r(87422),Bt=r(69610),Tt=r(38330);function Et(e){return Ft.apply(this,arguments)}function Ft(){return Ft=(0,s.Z)((0,i.Z)().mark((function e(t){var n,s,a,o,u;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.e(3581).then(r.bind(r,83581)),s=r.e(8938).then(r.bind(r,78938)),e.t0=Tt.t,e.next=5,n;case 5:return e.t1=e.sent.default,e.t2={signal:t},a=(0,e.t0)(e.t1,e.t2),e.t3=Tt.t,e.next=11,s;case 11:return e.t4=e.sent.default,e.t5={signal:t},o=(0,e.t3)(e.t4,e.t5),e.next=16,a;case 16:return e.t6=e.sent,e.next=19,o;case 19:return e.t7=e.sent,u={mask:e.t6,overlay:e.t7},e.abrupt("return",((0,le.k_)(t),u));case 22:case"end":return e.stop()}}),e)}))),Ft.apply(this,arguments)}var Ot=function(e){(0,h.Z)(r,e);var t=(0,c.Z)(r);function r(){var e;return(0,o.Z)(this,r),(e=t.call(this))._handles=new bt.Z,e._resourcePixelRatio=1,e.visible=!1,e}return(0,u.Z)(r,[{key:"destroy",value:function(){this._handles=(0,_.SC)(this._handles),this._disposeRenderResources(),this._resourcesTask=(0,_.IM)(this._resourcesTask)}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){this._backgroundColor=e,this.requestRender()}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){var t=this;this._magnifier=e,this._handles.removeAll(),this._handles.add([(0,yt.YP)((function(){return e.version}),(function(){t.visible=e.visible&&null!=e.position&&e.size>0,t.requestRender()}),yt.nn),(0,yt.YP)((function(){return[e.maskUrl,e.overlayUrl]}),(function(){return t._reloadResources()})),(0,yt.YP)((function(){return e.size}),(function(){t._disposeRenderResources(),t.requestRender()}))])}},{key:"_createTransforms",value:function(){return{dvs:(0,g.c)()}}},{key:"doRender",value:function(e){var t=e.context;if(this._resourcesTask){if(e.drawPhase===R.jx.MAP&&this._canRender()){this._updateResources(e);var r=this._magnifier;if(null!=r.position){var i=e.pixelRatio,n=r.size*i,s=1/r.factor,a=Math.ceil(s*n);this._readbackTexture.resize(a,a);var o=e.state.size,u=i*o[0],l=i*o[1],h=.5*a,c=.5*a,d=(0,T.uZ)(i*r.position.x,h,u-h-1),f=(0,T.uZ)(l-i*r.position.y,c,l-c-1);t.setBlendingEnabled(!0);var _=d-h,p=f-c,v=this._readbackTexture;t.bindTexture(v,0),t.gl.copyTexImage2D(v.descriptor.target,0,v.descriptor.pixelFormat,_,p,a,a,0);var g=this.backgroundColor,m=g?[g.a*g.r/255,g.a*g.g/255,g.a*g.b/255,g.a]:[1,1,1,1],b=(d+r.offset.x*i)/u*2-1,y=(f-r.offset.y*i)/l*2-1,w=n/u*2,x=n/l*2,B=this._program;t.bindVAO(this._vertexArrayObject),t.bindTexture(this._overlayTexture,6),t.bindTexture(this._maskTexture,7),t.useProgram(B),B.setUniform4fv("u_background",m),B.setUniform1i("u_readbackTexture",0),B.setUniform1i("u_overlayTexture",6),B.setUniform1i("u_maskTexture",7),B.setUniform4f("u_drawPos",b,y,w,x),B.setUniform1i("u_maskEnabled",r.maskEnabled?1:0),B.setUniform1i("u_overlayEnabled",r.overlayEnabled?1:0),t.setStencilTestEnabled(!1),t.setColorMask(!0,!0,!0,!0),t.drawArrays(J.MX.TRIANGLE_STRIP,0,4),t.bindVAO()}}}else this._reloadResources()}},{key:"_canRender",value:function(){return this.mask&&this.overlay&&null!=this._magnifier}},{key:"_reloadResources",value:function(){var e=this;this._resourcesTask&&this._resourcesTask.abort();var t=null!=this._magnifier?this._magnifier.maskUrl:null,r=null!=this._magnifier?this._magnifier.overlayUrl:null;this._resourcesTask=(0,mt.vr)(function(){var n=(0,s.Z)((0,i.Z)().mark((function n(s){var a,o,u,l,h,c,d;return(0,i.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return a=null==t||null==r?Et(s):null,o=null!=t?(0,gt.Z)(t,{responseType:"image",signal:s}).then((function(e){return e.data})):a.then((function(e){return e.mask})),u=null!=r?(0,gt.Z)(r,{responseType:"image",signal:s}).then((function(e){return e.data})):a.then((function(e){return e.overlay})),i.next=5,Promise.all([o,u]);case 5:l=i.sent,h=(0,y.Z)(l,2),c=h[0],d=h[1],e.mask=c,e.overlay=d,e._disposeRenderResources(),e.requestRender();case 10:case"end":return i.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}())}},{key:"_disposeRenderResources",value:function(){this._readbackTexture=(0,_.M2)(this._readbackTexture),this._overlayTexture=(0,_.M2)(this._overlayTexture),this._maskTexture=(0,_.M2)(this._maskTexture),this._vertexArrayObject=(0,_.M2)(this._vertexArrayObject),this._program=(0,_.M2)(this._program)}},{key:"_updateResources",value:function(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),!this._readbackTexture){var t=e.context;this._resourcePixelRatio=e.pixelRatio;var r=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=(0,Bt.F)(t);var i=new Uint16Array([0,1,0,0,1,1,1,0]),n=Bt.c.attributes;this._vertexArrayObject=new te.U(t,n,Y.cD,{geometry:$.f.createVertex(t,J.l1.STATIC_DRAW,i)}),this.overlay.width=r,this.overlay.height=r;var s=new Pe.X;s.internalFormat=J.VI.RGBA,s.wrapMode=J.e8.CLAMP_TO_EDGE,s.samplingMode=J.cw.NEAREST,s.flipped=!0,s.preMultiplyAlpha=!(0,wt.zd)(this.overlay.src)||!e.context.driverTest.svgPremultipliesAlpha.result,this._overlayTexture=new Ge.x(t,s,this.overlay),this.mask.width=r,this.mask.height=r,s.pixelFormat=s.internalFormat=J.VI.ALPHA,this._maskTexture=new Ge.x(t,s,this.mask);var a=1/this._magnifier.factor;s.pixelFormat=s.internalFormat=J.VI.RGBA,s.width=s.height=Math.ceil(a*r),s.samplingMode=J.cw.LINEAR,s.flipped=!1,this._readbackTexture=new Ge.x(t,s)}}}]),r}(xt.s)}}]);
//# sourceMappingURL=8304.3893298a.chunk.js.map